<!DOCTYPE html>













<html class="theme-next gemini" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">














  <meta name="yandex-verification" content="3ac9ae36ddebb425">













<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"onmobile":true},
    back2top: true,
    back2top_sidebar: true,
    fancybox: false,
    fastclick: false,
    lazyload: true,
    tabs: true,
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="keywords" content="coding,software">
<meta property="og:type" content="website">
<meta property="og:title" content="Try Again">
<meta property="og:url" content="https://theyoung.github.io/page/4/index.html">
<meta property="og:site_name" content="Try Again">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Try Again">






  <link rel="canonical" href="https://theyoung.github.io/page/4/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Try Again – anything</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  

  <div class="container 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Try Again</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">anything</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-news">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-bullhorn"></i> <br>News</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">21</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://theyoung.github.io/redis-config-explain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="whoami">
      <meta itemprop="description" content="my note">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Try Again">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/redis-config-explain/" class="post-title-link" itemprop="url">Redis Config Explain</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-05 18:50:40" itemprop="dateCreated datePublished" datetime="2019-06-05T18:50:40Z">2019-06-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-04 02:25:46" itemprop="dateModified" datetime="2019-07-04T02:25:46Z">2019-07-04</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/redis-config-explain/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="redis-config-explain/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Redis-Config-Section"><a href="#Redis-Config-Section" class="headerlink" title="Redis Config Section"></a>Redis Config Section</h4><p><code>redis-cli</code>를 통해서 redis console에 진입 할 경우 <code>info</code>명령어를 통해서 다음 section에 대한 정보를 획득 할 수있다.</p>
<p><code>info &lt;&lt;아래 명령어&gt;&gt;</code></p>
<ul>
<li>server : 기본 정보</li>
<li>clients : client의 접속 정보</li>
<li>memory : 메모리 사용 관련 정보</li>
<li>persistence : RDB와 AOF(Append Only File) 관련 정보</li>
</ul>
<blockquote>
<p>AOF의 경우는 appendonly.aof 파일에 입력/수정/삭제 실행 명령 실행시 마다 기록 (조회 제외)</p>
<p>Redis 서버 작동시 <code>FLUSHALL</code>명령을 사용한 경우 해당 파일을 이용해서 DB를 재 구축 할 수 있음</p>
<p><span class="exturl" data-url="aHR0cDovL3JlZGlzZ2F0ZS5rci9yZWRpcy9jb25maWd1cmF0aW9uL3BlcnNpc3RlbmNlLnBocA==" title="http://redisgate.kr/redis/configuration/persistence.php">http://redisgate.kr/redis/configuration/persistence.php<i class="fa fa-external-link"></i></span></p>
<p>RDB의 경우에는 현재 메모리에 있는 redis data를 특정 시점을 기준으로 파일로 write 한 일종의 backup 파일 또는 스냅샷으로 생각 하면 된다.</p>
</blockquote>
<ul>
<li>stats : 일반 통계 정보</li>
<li>replication : Master, Slave간에 데이터 복사에 대한 설정</li>
<li>cpu : cpu 사용 통계</li>
<li>commandstats : redis에 command를 처리한 통계</li>
<li>cluster : redis cluster에 대한 설정 (master, slave 등)</li>
<li>keyspace : database 관련 통계</li>
</ul>
<h4 id="server"><a href="#server" class="headerlink" title="server"></a>server</h4><h5 id="redis-version-redis-서버-버전"><a href="#redis-version-redis-서버-버전" class="headerlink" title="redis_version : redis 서버 버전"></a>redis_version : redis 서버 버전</h5><h5 id="redis-git-sha1-git-sha1"><a href="#redis-git-sha1-git-sha1" class="headerlink" title="redis_git_sha1 : git sha1 (?)"></a>redis_git_sha1 : git sha1 (?)</h5><h5 id="redis-git-dirty-git-dirty-flag"><a href="#redis-git-dirty-git-dirty-flag" class="headerlink" title="redis_git_dirty : git dirty flag (?)"></a>redis_git_dirty : git dirty flag (?)</h5><h5 id="redis-build-id"><a href="#redis-build-id" class="headerlink" title="redis_build_id"></a>redis_build_id</h5><p>소스로 부터 redis를 빌드한 id</p>
<h5 id="redis-mode"><a href="#redis-mode" class="headerlink" title="redis_mode"></a>redis_mode</h5><p>standalone : 독립적으로 동작</p>
<p>sentinel : sentinel에 의해 모니터링 되고 관리됨</p>
<p>cluster : redis간 clustering 처리</p>
<h5 id="os"><a href="#os" class="headerlink" title="os"></a>os</h5><h5 id="arch-bits"><a href="#arch-bits" class="headerlink" title="arch_bits"></a>arch_bits</h5><p>32bits or 64bits</p>
<h5 id="multiplexing-api"><a href="#multiplexing-api" class="headerlink" title="multiplexing_api (?)"></a>multiplexing_api (?)</h5><p>evnet loop 메카니즘</p>
<h5 id="process-id"><a href="#process-id" class="headerlink" title="process_id"></a>process_id</h5><p>서버 PID</p>
<h5 id="tcp-port"><a href="#tcp-port" class="headerlink" title="tcp_port"></a>tcp_port</h5><p>TCP/IP 리슨포트 (6379 기본 포트)</p>
<h5 id="uptime-in-seconds"><a href="#uptime-in-seconds" class="headerlink" title="uptime_in_seconds"></a>uptime_in_seconds</h5><p>redis server 작동 후 시간</p>
<h5 id="uptime-in-days"><a href="#uptime-in-days" class="headerlink" title="uptime_in_days"></a>uptime_in_days</h5><p>redis server 작동 후 일자</p>
<h5 id="lru-clock"><a href="#lru-clock" class="headerlink" title="lru_clock"></a>lru_clock</h5><p>LRU 알고리즘을 위한 시간 (매분 마다 증가함)</p>
<p>Least Recently Used 가장 오랫동안 접근 되지 않은 키의 데이터를 삭제한다는 의미</p>
<h5 id="excutable"><a href="#excutable" class="headerlink" title="excutable"></a>excutable</h5><p>실행 파일 위치</p>
<h5 id="config-file"><a href="#config-file" class="headerlink" title="config_file"></a>config_file</h5><p>환경 설정 파일 위치</p>
<h4 id="clients"><a href="#clients" class="headerlink" title="clients"></a>clients</h4><h5 id="connected-clients"><a href="#connected-clients" class="headerlink" title="connected_clients"></a>connected_clients</h5><p>현재 접속 되어 있는 clients 개수 (replicas를 통한 접근 제외)</p>
<h5 id="client-longest-output-list"><a href="#client-longest-output-list" class="headerlink" title="client_longest_output_list"></a>client_longest_output_list</h5><p>현재 접속되어 있는 clients 중에 가장 오래 output(? 가장 오래 접속 하고 있는 의미로 보임)하고 있는 list</p>
<h5 id="client-biggest-input-buf"><a href="#client-biggest-input-buf" class="headerlink" title="client_biggest_input_buf"></a>client_biggest_input_buf</h5><p>현재 접속되어있는 clients 중에 가장 큰 input buffer를 넣고 있는 connection</p>
<h5 id="blocked-clients"><a href="#blocked-clients" class="headerlink" title="blocked_clients"></a>blocked_clients</h5><p>blocking call(BLPOP, BRPOP, BRPOPLPUSH)에 의해 blocked 되어있는 client 개수</p>
<blockquote>
<p>BLPOP(리스트의 처음), BRPOP(리스트의 마지막),BRPOPLPUSH (원본 마지막으로 대상 리스트의 첫번째로 입력) 명령어의 경우 기본적으로 blocking 모드 작동을 한다. 즉, 해당 command가 작동 중에는 다음 command는 blocking 되게 된다.</p>
</blockquote>
<h4 id="memory"><a href="#memory" class="headerlink" title="memory"></a>memory</h4><h5 id="used-memory"><a href="#used-memory" class="headerlink" title="used_memory"></a>used_memory</h5><p>redis가 사용중인 총 메모리양</p>
<h5 id="used-memory-human"><a href="#used-memory-human" class="headerlink" title="used_memory_human"></a>used_memory_human</h5><p>사람이 읽을 수있는 메모리양 표시 (G로 표시한다)</p>
<h5 id="used-memory-rss"><a href="#used-memory-rss" class="headerlink" title="used_memory_rss"></a>used_memory_rss</h5><p>OS상에서 사용중인 메모리양</p>
<blockquote>
<p>일반적으로 해당 솔루션에서 사용된 메모리양 + shared 메모리양의 총합으로</p>
<p>used memory 보다 크다</p>
</blockquote>
<h5 id="used-memory-rss-human"><a href="#used-memory-rss-human" class="headerlink" title="used_memory_rss_human"></a>used_memory_rss_human</h5><p>사람이 읽을 수 있는 메모리양 표시 (G로 표시한다)</p>
<h5 id="used-memory-peak"><a href="#used-memory-peak" class="headerlink" title="used_memory_peak"></a>used_memory_peak</h5><p>바이트 단위로 메모리가 peak에 있을 때 사용량</p>
<h5 id="used-memory-peak-perc"><a href="#used-memory-peak-perc" class="headerlink" title="used_memory_peak_perc"></a>used_memory_peak_perc</h5><p>used_memory 대비 used_memory의 퍼센트 (peak이 더 높다)</p>
<h5 id="used-memory-overhead"><a href="#used-memory-overhead" class="headerlink" title="used_memory_overhead"></a>used_memory_overhead</h5><p>모든 overheads에 대한 바이트 합</p>
<h5 id="used-memory-startup"><a href="#used-memory-startup" class="headerlink" title="used_memory_startup"></a>used_memory_startup</h5><p>redis가 start하는 시점에 사용된 전체 메모리양</p>
<h5 id="used-memory-dataset"><a href="#used-memory-dataset" class="headerlink" title="used_memory_dataset"></a>used_memory_dataset</h5><p>dataset의 바이트 단위 사이즈</p>
<h5 id="maxmemory"><a href="#maxmemory" class="headerlink" title="maxmemory"></a>maxmemory</h5><p>설정된 최대 메모리</p>
<p>32bit의 경우는 3G</p>
<p>64bit의 경우는 0 (unlimit로 처리 되는 것으로 보임)</p>
<h5 id="maxmemory-policy"><a href="#maxmemory-policy" class="headerlink" title="maxmemory_policy"></a>maxmemory_policy</h5><ul>
<li>noeviction : memory의 limit에 접근하면 에러를 낸다</li>
<li>allkeys-lru : 신규 데이터 입력시 key를 기반으로 LRU 알고리즘 적용</li>
<li>volatile-lru : allkeys-lru와 같은 조건이나, expire set이 있는 경우만 대상으로 함</li>
</ul>
<blockquote>
<p>EXPIRE (<span class="exturl" data-url="aHR0cHM6Ly9yZWRpcy5pby9jb21tYW5kcy9leHBpcmU=" title="https://redis.io/commands/expire">https://redis.io/commands/expire<i class="fa fa-external-link"></i></span>) 명령어로 지정된 key를 대상으로만 하는 것으로 보임</p>
</blockquote>
<ul>
<li>allkeys-random : random으로 삭제(진짜?)</li>
<li>volatile-random : expire set이 있는 경우만 random으로 삭제</li>
<li>volatile-ttl : expire set의 ttl을 확인 후 최우선으로 삭제</li>
</ul>
<blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9yZWRpcy5pby90b3BpY3MvbHJ1LWNhY2hl" title="https://redis.io/topics/lru-cache">https://redis.io/topics/lru-cache<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h4 id="persistence"><a href="#persistence" class="headerlink" title="persistence"></a>persistence</h4><h5 id="loading"><a href="#loading" class="headerlink" title="loading"></a>loading</h5><p>dump 파일이 로딩 중인지 표시 한다 (평소에는 0이다가 로딩하게 되면 1로 변화하는 것으로 보인다)</p>
<h5 id="rdb-changes-since-last-save"><a href="#rdb-changes-since-last-save" class="headerlink" title="rdb_changes_since_last_save"></a>rdb_changes_since_last_save</h5><p>마지막 dump 후 변경된 횟수</p>
<h5 id="rdb-last-save-time"><a href="#rdb-last-save-time" class="headerlink" title="rdb_last_save_time"></a>rdb_last_save_time</h5><p>epoch 기준으로 마지막 성공한 저장 시점</p>
<h5 id="aof-enabled"><a href="#aof-enabled" class="headerlink" title="aof_enabled"></a>aof_enabled</h5><p>aof 설정 여부 (0 false)</p>
<h4 id="replication"><a href="#replication" class="headerlink" title="replication"></a>replication</h4><h5 id="role"><a href="#role" class="headerlink" title="role"></a>role</h5><p>master or slave</p>
<h5 id="master-replid"><a href="#master-replid" class="headerlink" title="master_replid"></a>master_replid</h5><p>redis server replication ID</p>
<h5 id="master-repl-offset"><a href="#master-repl-offset" class="headerlink" title="master_repl_offset"></a>master_repl_offset</h5><p>현재 서버의 replication offset</p>
<h4 id="Redis-Sentinel-사용시-수시-Disconnect가-발생하는-경우"><a href="#Redis-Sentinel-사용시-수시-Disconnect가-발생하는-경우" class="headerlink" title="Redis Sentinel 사용시 수시 Disconnect가 발생하는 경우"></a>Redis Sentinel 사용시 수시 Disconnect가 발생하는 경우</h4><h5 id="sentinel-down-after-milliseconds-mymaster-3000"><a href="#sentinel-down-after-milliseconds-mymaster-3000" class="headerlink" title="sentinel down-after-milliseconds mymaster 3000"></a>sentinel down-after-milliseconds mymaster 3000</h5><p>설정을 확인한다.</p>
<p>상위에서 마지막 부분에 있는 3000은 3초를 의미 한다. 이를 매우 작게 사용한다면 Redis간 Sync시 Disconnect를 감지하고 Master Slave 전환을 처리 하게 된다. 일반적으로 3초에서 5초 사이로 설정해 놓고 쓰면된다.</p>
<blockquote>
<p>Reids Sync 처리 프로세스를 실행하기 전에 Master에서 BGSAVE처리를 하게 된다. BGSAVE는 메모리 데이터를 파일로 Write하는 행동인데, 이때 Redis 소스 내부적으로 Slave와 Disconnect를 처리 한다. 이 순간의 단절 상황을 Sentinel에서 감지하게 되는 문제이다. </p>
</blockquote>
<h5 id="client-output-buffer-limit"><a href="#client-output-buffer-limit" class="headerlink" title="client-output-buffer-limit"></a>client-output-buffer-limit</h5><p>client-output-buffer-limit normal 0 0 0<br>client-output-buffer-limit slave 256mb 64mb 60<br>client-output-buffer-limit pubsub 32mb 8mb 60</p>
<p>Redis와 Slave 간의 데이터 이동 양을 정하는 부분이다</p>
<p>client-output-buffer-limit slave 256mb 64mb 60</p>
<ul>
<li>hard : 최대 256mb의 데이터를 송수신 할 수 있다.  넘어가면 Disconnect가 발생한다.</li>
<li>Soft : 64mb 데이터를 60초 동안 이동 시킨다. 넘어가면 Disconnect가 발생한다. </li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://theyoung.github.io/Android-Webview-Keyboard-Process-With-IME/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="whoami">
      <meta itemprop="description" content="my note">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Try Again">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/Android-Webview-Keyboard-Process-With-IME/" class="post-title-link" itemprop="url">android keyboard show on the web</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-05-24 18:37:40" itemprop="dateCreated datePublished" datetime="2019-05-24T18:37:40Z">2019-05-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-04 02:25:46" itemprop="dateModified" datetime="2019-07-04T02:25:46Z">2019-07-04</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/Android-Webview-Keyboard-Process-With-IME/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Android-Webview-Keyboard-Process-With-IME/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Android에서-Keyboard-작동을-위한-요소"><a href="#Android에서-Keyboard-작동을-위한-요소" class="headerlink" title="Android에서 Keyboard 작동을 위한 요소"></a>Android에서 Keyboard 작동을 위한 요소</h4><ul>
<li>Input Method Manager : 클라이언트 Side의 application context에 위치 하면서 Android 전체 시스템 상 프로세스 간의 통로 역할을 한다</li>
<li>Input Method (IME &amp; Keyboard) : 쉽게 keyboard라고 생각하면 된다. 사용자의 text를 생성하고 입력할 수있게 하는 역할을 한다. IME는 오직 한번에 하나만 화면에 표시 될 수있다.</li>
<li>Client Application : IME을 사용하는 대상 application이 되며, 한번에 오직 하나의 입력 화면(소스를 보면 View라고 생각된다)과 Active 상태를 유지 할 수있다.</li>
</ul>
<h5 id="InputMethd-Framework-IMF-의-보안적-제한"><a href="#InputMethd-Framework-IMF-의-보안적-제한" class="headerlink" title="InputMethd Framework (IMF) 의 보안적 제한"></a>InputMethd Framework (IMF) 의 보안적 제한</h5><p>Input Method의 경우 사용자의 모든 입력을 확인 할 수있기 때문에, 보안적인 제한이 걸려있다.</p>
<ul>
<li>IME interface 접근 : 오직 Manifest.permission.BIND_INPUT_METHOD 권한을 통해서만 접근 가능</li>
<li>Clinet는 Input method를 사용할때 InputMethodSession 인터페이스에서 주어진 Access를 통해서만 가능하다. 아래 코드는 InputMethodManager의 코드 일부분이다 이때 windowToken을 통해 hide 시킬 권한을 얻어오는 것을 볼 수있다 </li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hideSoftInputFromWindow</span><span class="params">(IBinder windowToken, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hideSoftInputFromWindow(windowToken, flags, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Input Method는 화면이 off 되어있는 상태에서 절대로 사용될 수 없다.</li>
<li>신규 IME를 인스톨 할경우 IME의 변환은 반듯이 사용자의 손에 의해서 만 변경 될 수있다.</li>
</ul>
<h4 id="IME의-Lifecycle"><a href="#IME의-Lifecycle" class="headerlink" title="IME의 Lifecycle"></a>IME의 Lifecycle</h4><p>이하 Lifecycle은 InputMethodService : <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vcmVmZXJlbmNlL2FuZHJvaWQvaW5wdXRtZXRob2RzZXJ2aWNlL0lucHV0TWV0aG9kU2VydmljZeqwgA==" title="https://developer.android.com/reference/android/inputmethodservice/InputMethodService가">https://developer.android.com/reference/android/inputmethodservice/InputMethodService가<i class="fa fa-external-link"></i></span> 작동하는 순서를 나타내고 있다 </p>
<p><img src="https://developer.android.com/resources/articles/images/inputmethod_lifecycle_image.png" alt></p>
<ul>
<li><p>onCreateInputView() : 사용자 입력을 받기 위해 View를 init한다. (여기서 init되는 화면은 단순히 softkey 뿐만이 아닌 Draw 입력 등도 포함된다) User interface의 생성이라고 생각하면 될 듯 하다. 아래 코드는 IMS를 Override하여 어떻게 UI를 생성하는지 보여주는 예이다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">onCreateInputView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mKeyboardView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mKeyboardView.closing();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    updateKeyboardThemeAndContextThemeWrapper(</span><br><span class="line">            mLatinIME, KeyboardTheme.getKeyboardTheme(mLatinIME <span class="comment">/* context */</span>));</span><br><span class="line">    mCurrentInputView = (InputView)LayoutInflater.from(mThemeContext).inflate(</span><br><span class="line">            R.layout.input_view, <span class="keyword">null</span>);</span><br><span class="line">    mMainKeyboardFrame = mCurrentInputView.findViewById(R.id.main_keyboard_frame);</span><br><span class="line">  </span><br><span class="line">    mKeyboardView = (MainKeyboardView) mCurrentInputView.findViewById(R.id.keyboard_view);</span><br><span class="line">    mKeyboardView.setKeyboardActionListener(mLatinIME);</span><br><span class="line">    <span class="keyword">return</span> mCurrentInputView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>onEvaluateInputViewShown() : hard keyboard 등이 달려 있는 단말의 경우 soft keyboard가 보일 필요가 없다. 이와같이 keyboard를 사용자에게 보여줄지를 확인 하는 메서드이다. (물론 softkeyboard가 열려 있다면 return 은 true가 될 것이다)<br>아래는 IMS의 code이다. false가 return 되면 사용자에게 보여주면 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onEvaluateInputViewShown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mSettingsObserver == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"onEvaluateInputViewShown: mSettingsObserver must not be null here."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mSettingsObserver.shouldShowImeWithHardKeyboard()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Configuration config = getResources().getConfiguration();</span><br><span class="line">    <span class="keyword">return</span> config.keyboard == Configuration.KEYBOARD_NOKEYS</span><br><span class="line">            || config.hardKeyboardHidden == Configuration.HARDKEYBOARDHIDDEN_YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>onStartInput()  &amp; onStartInputView() : text 입력의 시작을 알리는 부분으로, 해당 메서드의 call 순서는 onStartInput이 일어나고 그다음에 onStartInputView가 Call되게 된다. 해당 Call의 순서처리에 따라서 lifecycle이 다소 달라지는데 해당 내용은 &quot;Webview에서의 Keyboard 처리&quot;에서 상세하게 다룰것이다. IMS에서는 doStartInput이 발생할 경우 onStartInput을 요청하고 이후에 InputView를 call하는 것을 확인 할 수 있다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doStartInput</span><span class="params">(InputConnection ic, EditorInfo attribute, <span class="keyword">boolean</span> restarting)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!restarting) &#123;</span><br><span class="line">        doFinishInput();</span><br><span class="line">    &#125;</span><br><span class="line">    mInputStarted = <span class="keyword">true</span>;</span><br><span class="line">    mStartedInputConnection = ic;</span><br><span class="line">    mInputEditorInfo = attribute;</span><br><span class="line">    initialize();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"CALL: onStartInput"</span>);</span><br><span class="line">    onStartInput(attribute, restarting);</span><br><span class="line">    <span class="keyword">if</span> (mWindowVisible) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mShowInputRequested) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"CALL: onStartInputView"</span>);</span><br><span class="line">            mInputViewStarted = <span class="keyword">true</span>;</span><br><span class="line">            onStartInputView(mInputEditorInfo, restarting);</span><br><span class="line">            startExtractingText(<span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mCandidatesVisibility == View.VISIBLE) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"CALL: onStartCandidatesView"</span>);</span><br><span class="line">            mCandidatesViewStarted = <span class="keyword">true</span>;</span><br><span class="line">            onStartCandidatesView(mInputEditorInfo, restarting);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>onStartInput과 onStartInputView의 차이점을 문서 상으로 확인하기는 쉽지 않다. 코드상으로 보면 onStartInput의 경우는 Local과 같은 설정, onStartInputView는 실제로 보여줄 keyboard에 대한 모든 설정을 처리 하는 것으로 보인다.</p>
</blockquote>
<h4 id="Webview에서의-Keyboard-처리"><a href="#Webview에서의-Keyboard-처리" class="headerlink" title="Webview에서의 Keyboard 처리"></a>Webview에서의 Keyboard 처리</h4><p>Webview를 이용한 키보드 처리는 크게 3가지로 나눌 수 있다.</p>
<ul>
<li>Webview에서 load된 html의 input 입력시 자동으로 IME Show</li>
<li>Webview의 <code>public InputConnection onCreateInputConnection(EditorInfo outAttrs) {</code>을 Override 시켜서 특정 키보드 환경을 지정</li>
<li><code>showSoftInput</code>을 활용 하는 방법</li>
</ul>
<h5 id="onCreateInputConnection-Override"><a href="#onCreateInputConnection-Override" class="headerlink" title="onCreateInputConnection() Override"></a>onCreateInputConnection() Override</h5><p>android.webkit.Webview 객체를 override 하면 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.app;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseWebView</span> <span class="keyword">extends</span> <span class="title">WebView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputConnection <span class="title">onCreateInputConnection</span><span class="params">(EditorInfo outAttrs)</span> </span>&#123;</span><br><span class="line">        InputConnection ic = <span class="keyword">super</span>.onCreateInputConnection(outAttrs);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> original = outAttrs.imeOptions;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> notMask = ~EditorInfo.IME_MASK_ACTION;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> maskResult = original &amp; notMask;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>((outAttrs.inputType &amp; EditorInfo.TYPE_MASK_CLASS) == EditorInfo.TYPE_CLASS_NUMBER)&#123;</span><br><span class="line">            Log.d(TAG,<span class="string">"IME Options is Number"</span>);</span><br><span class="line">            outAttrs.privateImeOptions=<span class="string">"defaultInputmode=numeric;"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.d(TAG,<span class="string">"IME Options is English"</span>);</span><br><span class="line">            outAttrs.privateImeOptions=<span class="string">"defaultInputmode=english;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ic;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>InputConnection ic = super.onCreateInputConnection(outAttrs);</code>이 부분은 반듯이 첫번째 code로 와야 한다. 해당 코드가 최초로 오지 않게 되면 load된 html이 어떤 input tag를 focus하고 있는지 알 수가 없게 된다. 이 코드를 통과 하고 나야 비로소 <code>EditorInfo</code>에 의미 있는 값들이 저장되게 된다.</p>
<p>이때 개발자가 확인 가능한 값은 2가지가 있는데 <code>imeOptions</code>와 <code>inputType</code>인데</p>
<ul>
<li>imeOptions는 IME가 어떤 형태로 표현될지 어떤 기능을 제공할지에 대한 표현을 제공한다. 해당 값에 대한 표현 방법은 <code>EditorInfo.IME_MASK_ACTION</code>을 기준으로 Action 처리와 FLAG 처리로 분리 된다.<ul>
<li>Action : GO, NEXT, NONE, PREVIOUS, SEARCH, SEND 등 엔터 버튼에 대한 기능을 정의하게 된다.</li>
<li>Flag : ASCII, NAVIGATE,ACCESSORY,NO_ENTER,EXTRACT, FULLSCREEN 등 키보드의 형태를 나타낸다</li>
</ul>
</li>
</ul>
<p>상위 값들에 대한 정확한 OPTION은 다음 페이지를 참조 해야하나, 실질적으로 해당 Options을 모두 적용한 IME가 많지는 않다.</p>
<p>일단 해당 값들에 대한 마스킹 방법은 다음과 같이 처리 하면된다.</p>
<ul>
<li>FLAG 값을 읽어 올 수있는 방법 (Webview를 이용해서는 해당 옵션을 얻어 올수 없었다.) 비록 html style에 ime-mode가 있다고는 하지만 이와는 관련점이 없었다</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> original = outAttrs.imeOptions;</span><br><span class="line"><span class="keyword">int</span> notMask = ~EditorInfo.IME_MASK_ACTION;</span><br><span class="line"><span class="keyword">int</span> flag = original &amp; notMask;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ime-mode는 크롬등에서 호환되지 않고, deprecated 된 기능이다</p>
</blockquote>
<ul>
<li>Action 값을 읽어 올수 있는 방법 (역시 Webview에서는 의미 있는데이터를 얻어 올 수 없었다)</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> action = original &amp; EditorInfo.IME_MASK_ACTION;</span><br></pre></td></tr></table></figure>
<p>결과적으로 이시점에 개발자가 처리 할 수있는 값은 inputType이다.  해당 값은 다음과 같은 코드로 읽어 올 수있다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> inputType = outAttrs.inputType &amp; EditorInfo.TYPE_MASK_CLASS</span><br></pre></td></tr></table></figure>
<p>MASK로 얻어올수 있는 값은 text, number, phone, datetime 정도이고 webview에서 의미 있는 값은 text와 number 정도가 될 것이다.</p>
<p><code>TYPE_CLASS_TEXT</code>, <code>TYPE_CLASS_NUMBER</code>, <code>TYPE_CLASS_PHONE</code>, <code>TYPE_CLASS_DATETIME</code></p>
<p>아래 코드는 inputType을 바탕으로 어떤 keyboard를 표현 하게 할지 나타내는 코드이다.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if((outAttrs.inputType &amp; EditorInfo.TYPE_MASK_CLASS) == EditorInfo.TYPE_CLASS_NUMBER)     &#123;</span><br><span class="line">    Log.d(TAG,&quot;IME Options is Number&quot;);</span><br><span class="line">   ...</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    Log.d(TAG,&quot;IME Options is English&quot;);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그러나 상위와 같은 코드는 아주 특별한 경우를 제외하고는 사용하지 않는다. 그 이유는 어떤 종류의 keyboard를 보여 줄지를 정의 하는건 IME의 <code>onStartInputView</code>내부에서 처리가 될것이기 때문이다.</p>
<p>일반적으로 onCreateInputConnection을 사용하는 이유는 IME로 넘어 가기전에 EditorInfo를 수정하기 위해서이다. 예를 들자면 outAttrs.inputType에 EditorInfo.TYPE_CLASS_NUMBER를 주입하게 되면 해당 webview를 사용한 html은 number type의 키보드만 보게 되는 것이다.</p>
<h5 id="InputMethodManager를-이용한-showSoftInput처리"><a href="#InputMethodManager를-이용한-showSoftInput처리" class="headerlink" title="InputMethodManager를 이용한 showSoftInput처리"></a>InputMethodManager를 이용한 showSoftInput처리</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);</span><br><span class="line">imm.showSoftInput(mWebView, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>InputMethodManager를 시스템 서비스에서 직점 instance를 얻어와서 특정 view (여기서는 mWebView)와 IME를 연결시키는 코드이다. 해당 코드는 Webview상 어떤 html element와 access를 해야할지 알기가 어렵기 때문에 어떤 keyboard를 강제로 뛰울 수가 없다.</p>
<p>비록 Webview를 상속 받아서 <code>onCreateInputConnection()</code>을 재정의 한다고 하더라도 이경우에는 해당 Method를 타지 않는다. 그렇기 때문에 EditorInfo 역시 추출 할 수가 없는 상태가 된다. 이렇다 보니 무조건 default keyboard만 나타나게 되는데, 이 부분을 해결 하는 방법은 webview에 inputType을 추가 해주는 것이다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseWebView</span> <span class="keyword">extends</span> <span class="title">WebView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> inputType = EditorInfo.TYPE_NULL;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInputType</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">        inputType = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInputType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> inputType;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>그리고 해당 내용을 아래와 같이 추가해 준다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);</span><br><span class="line">mWebView.setInputType(InputType.TYPE_CLASS_NUMBER);</span><br><span class="line">imm.showSoftInput(mWebView, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>onStartInputView에서 inputType을 확인 한 후 number keyboard를 보여 주게 될것이다.</p>
<p>imeOptions나 다른 파라메터들은 상위와 같이 강제 Setting을 해도 keyboard에 별다를 영향을 주지 못했다.</p>
<h4 id="Keyboard-처리에-대한-IME-Call-Flow"><a href="#Keyboard-처리에-대한-IME-Call-Flow" class="headerlink" title="Keyboard 처리에 대한 IME Call Flow"></a>Keyboard 처리에 대한 IME Call Flow</h4><p>사실 상위 두 가지의 Call Flow가 다를 거라고 크게 생각하지 못했으나 의외로 전혀 다른 process를 타고 있었다. </p>
<p>아래는 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Jra3Ivc2ltcGxlLWtleWJvYXJk" title="https://github.com/rkkr/simple-keyboard">https://github.com/rkkr/simple-keyboard<i class="fa fa-external-link"></i></span>의 소스에 Log를 붙여서 어떤 flow를 trace한 표이다.</p>
<h5 id="html에서-input-tag를-눌러서-keyboard-표시-했을-때"><a href="#html에서-input-tag를-눌러서-keyboard-표시-했을-때" class="headerlink" title="html에서 input tag를 눌러서 keyboard 표시 했을 때"></a>html에서 input tag를 눌러서 keyboard 표시 했을 때</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">//input을 이용한 show</span><br><span class="line">05-24 09:53:41.362 13828 13828 D LatinIME: onStartInput = 24578: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.362 13828 13828 D LatinIME: onStartInput editorInfo.inputyType 24578: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.363 13828 13828 D LatinIME: executePendingImsCallback editorInfo.inputyType 24578: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.363 13828 13828 D LatinIME: onStartInputInternal editorInfo inputType24578: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.364 13828 13828 D LatinIME: onShowInputRequested: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.364 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.364 13828 13828 D LatinIME: onEvaluateFullscreenMode: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.364 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.371 13828 13828 D LatinIME: updateFullscreenMode: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.371 13828 13828 D LatinIME: updateSoftInputWindowLayoutParameters: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.375 13828 13828 D LatinIME: onStartInputView: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.376 13828 13828 D LatinIME: executePendingImsCallback editorInfo.inputyType 24578: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.395 13828 13828 I LatinIME: Starting input. Cursor position = 1,1: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.395 13828 13828 D LatinIME: onEvaluateFullscreenMode: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.395 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.395 13828 13828 D LatinIME: updateFullscreenMode: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.395 13828 13828 D LatinIME: updateSoftInputWindowLayoutParameters: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.396 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.411 13828 13828 D LatinIME: loadSettings: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.422 13828 13828 D LatinIME: getCurrentAutoCapsState: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.422 13828 13828 D LatinIME: getCurrentRecapitalizeState: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.426 13828 13828 D LatinIME: shouldShowLanguageSwitchKey: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.487 13828 13828 D LatinIME: onComputeInsets: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.487 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.498 13828 13828 D LatinIME: onComputeInsets: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:53:41.498 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//input hide</span><br><span class="line">05-24 09:54:38.197 13828 13828 D LatinIME: hideWindow: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:54:38.197 13828 13828 D LatinIME: isShowingOptionDialog: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:54:38.197 13828 13828 D LatinIME: onFinishInputView: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:54:38.197 13828 13828 D LatinIME: onFinishInputViewInternal: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:54:38.200 13828 13828 D LatinIME: onWindowHidden: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:54:38.202 13828 13828 D LatinIME: updateFullscreenMode: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:54:38.202 13828 13828 D LatinIME: updateSoftInputWindowLayoutParameters: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:54:38.230 13828 13828 D LatinIME: onComputeInsets: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:54:38.230 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br></pre></td></tr></table></figure>
<h5 id="showSoftInput을-처리-했을-때"><a href="#showSoftInput을-처리-했을-때" class="headerlink" title="showSoftInput을 처리 했을 때"></a>showSoftInput을 처리 했을 때</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">//keyboard show</span><br><span class="line">05-24 09:48:48.369 13828 13828 D LatinIME: onShowInputRequested: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.369 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.369 13828 13828 D LatinIME: onEvaluateFullscreenMode: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.369 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.370 13828 13828 D LatinIME: updateFullscreenMode: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.370 13828 13828 D LatinIME: updateSoftInputWindowLayoutParameters: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.371 13828 13828 D LatinIME: onStartInputView: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.372 13828 13828 D LatinIME: executePendingImsCallback editorInfo.inputyType 49313: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.382 13828 13828 I LatinIME: Starting input. Cursor position = 0,0: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.382 13828 13828 D LatinIME: onEvaluateFullscreenMode: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.382 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.383 13828 13828 D LatinIME: updateFullscreenMode: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.383 13828 13828 D LatinIME: updateSoftInputWindowLayoutParameters: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.383 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.395 13828 13828 D LatinIME: loadSettings: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.402 13828 13828 D LatinIME: getCurrentAutoCapsState: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.402 13828 13828 D LatinIME: getCurrentRecapitalizeState: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.404 13828 13828 D LatinIME: shouldShowLanguageSwitchKey: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.440 13828 13828 D LatinIME: onComputeInsets: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.440 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.452 13828 13828 D LatinIME: onComputeInsets: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:48:48.452 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br><span class="line"></span><br><span class="line">//keyboard hide</span><br><span class="line">05-24 09:52:19.722 13828 13828 D LatinIME: hideWindow: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:52:19.723 13828 13828 D LatinIME: isShowingOptionDialog: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:52:19.723 13828 13828 D LatinIME: onFinishInputView: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:52:19.723 13828 13828 D LatinIME: onFinishInputViewInternal: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:52:19.725 13828 13828 D LatinIME: onWindowHidden: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:52:19.728 13828 13828 D LatinIME: updateFullscreenMode: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:52:19.728 13828 13828 D LatinIME: updateSoftInputWindowLayoutParameters: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:52:19.748 13828 13828 D LatinIME: onComputeInsets: rkr.simplekeyboard.inputmethod</span><br><span class="line">05-24 09:52:19.748 13828 13828 D LatinIME: isImeSuppressedByHardwareKeyboard: rkr.simplekeyboard.inputmethod</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://theyoung.github.io/grafika/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="whoami">
      <meta itemprop="description" content="my note">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Try Again">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/grafika/" class="post-title-link" itemprop="url">Android Grafika Texture Surface</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-19 19:32:33" itemprop="dateCreated datePublished" datetime="2019-04-19T19:32:33Z">2019-04-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-04 02:25:46" itemprop="dateModified" datetime="2019-07-04T02:25:46Z">2019-07-04</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/grafika/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="grafika/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="테스트-mp4파일-받기"><a href="#테스트-mp4파일-받기" class="headerlink" title="테스트 mp4파일 받기"></a>테스트 mp4파일 받기</h3><p>com.android.grafika</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">    public static void initialize(Context context) &#123;</span><br><span class="line">        ContentManager mgr = getInstance();</span><br><span class="line">        synchronized (sLock) &#123;</span><br><span class="line">            if (!mgr.mInitialized) &#123;</span><br><span class="line"><span class="addition">+                mgr.mFilesDir = context.getExternalFilesDir(Environment.DIRECTORY_MOVIES);</span></span><br><span class="line"><span class="deletion">- //                mgr.mFilesDir = context.getFilesDir();</span></span><br><span class="line">                mgr.mContent = new ArrayList&lt;Content&gt;();</span><br><span class="line">                mgr.mInitialized = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>app 인터널 storage를 external로 변경</p>
<p>앱 재실행 후 파일 다운로드 표시 끝나면 android file explore를 이용해서 </p>
<p><code>sdcard&gt; Android &gt; data &gt; com.google.grafica &gt; files &gt; Movies</code></p>
<p>이하를 조회하면,</p>
<ul>
<li>gen-eight-rects.mp4</li>
<li>gen-sliders.mp4</li>
</ul>
<p>파일 확인 가능함</p>
<h3 id="MediaFormat"><a href="#MediaFormat" class="headerlink" title="MediaFormat"></a>MediaFormat</h3><p>비디오 파일(예, mp4)등의 header를 분석한 결과 <code>MediaExtractor</code>를 통해서 정보를 추출할 수 있음</p>
<p>아래 소스는 android app 내의 res&gt;raw 이하에 비디오나 오디오 파일을 위치 시켰을 때 uri 방식으로 수신 할 수 있는 코드이다.</p>
<p>관련 수정사항은 <code>extractor.setDataSource(ctx,uri,null);</code> 이 부분 전후를 보면 된다.</p>
<p>해당 메서드를 요청하는 방법은 Activity에서 아래와 같이 call 하면 된다</p>
<p><code>player = new MoviePlayer(getApplicationContext(), Uri.parse(&quot;android.resource://&quot;+getPackageName()+&quot;/raw/gen_eight_rects&quot;), surface, callback);</code></p>
<p><strong>MoviePlayer.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MoviePlayer</span><span class="params">(Context ctx, Uri uri, Surface outputSurface, FrameCallback frameCallback)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        mContext = ctx;</span><br><span class="line">        mUri = uri;</span><br><span class="line"><span class="comment">//        mSourceFile = sourceFile;</span></span><br><span class="line">        mOutputSurface = outputSurface;</span><br><span class="line">        mFrameCallback = frameCallback;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pop the file open and pull out the video characteristics.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> consider leaving the extractor open.  Should be able to just seek back to</span></span><br><span class="line">        <span class="comment">//       the start after each iteration of play.  Need to rearrange the API a bit --</span></span><br><span class="line">        <span class="comment">//       currently play() is taking an all-in-one open+work+release approach.</span></span><br><span class="line">        MediaExtractor extractor = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line">            extractor.setDataSource(ctx,uri,<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">int</span> trackIndex = selectTrack(extractor);</span><br><span class="line">            <span class="keyword">if</span> (trackIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No video track found in "</span> + mSourceFile);</span><br><span class="line">            &#125;</span><br><span class="line">            extractor.selectTrack(trackIndex);</span><br><span class="line"></span><br><span class="line">            MediaFormat format = extractor.getTrackFormat(trackIndex);</span><br><span class="line">            mVideoWidth = format.getInteger(MediaFormat.KEY_WIDTH);</span><br><span class="line">            mVideoHeight = format.getInteger(MediaFormat.KEY_HEIGHT);</span><br><span class="line">            <span class="keyword">if</span> (VERBOSE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"Video size is "</span> + mVideoWidth + <span class="string">"x"</span> + mVideoHeight);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (extractor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                extractor.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the width, in pixels, of the video.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVideoWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mVideoWidth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the height, in pixels, of the video.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVideoHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mVideoHeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the loop mode.  If true, playback will loop forever.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoopMode</span><span class="params">(<span class="keyword">boolean</span> loopMode)</span> </span>&#123;</span><br><span class="line">        mLoop = loopMode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Asks the player to stop.  Returns without waiting for playback to halt.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Called from arbitrary thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mIsStopRequested = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decodes the video stream, sending frames to the surface.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Does not return until video playback is complete, or we get a "stop" signal from</span></span><br><span class="line"><span class="comment">     * frameCallback.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        MediaExtractor extractor = <span class="keyword">null</span>;</span><br><span class="line">        MediaCodec decoder = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> fileBased = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// The MediaExtractor error messages aren't very useful.  Check to see if the input</span></span><br><span class="line">        <span class="comment">// file exists so we can throw a better one if it's not there.</span></span><br><span class="line">        <span class="keyword">if</span> (mSourceFile != <span class="keyword">null</span> &amp;&amp; !mSourceFile.canRead()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"Unable to read "</span> + mSourceFile);</span><br><span class="line">        &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">            fileBased = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line"><span class="comment">//            extractor.setDataSource(mSourceFile.toString());</span></span><br><span class="line">            extractor.setDataSource(mContext,mUri,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> trackIndex = selectTrack(extractor);</span><br><span class="line">            <span class="keyword">if</span> (trackIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No video track found in "</span> + mSourceFile);</span><br><span class="line">            &#125;</span><br><span class="line">            extractor.selectTrack(trackIndex);</span><br><span class="line"></span><br><span class="line">            MediaFormat format = extractor.getTrackFormat(trackIndex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a MediaCodec decoder, and configure it with the MediaFormat from the</span></span><br><span class="line">            <span class="comment">// extractor.  It's very important to use the format from the extractor because</span></span><br><span class="line">            <span class="comment">// it contains a copy of the CSD-0/CSD-1 codec-specific data chunks.</span></span><br><span class="line">            String mime = format.getString(MediaFormat.KEY_MIME);</span><br><span class="line">            decoder = MediaCodec.createDecoderByType(mime);</span><br><span class="line">            decoder.configure(format, mOutputSurface, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">            decoder.start();</span><br><span class="line"></span><br><span class="line">            doExtract(extractor, trackIndex, decoder, mFrameCallback);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// release everything we grabbed</span></span><br><span class="line">            <span class="keyword">if</span> (decoder != <span class="keyword">null</span>) &#123;</span><br><span class="line">                decoder.stop();</span><br><span class="line">                decoder.release();</span><br><span class="line">                decoder = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (extractor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                extractor.release();</span><br><span class="line">                extractor = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>MediaFormat format = extractor.getTrackFormat(trackIndex);</code>이 부분이 track 으로 부터 Media의 정보를 얻어오는 부분이다. </p>
<h4 id="Audio-Video-공통-포멧-정보"><a href="#Audio-Video-공통-포멧-정보" class="headerlink" title="Audio / Video 공통 포멧 정보"></a>Audio / Video 공통 포멧 정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Value Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>KEY_MIME</code></td>
<td style="text-align:left">String</td>
<td style="text-align:left">The type of the format.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_MAX_INPUT_SIZE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional, maximum size of a buffer of input data</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_BIT_RATE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, desired bitrate in bits/second</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Video-포멧-정보"><a href="#Video-포멧-정보" class="headerlink" title="Video 포멧 정보"></a>Video 포멧 정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Value Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>KEY_WIDTH</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_HEIGHT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_COLOR_FORMAT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">set by the user for encoders, readable in the output format of decoders</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_FRAME_RATE</code></td>
<td style="text-align:left">Integer or Float</td>
<td style="text-align:left">required for <strong>encoders</strong>, optional for <strong>decoders</strong></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_CAPTURE_RATE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_I_FRAME_INTERVAL</code></td>
<td style="text-align:left">Integer (or Float)</td>
<td style="text-align:left"><strong>encoder-only</strong>, time-interval between key frames. Float support added in <code>Build.VERSION_CODES.N_MR1</code></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_INTRA_REFRESH_PERIOD</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_LATENCY</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_MAX_WIDTH</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, max-resolution width</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_MAX_HEIGHT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, max-resolution height</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_REPEAT_PREVIOUS_FRAME_AFTER</code></td>
<td style="text-align:left">Long</td>
<td style="text-align:left"><strong>encoder in surface-mode only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_PUSH_BLANK_BUFFERS_ON_STOP</code></td>
<td style="text-align:left">Integer(1)</td>
<td style="text-align:left"><strong>decoder rendering to a surface only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_TEMPORAL_LAYERING</code></td>
<td style="text-align:left">String</td>
<td style="text-align:left"><strong>encoder only</strong>, optional, temporal-layering schema</td>
</tr>
</tbody>
</table>
</div>
<h4 id="오디오-포멧정보"><a href="#오디오-포멧정보" class="headerlink" title="오디오 포멧정보"></a>오디오 포멧정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Value Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>KEY_CHANNEL_COUNT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_SAMPLE_RATE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_PCM_ENCODING</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_IS_ADTS</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional, if <em>decoding</em> AAC audio content, setting this key to 1 indicates that each audio frame is prefixed by the ADTS header.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_PROFILE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional, if content is AAC audio, specifies the desired profile.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_SBR_MODE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional, if content is AAC audio, specifies the desired SBR mode.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_TARGET_REFERENCE_LEVEL</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the target reference level.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_ENCODED_TARGET_LEVEL</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the target reference level used at encoder.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_BOOST_FACTOR</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the DRC boost factor.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_ATTENUATION_FACTOR</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the DRC attenuation factor.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_HEAVY_COMPRESSION</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies whether to use heavy compression.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_MAX_OUTPUT_CHANNEL_COUNT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the maximum number of channels the decoder outputs.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_EFFECT_TYPE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the MPEG-D DRC effect type to use.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_CHANNEL_MASK</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional, a mask of audio channel assignments</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_FLAC_COMPRESSION_LEVEL</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional, if content is FLAC audio, specifies the desired compression level.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="자막정보"><a href="#자막정보" class="headerlink" title="자막정보"></a>자막정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Name</th>
<th>Value Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>KEY_MIME</code></td>
<td>String</td>
<td>The type of the format.</td>
</tr>
<tr>
<td><code>KEY_LANGUAGE</code></td>
<td>String</td>
<td>The language of the content.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="이미지-정보"><a href="#이미지-정보" class="headerlink" title="이미지 정보"></a>이미지 정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Name</th>
<th>Value Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>KEY_MIME</code></td>
<td>String</td>
<td>The type of the format.</td>
</tr>
<tr>
<td><code>KEY_WIDTH</code></td>
<td>Integer</td>
<td></td>
</tr>
<tr>
<td><code>KEY_HEIGHT</code></td>
<td>Integer</td>
<td></td>
</tr>
<tr>
<td><code>KEY_COLOR_FORMAT</code></td>
<td>Integer</td>
<td>set by the user for encoders, readable in the output format of decoders</td>
</tr>
<tr>
<td><code>KEY_TILE_WIDTH</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
<tr>
<td><code>KEY_TILE_HEIGHT</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
<tr>
<td><code>KEY_GRID_ROWS</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
<tr>
<td><code>KEY_GRID_COLUMNS</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
</tbody>
</table>
</div>
<h3 id="MediaCodec"><a href="#MediaCodec" class="headerlink" title="MediaCodec"></a>MediaCodec</h3><p>미디어 코덱은 미디어 데이터의 제공자와 미디어 데이터를 소비하는 소비자의 중간에 위치하는 존재이다.</p>
<p>즉,</p>
<p>(미디어 데이터 제공자) --(encoded data stream)--&gt; <strong>[MediaCodec]</strong> --(decoded data stream) --&gt;(소비자) </p>
<p>형태로 나타나게 된다.</p>
<p>MoviePalyer 소스 코드를 보자면</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        MediaExtractor extractor = <span class="keyword">null</span>;</span><br><span class="line">        MediaCodec decoder = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> fileBased = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// The MediaExtractor error messages aren't very useful.  Check to see if the input</span></span><br><span class="line">        <span class="comment">// file exists so we can throw a better one if it's not there.</span></span><br><span class="line">        <span class="keyword">if</span> (mSourceFile != <span class="keyword">null</span> &amp;&amp; !mSourceFile.canRead()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"Unable to read "</span> + mSourceFile);</span><br><span class="line">        &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">            fileBased = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line"><span class="comment">//            extractor.setDataSource(mSourceFile.toString());</span></span><br><span class="line">            extractor.setDataSource(mContext,mUri,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> trackIndex = selectTrack(extractor);</span><br><span class="line">            <span class="keyword">if</span> (trackIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No video track found in "</span> + mSourceFile);</span><br><span class="line">            &#125;</span><br><span class="line">            extractor.selectTrack(trackIndex);</span><br><span class="line"></span><br><span class="line">            MediaFormat format = extractor.getTrackFormat(trackIndex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a MediaCodec decoder, and configure it with the MediaFormat from the</span></span><br><span class="line">            <span class="comment">// extractor.  It's very important to use the format from the extractor because</span></span><br><span class="line">            <span class="comment">// it contains a copy of the CSD-0/CSD-1 codec-specific data chunks.</span></span><br><span class="line">            String mime = format.getString(MediaFormat.KEY_MIME);</span><br><span class="line">            decoder = MediaCodec.createDecoderByType(mime);</span><br><span class="line">            decoder.configure(format, mOutputSurface, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">            decoder.start();</span><br></pre></td></tr></table></figure>
<p><code>String mime = format.getString(MediaFormat.KEY_MIME);
            decoder = MediaCodec.createDecoderByType(mime);
            decoder.configure(format, mOutputSurface, null, 0);
            decoder.start();</code></p>
<p>이 부분이 MediaCodec을 생산자와 소비자의 사이에 위치 시키는 역할을 한다.</p>
<p>위치를 시킨후 실행 시키는 코드가 <code>decoder.start()</code>이다</p>
<h4 id="start"><a href="#start" class="headerlink" title="start"></a>start</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void start ()</span><br></pre></td></tr></table></figure>
<p>환경 설정이 완료 된 이후 start를 실행 하면 비로소, 비동기적으로 생산자로 부터 버퍼를 읽어서 디코딩 처리 하기 시작한다.</p>
<h4 id="Buffer얻어-오기"><a href="#Buffer얻어-오기" class="headerlink" title="Buffer얻어 오기"></a>Buffer얻어 오기</h4><h5 id="Syncronized"><a href="#Syncronized" class="headerlink" title="Syncronized"></a>Syncronized</h5><h6 id="API21-롤리팝-이후-deprecated-된-방법-grafika"><a href="#API21-롤리팝-이후-deprecated-된-방법-grafika" class="headerlink" title="API21(롤리팝) 이후 deprecated 된 방법 (grafika)"></a>API21(롤리팝) 이후 deprecated 된 방법 (grafika)</h6><p>grafika의 Movie Player는 이 방법을 사용해서 Data Stream을 접근 하고 있다.</p>
<ul>
<li><p>버퍼의 형식은 ByteBuffer[]</p>
</li>
<li><p>start() Call 이후 부터 버퍼를 얻어 오는 방식은 getInput과 OutputBuffers를 사용하는 방법이다. 양수의 buffer id를 기준으로 얻어온다.</p>
</li>
<li><p><code>dequeueInputBuffer()</code> , <code>dequeueOutputBuffer()</code>는 비동기 스레드에 상태를 확인하기 위한 api이다. 비록 Syncronized 방식이라고 해도 이점은 변하지 않는다.</p>
<blockquote>
<p>파라메터로 timeoutUs 가 사용되는데, 해당 값은 상위 상태 변화를 확인하기 위해 기다리는 시간이다. 해당 시간을 기다려도 state의 변화가 생기지 않는다면,  해당 media data는 invalidate 처리 되게 된다. timeoutUs가 0이하면 무한이 기다리게 된다. 0이면 기다리지 않고 즉각 return 처리 한다.</p>
</blockquote>
</li>
</ul>
<p><strong>MoviePlayer.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExtract</span><span class="params">(MediaExtractor extractor, <span class="keyword">int</span> trackIndex, MediaCodec decoder,</span></span></span><br><span class="line"><span class="function"><span class="params">                       FrameCallback frameCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> TIMEOUT_USEC = <span class="number">10000</span>;</span><br><span class="line">    ByteBuffer[] decoderInputBuffers = decoder.getInputBuffers();</span><br><span class="line">    <span class="keyword">int</span> inputChunk = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> firstInputTimeNsec = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> outputDone = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> inputDone = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!outputDone) &#123;</span><br><span class="line">        <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"loop"</span>);</span><br><span class="line">        <span class="keyword">if</span> (mIsStopRequested) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"Stop requested"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feed more data to the decoder.</span></span><br><span class="line">        <span class="keyword">if</span> (!inputDone) &#123;</span><br><span class="line">            <span class="keyword">int</span> inputBufIndex = decoder.dequeueInputBuffer(TIMEOUT_USEC);</span><br><span class="line">            <span class="keyword">if</span> (inputBufIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (firstInputTimeNsec == -<span class="number">1</span>) &#123;</span><br><span class="line">                    firstInputTimeNsec = System.nanoTime();</span><br><span class="line">                &#125;</span><br><span class="line">                ByteBuffer inputBuf = decoderInputBuffers[inputBufIndex];</span><br><span class="line">                <span class="comment">// Read the sample data into the ByteBuffer.  This neither respects nor</span></span><br><span class="line">                <span class="comment">// updates inputBuf's position, limit, etc.</span></span><br><span class="line">                <span class="keyword">int</span> chunkSize = extractor.readSampleData(inputBuf, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (chunkSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// End of stream -- send empty frame with EOS flag set.</span></span><br><span class="line">                    decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0L</span>,</span><br><span class="line">                            MediaCodec.BUFFER_FLAG_END_OF_STREAM);</span><br><span class="line">                    inputDone = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"sent input EOS"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (extractor.getSampleTrackIndex() != trackIndex) &#123;</span><br><span class="line">                        Log.w(TAG, <span class="string">"WEIRD: got sample from track "</span> +</span><br><span class="line">                                extractor.getSampleTrackIndex() + <span class="string">", expected "</span> + trackIndex);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">long</span> presentationTimeUs = extractor.getSampleTime();</span><br><span class="line">                    decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, chunkSize,</span><br><span class="line">                            presentationTimeUs, <span class="number">0</span> <span class="comment">/*flags*/</span>);</span><br><span class="line">                    <span class="keyword">if</span> (VERBOSE) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">"submitted frame "</span> + inputChunk + <span class="string">" to dec, size="</span> +</span><br><span class="line">                                chunkSize);</span><br><span class="line">                    &#125;</span><br><span class="line">                    inputChunk++;</span><br><span class="line">                    extractor.advance();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"input buffer not available"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!outputDone) &#123;</span><br><span class="line">            <span class="keyword">int</span> decoderStatus = decoder.dequeueOutputBuffer(mBufferInfo, TIMEOUT_USEC);</span><br><span class="line">            <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) &#123;</span><br><span class="line">                <span class="comment">// no output available yet</span></span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"no output from decoder available"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) &#123;</span><br><span class="line">                <span class="comment">// not important for us, since we're using Surface</span></span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output buffers changed"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">                MediaFormat newFormat = decoder.getOutputFormat();</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output format changed: "</span> + newFormat);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"unexpected result from decoder.dequeueOutputBuffer: "</span> +</span><br><span class="line">                                decoderStatus);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// decoderStatus &gt;= 0</span></span><br><span class="line">                <span class="keyword">if</span> (firstInputTimeNsec != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Log the delay from the first buffer of input to the first buffer</span></span><br><span class="line">                    <span class="comment">// of output.</span></span><br><span class="line">                    <span class="keyword">long</span> nowNsec = System.nanoTime();</span><br><span class="line">                    Log.d(TAG, <span class="string">"startup lag "</span> + ((nowNsec-firstInputTimeNsec) / <span class="number">1000000.0</span>) + <span class="string">" ms"</span>);</span><br><span class="line">                    firstInputTimeNsec = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">boolean</span> doLoop = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"surface decoder given buffer "</span> + decoderStatus +</span><br><span class="line">                        <span class="string">" (size="</span> + mBufferInfo.size + <span class="string">")"</span>);</span><br><span class="line">                <span class="keyword">if</span> ((mBufferInfo.flags &amp; MediaCodec.BUFFER_FLAG_END_OF_STREAM) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"output EOS"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (mLoop) &#123;</span><br><span class="line">                        doLoop = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        outputDone = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">boolean</span> doRender = (mBufferInfo.size != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// As soon as we call releaseOutputBuffer, the buffer will be forwarded</span></span><br><span class="line">                <span class="comment">// to SurfaceTexture to convert to a texture.  We can't control when it</span></span><br><span class="line">                <span class="comment">// appears on-screen, but we can manage the pace at which we release</span></span><br><span class="line">                <span class="comment">// the buffers.</span></span><br><span class="line">                <span class="keyword">if</span> (doRender &amp;&amp; frameCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    frameCallback.preRender(mBufferInfo.presentationTimeUs);</span><br><span class="line">                &#125;</span><br><span class="line">                decoder.releaseOutputBuffer(decoderStatus, doRender);</span><br><span class="line">                <span class="keyword">if</span> (doRender &amp;&amp; frameCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    frameCallback.postRender();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (doLoop) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">"Reached EOS, looping"</span>);</span><br><span class="line">                    extractor.seekTo(<span class="number">0</span>, MediaExtractor.SEEK_TO_CLOSEST_SYNC);</span><br><span class="line">                    inputDone = <span class="keyword">false</span>;</span><br><span class="line">                    decoder.flush();    <span class="comment">// reset decoder state</span></span><br><span class="line">                    frameCallback.loopReset();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이 메서드는 video가 멈추거나 끝날때 까지 루프를 돌게 된다. </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ByteBuffer[] decoderInputBuffers = decoder.getInputBuffers();</span><br></pre></td></tr></table></figure>
<p>getInputBuffers (input surface를 사용하는 경우 절대로 사용하면 안됨)</p>
<p>해당 메서드는 21이후로 더이상 사용되지 않는다. <code>getInputBuffer(int)</code>를 대신 사용한다.</p>
<p>본 메서드를 이용해서 byte stream을 읽어 오는데 일단 한번 읽어진 buffer는 재사용 되지 않는다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> inputBufIndex = decoder.dequeueInputBuffer(TIMEOUT_USEC);</span><br></pre></td></tr></table></figure>
<p>사용 가능한 데이터의 index(위치)를 알려준다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ByteBuffer inputBuf = decoderInputBuffers[inputBufIndex];</span><br></pre></td></tr></table></figure>
<p>앞서 읽어온 inputbuffer에서 사용 가능한 데이터의 index의 bytebuffer를 얻어온다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, chunkSize,</span><br><span class="line">        presentationTimeUs, <span class="number">0</span> <span class="comment">/*flags*/</span>);</span><br><span class="line">inputDone = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure>
<p>화면에 표시하기(decode) 위한 buffer를 지정한다.</p>
<p>여기서 presentationTimeUs는 이후 화면에 표시할때 나오는 timestamp와 동일 값이 된다.</p>
<p>해당 메서드를 Call 한 이후부터는 output이 가능한 단계 까지 while 문을 돌면서 기다리게 된다.</p>
<p><code>inputDone = true;</code>은 decode를 위한 버퍼를 채웠다는 flag처리이다.</p>
<p>이후 <code>outputDone</code>이 처리 되어야 한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!outputDone) &#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>바이트를 입력 했으니 이후는 입력된 바이트가 정상적으로 decode되어서 읽을 수 있으면 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> decoderStatus = decoder.dequeueOutputBuffer(mBufferInfo, TIMEOUT_USEC);</span><br></pre></td></tr></table></figure>
<p>이 부분을 확인하는 코드이다.</p>
<p>dequeueOutputBuffer</p>
<p>decoded가 완료 되었는지 여부를 확인 하는 코드로써, 다음 3가지 중 하나의 리턴을 갖게 된다.</p>
<p><code>NFO_TRY_AGAIN_LATER</code>, <code>INFO_OUTPUT_FORMAT_CHANGED</code>, <code>INFO_OUTPUT_BUFFERS_CHANGED</code></p>
<p>해당 value는 모두 음수의 값을 갖고 있다.</p>
<p>이외 양수의 값이 있다면 decode가 완료 되었다고 생각해도 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) &#123;</span><br><span class="line">    <span class="comment">// no output available yet</span></span><br><span class="line">    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"no output from decoder available"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) &#123;</span><br><span class="line">    <span class="comment">// not important for us, since we're using Surface</span></span><br><span class="line">    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output buffers changed"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">    MediaFormat newFormat = decoder.getOutputFormat();</span><br><span class="line">    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output format changed: "</span> + newFormat);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">"unexpected result from decoder.dequeueOutputBuffer: "</span> +</span><br><span class="line">                    decoderStatus);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// decoderStatus &gt;= 0</span></span><br></pre></td></tr></table></figure>
<p>decodeStatus가 양수일때 처리 하는 가능 핵심 적인 코드는 다음이다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">decoder.releaseOutputBuffer(decoderStatus, doRender);</span><br></pre></td></tr></table></figure>
<p>releaseOutputBuffer</p>
<p>output surface에 그려질 decode된 byte buffer를 돌려주는 행위를 하는 코드이다. <code>dequeueOutputBuffer</code></p>
<p>에서 지정해준 index를 기준으로 화면에 rendering을 처리하게 된다. doRender가 true이면 output surface에 최우선 적으로 데이터를 send하게 된다. 일단 해당 버퍼가 사용되고 나면 surface는 codec에게 더이상 재활용 하지 말것을 요청하게 된다.  해당 처리에 대한 결과로는 <code>MediaCodec.Callback</code>에 속해 있는 <code>onOutputBufferAvailable</code>가 trigger 된다.</p>
<p>해당 decode가 완료된 이후 surfacetexture view 쪽으로 화면의 redraw를 다음 리스너를 통해 알려준다.</p>
<p><code>TextureView.SurfaceTextureListener</code></p>
<p><strong>onSurfaceTextureUpdated</strong></p>
<p>SurfaceTexture에 있는 updateTexImage가 Call되면 이 method가 call되게 되는데, MediaCodec이 surface에 변화를 줄때마다 해당 시점을 얻어 오고 싶다면, 본 리스너를 등록 하면 된다. </p>
<p><strong>PlayMovieActivity.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureUpdated</span><span class="params">(SurfaceTexture surface)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Matrix txform = <span class="keyword">new</span> Matrix();</span><br><span class="line">    mTextureView.getTransform(txform);</span><br><span class="line">    mRotateValue %= <span class="number">360</span>;</span><br><span class="line">    txform.postRotate(mRotateValue += <span class="number">1</span>);</span><br><span class="line">    mTextureView.setTransform(txform);</span><br><span class="line">    Log.d(TAG, <span class="string">"onSurfaceTextureUpdated = "</span> + mRotateValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>grafika 에서는 <code>adjustAspectRatio</code>라는 메서드를 통해서 동영상의 비율을 조정하게 되는데, 해당 코드의 일부분을 상위와 같이 <code>onSurfaceTextureUpdated</code>에 넣게 되면 동영상이 돌아가는 모습을 확인 할 수있게 된다.</p>
<p>Surface에 대한 수정을 처리 하고 싶을 때는 <code>onSurfaceTextureAvailable</code>이나 <code>onSurfaceTextureUpdated</code>시점에 처리 해주면 된다.</p>
<p>만약 송출되는 Surface의 화면을 mirror(flip) 처리 하고자 한다면 PlayMovieActivity 내 <code>adjustAspectRatio</code>메서드 마지막에 <code>mTextureView.setScaleX(-1);</code> 처리를 하면 된다. </p>
<blockquote>
<p>Matrix의 setScale(-1,1)을 통한 flip은 성공하지 못했다.</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://theyoung.github.io/android-graphic-architecture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="whoami">
      <meta itemprop="description" content="my note">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Try Again">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/android-graphic-architecture/" class="post-title-link" itemprop="url">android graphic architecture</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-16 18:37:40" itemprop="dateCreated datePublished" datetime="2019-04-16T18:37:40Z">2019-04-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-04 02:25:46" itemprop="dateModified" datetime="2019-07-04T02:25:46Z">2019-07-04</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/android-graphic-architecture/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="android-graphic-architecture/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="BufferQueue"><a href="#BufferQueue" class="headerlink" title="BufferQueue"></a>BufferQueue</h3><p>그래픽 데이터의 생산자와 소비자를 연결 수켜주는 역할을 한다. (프로세스가 서로 달라도 된다.)</p>
<p>생산자는 버퍼 특징을 기술한다.</p>
<ul>
<li>높이, 넓이, 픽셀포맷, 플래그 등</li>
</ul>
<p>Data Flow</p>
<ul>
<li>dequeBuffer</li>
<li>생상자 버퍼 채움</li>
<li>queueBuffer</li>
<li>소비사 버퍼 획득</li>
<li>acquireBuffer</li>
<li>버퍼 활용</li>
<li>releaseBuffer</li>
</ul>
<h3 id="gralloc-HAL"><a href="#gralloc-HAL" class="headerlink" title="gralloc HAL"></a>gralloc HAL</h3><p>allock함수를 이용해 버퍼를 할당한다.</p>
<ul>
<li>넓이,높이,픽셀포맷, 용도 플래그가 인자</li>
</ul>
<p>예) RGBA8888 픽셀 포멧의 경우 R-&gt;G-&gt;B-&gt;A 순서로 4바이트 버퍼를 생성한다. </p>
<h3 id="SurfaceFlinger"><a href="#SurfaceFlinger" class="headerlink" title="SurfaceFlinger"></a>SurfaceFlinger</h3><p>그래픽 데어터 버퍼를 받고 Display로 보내는 목적</p>
<ul>
<li>앱 포어그라운드 -&gt; 윈도우매니저 -&gt; surfaceflinger -&gt; draw 요청</li>
</ul>
<p>BufferQueue의 소비자 처럼 동작한다.</p>
<ul>
<li>생산자 -&gt; 바인더객체 -&gt; 윈도우매니저 -&gt; 앱 -&gt; surfaceflinger 프레임전송<br>showSoftInput<br>해당 기능은 디스플레이가 버퍼 처리가능할 때 작동이 시작된다.</li>
</ul>
<h3 id="프레임렌더링-구조"><a href="#프레임렌더링-구조" class="headerlink" title="프레임렌더링 구조"></a>프레임렌더링 구조</h3><p>생산자 -&gt; 버퍼를 채움 -&gt; 버퍼큐 채움 -&gt; surfacelinger 쪽으로 이동 -&gt; HWcomposer로 다음 frame 전송 -&gt; HWComposer는 Systemui(상태바등)와 bufferqueu 정보를 합쳐서 화면에 표시함 (VSYNC 발생 시 frame 그림)</p>
<p>app -&gt; MediaCodec -&gt; raw데이터 버퍼 또는 Surface제공</p>
<h3 id="Surface"><a href="#Surface" class="headerlink" title="Surface"></a>Surface</h3><p>BufferQueue의 생산자 역할</p>
<p>SurfaceFlinger는 Bufferqueue의 소비자 역할</p>
<p><code>dumpsys SurfaceFlinger</code>명령을 통해 레이어와 연관된 버퍼 정보를 확인 가능</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Build configuration: [sf] [libui] [libgui]</span><br><span class="line">Sync configuration: [using: EGL_ANDROID_native_fence_sync EGL_KHR_wait_sync]</span><br><span class="line">DispSync configuration: app phase 0 ns, sf phase 0 ns, present offset 0 ns (refresh 16666666 ns)</span><br><span class="line">Visible layers (count = 6)</span><br><span class="line">+ LayerDim 0x9203b000 (DimLayer)</span><br><span class="line">  Region transparentRegion (this=0x9203b178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x9203b008, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(  16,  16), crop=(   0,   0,  -1,  -1), isOpaque=0, invalidate=0, alpha=0xff, flags=0x00000001, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x954391c0</span><br><span class="line">      format= 0, activeBuffer=[   0x   0:   0,  0], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=4 mCurrentTexture=-1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1x1], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">+ LayerDim 0x92023000 (DimLayer)</span><br><span class="line">  Region transparentRegion (this=0x92023178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x92023008, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(  16,  16), crop=(   0,   0,  -1,  -1), isOpaque=0, invalidate=0, alpha=0xff, flags=0x00000001, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x954391c0</span><br><span class="line">      format= 0, activeBuffer=[   0x   0:   0,  0], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=5 mCurrentTexture=-1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1x1], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">+ LayerDim 0x963ba000 (DimLayer)</span><br><span class="line">  Region transparentRegion (this=0x963ba178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x963ba008, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(  16,  16), crop=(   0,   0,  -1,  -1), isOpaque=0, invalidate=0, alpha=0xff, flags=0x00000001, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x954391c0</span><br><span class="line">      format= 0, activeBuffer=[   0x   0:   0,  0], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=7 mCurrentTexture=-1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1x1], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">+ LayerDim 0x92021000 (DimLayer)</span><br><span class="line">  Region transparentRegion (this=0x92021178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x92021008, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(  16,  16), crop=(   0,   0,  -1,  -1), isOpaque=0, invalidate=0, alpha=0xff, flags=0x00000001, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x954391c0</span><br><span class="line">      format= 0, activeBuffer=[   0x   0:   0,  0], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=8 mCurrentTexture=-1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1x1], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">+ Layer 0x92019000 (com.example /com.example.MainActivity)</span><br><span class="line">  Region transparentRegion (this=0x92019178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x92019008, count=1)</span><br><span class="line">    [  0,   0, 1920, 1080]</span><br><span class="line">      layerStack=   0, z=    21005, pos=(0,0), size=(1920,1080), crop=(   0,   0,1920,1080), isOpaque=1, invalidate=0, alpha=0xff, flags=0x00000002, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x96074440</span><br><span class="line">      format= 1, activeBuffer=[1920x1080:1920,  1], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=9 mCurrentTexture=1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1920x1080], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">             [00:0x9606d980] state=FREE    , 0x96087380 [1920x1080:1920,  1]</span><br><span class="line">            &gt;[01:0x9606da20] state=ACQUIRED, 0x96087440 [1920x1080:1920,  1]</span><br><span class="line">             [02:0x9606dac0] state=FREE    , 0x96087500 [1920x1080:1920,  1]</span><br><span class="line">+ Layer 0x9203d000 (FocusedStackFrame)</span><br><span class="line">  Region transparentRegion (this=0x9203d178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x9203d008, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">      layerStack=   0, z=    21006, pos=(0,0), size=(   1,   1), crop=(   0,   0,  -1,  -1), isOpaque=0, invalidate=0, alpha=0x4d, flags=0x00000001, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x954391c0</span><br><span class="line">      format= 1, activeBuffer=[   0x   0:   0,  0], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=3 mCurrentTexture=-1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1x1], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">Displays (1 entries)</span><br><span class="line">+ DisplayDevice: Built-in Screen</span><br><span class="line">   <span class="built_in">type</span>=0, hwcId=0, layerStack=0, (1920x1080), ANativeWindow=0x96225408, orient= 0 (<span class="built_in">type</span>=00000000), flips=159, isSecure=1, secureVis=0, powerMode=2, activeConfig=0, numLayers=1</span><br><span class="line">   v:[0,0,1920,1080], f:[0,0,1920,1080], s:[0,0,1920,1080],transform:[[1.000,0.000,-0.000][0.000,1.000,-0.000][0.000,0.000,1.000]]</span><br><span class="line">mAbandoned=0</span><br><span class="line">-BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1920x1080], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line"> [00:0x9606d3e0] state=FREE    , 0x96086780 [1920x1080:1920,  1]</span><br><span class="line"> [01:0x9606d480] state=FREE    , 0x96086840 [1920x1080:1920,  1]</span><br><span class="line">&gt;[02:0x9606d520] state=ACQUIRED, 0x96086900 [1920x1080:1920,  1]</span><br><span class="line">SurfaceFlinger global state:</span><br><span class="line">EGL implementation : 1.4 Midgard-<span class="string">"r8p0-02rel0"</span></span><br><span class="line"> EGL_ANDROID_image_native_buffer EGL_ANDROID_recordable EGL_ANDROID_native_fence_sync EGL_ANDROID_framebuffer_target EGL_ANDROID_blob_cache EGL_KHR_partial_update EGL_KHR_config_attribs EGL_KHR_image EGL_KHR_image_base EGL_KHR_fence_sync EGL_KHR_wait_sync EGL_KHR_gl_colorspace EGL_KHR_get_all_proc_addresses EGL_IMG_context_priority EGL_KHR_gl_texture_2D_image EGL_KHR_gl_renderbuffer_image EGL_KHR_create_context EGL_KHR_surfaceless_context EGL_KHR_gl_texture_cubemap_image EGL_EXT_create_context_robustness</span><br><span class="line">GLES: ARM, Mali-T720, OpenGL ES 3.1 v1.r8p0-02rel0.b25106f7a00abf0fd922cfe23b51206f</span><br><span class="line">GL_EXT_debug_marker GL_ARM_rgba8 GL_ARM_mali_shader_binary GL_OES_depth24 GL_OES_depth_texture GL_OES_depth_texture_cube_map GL_OES_packed_depth_stencil GL_OES_rgb8_rgba8 GL_EXT_read_format_bgra GL_OES_compressed_paletted_texture GL_OES_compressed_ETC1_RGB8_texture GL_OES_standard_derivatives GL_OES_EGL_image GL_OES_EGL_image_external GL_OES_EGL_sync GL_OES_texture_npot GL_OES_vertex_half_float GL_OES_required_internalformat GL_OES_vertex_array_object GL_OES_mapbuffer GL_EXT_texture_format_BGRA8888 GL_EXT_texture_rg GL_EXT_texture_type_2_10_10_10_REV GL_OES_fbo_render_mipmap GL_OES_element_index_uint GL_EXT_shadow_samplers GL_OES_texture_compression_astc GL_KHR_texture_compression_astc_ldr GL_KHR_texture_compression_astc_hdr GL_KHR_debug GL_EXT_occlusion_query_boolean GL_EXT_disjoint_timer_query GL_EXT_blend_minmax GL_EXT_discard_framebuffer GL_OES_get_program_binary GL_OES_texture_3D GL_EXT_texture_storage GL_EXT_multisampled_render_to_texture GL_OES_surfaceless_context GL_OES_texture_stencil8 GL_EXT_shader_pixel_local_storage GL_ARM_shader_framebuffer_fetch GL_ARM_shader_framebuffer_fetch_depth_stencil GL_ARM_mali_program_binary GL_EXT_sRGB GL_EXT_sRGB_write_control GL_EXT_texture_sRGB_decode GL_KHR_blend_equation_advanced GL_KHR_blend_equation_advanced_coherent GL_OES_texture_storage_multisample_2d_array GL_OES_shader_image_atomic GL_EXT_robustness GL_EXT_texture_border_clamp GL_OES_texture_border_clamp GL_EXT_texture_cube_map_array GL_OES_texture_cube_map_array GL_OES_sample_variables GL_OES_sample_shading GL_OES_shader_multisample_interpolation GL_EXT_shader_io_blocks GL_OES_shader_io_blocks GL_EXT_gpu_shader5 GL_OES_gpu_shader5 GL_EXT_texture_buffer GL_OES_texture_buffer GL_EXT_copy_image GL_OES_copy_image</span><br><span class="line">  Region undefinedRegion (this=0x960b352c, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  orientation=0, isDisplayOn=1</span><br><span class="line">  last eglSwapBuffers() time: 7657.042000 us</span><br><span class="line">  last transaction time     : 180.167000 us</span><br><span class="line">  transaction-flags         : 00000000</span><br><span class="line">  refresh-rate              : 60.000002 fps</span><br><span class="line">  x-dpi                     : 159.895004</span><br><span class="line">  y-dpi                     : 160.421005</span><br><span class="line">  gpu_to_cpu_unsupported    : 0</span><br><span class="line">  eglSwapBuffers time: 0.000000 us</span><br><span class="line">  transaction time: 0.000000 us</span><br><span class="line">VSYNC state: disabled</span><br><span class="line">  soft-vsync: disabled</span><br><span class="line">  numListeners=9,</span><br><span class="line">  events-delivered: 297</span><br><span class="line">    0x9544c038: count=-1</span><br><span class="line">    0x9544c060: count=-1</span><br><span class="line">    0x9544c088: count=-1</span><br><span class="line">    0x9544c0b0: count=-1</span><br><span class="line">    0x96038b78: count=-1</span><br><span class="line">    0x96038ba0: count=-1</span><br><span class="line">    0x96038bf0: count=-1</span><br><span class="line">    0x96038f38: count=-1</span><br><span class="line">    0x96038f60: count=-1</span><br><span class="line">h/w composer state:</span><br><span class="line">  h/w composer present and enabled</span><br><span class="line">Hardware Composer state (version 01010000):</span><br><span class="line">  mDebugForceFakeVSync=0</span><br><span class="line">  Display[0] configurations (* current):</span><br><span class="line">    * 0: 1920x1080, xdpi=159.895004, ydpi=160.421005, refresh=16666666</span><br><span class="line">  numHwLayers=2, flags=00000000</span><br><span class="line">    <span class="built_in">type</span>   |  handle  | hint | flag | tr | blnd |   format    |     <span class="built_in">source</span> crop (l,t,r,b)      |          frame         | name</span><br><span class="line">-----------+----------+------+------+----+------+-------------+--------------------------------+------------------------+------</span><br><span class="line">       HWC | 96087440 | 0000 | 0000 | 00 | 0100 | RGBA_8888   |      0,      0,   1920,   1080 |    0,    0, 1920, 1080 | com.example /com.example</span><br><span class="line"> FB TARGET | 96086900 | 0000 | 0000 | 00 | 0105 | RGBA_8888   |      0,      0,   1920,   1080 |    0,    0, 1920, 1080 | HWC_FRAMEBUFFER_TARGET</span><br><span class="line">Allocated buffers:</span><br><span class="line">0x96086780: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00001a00</span><br><span class="line">0x96086840: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00001a00</span><br><span class="line">0x96086900: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00001a00</span><br><span class="line">0x96087380: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00000b00</span><br><span class="line">0x96087440: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00000b00</span><br><span class="line">0x96087500: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00000b00</span><br><span class="line">Total allocated (estimate): 48600.00 KB</span><br></pre></td></tr></table></figure>
<h3 id="Canvas-Rendering"><a href="#Canvas-Rendering" class="headerlink" title="Canvas Rendering"></a>Canvas Rendering</h3><ul>
<li>Skia Graphics Library : 렌더링 로우레밸 처리</li>
</ul>
<p>Skia는 바이트를 버퍼의 형태로 구성기 위해 그리고 멀티 클라이언트에 의한 동시 업데이트를 방지하기 위해, 버퍼 액세스 락을 사용한다.</p>
<ul>
<li><p>lockCanvas() : 버퍼에 락을 걸고 드로잉을 위한 Canvas를 리턴</p>
</li>
<li><p>unlockCanvasAndPost() :버퍼에 락을 해제 하고 compositor로 전달</p>
</li>
</ul>
<p>하드웨어 가속 Canvas API (OpenGL ES 지원을 위함)</p>
<ul>
<li>View onDraw Canvas : 하드웨어 가속 가능</li>
<li>APP이 직접 lockCanvas()를 통해 캠버스(surface)를 얻어 오는 것과는 다름 : 사용자 lock Canvas 기반 CPU랜더러는 GLES로 Surface드로잉을 할 수 없거나 비디오 디코더에 출력된 프레임을 보낼 수 없다.</li>
<li>Canvas를 사용하지 않고 Surface에 직접 드로잉 하는 주요 방법은 OpenGL ES를 사용하면 됨</li>
</ul>
<h3 id="SurfaceHolder"><a href="#SurfaceHolder" class="headerlink" title="SurfaceHolder"></a>SurfaceHolder</h3><p>surface와 관련된 작업은 surfaceHolder와 surfaceView가 필요함</p>
<ul>
<li>surface : compositor에 관리 되는 버퍼</li>
<li>surfaceholder : 앱에 의해 관리되고 surface의 크기나 포맷같은 고수준 정보를 관리</li>
</ul>
<p>view와 관련된 작업은 surfaceholder를 포함하고, MediaCodec같은 API들은 surface상에서 동작한다. Surface는 surfacehoder를 통해 얻을 수 있다. surface의 설정 정보들을 얻고자 하면 surfacehoder를 통해 구하면 된다. </p>
<h3 id="SurfaceView"><a href="#SurfaceView" class="headerlink" title="SurfaceView"></a>SurfaceView</h3><p>Surface + View</p>
<p>surfaceview -&gt; 투명 -&gt; view컴포넌트 시각화 시작 -&gt; windowmanager -&gt; sufaceflinger가 surface생성 요청</p>
<blockquote>
<p>비동기적 작동으로 surface생성 완료시 callback처리 해야한다</p>
</blockquote>
<p>새로운 sruface는 보이지 않는 영역에 생김, z ordering을 통해 상위로 올려야함</p>
<blockquote>
<p>view 펀칭을 통한 화면 제공 방식이다. &quot;surfaceview -&gt; window -&gt; surface -&gt; 사용자 눈&quot; 이라고 했을때 window에 fixed된 창을 뚫는 방식이다.</p>
<p>이런 방식으로 인해 SurfaceView는 </p>
<ul>
<li>transformation, animation 등의 처리가 불가능하다.</li>
</ul>
</blockquote>
<h3 id="SurfaceTexture"><a href="#SurfaceTexture" class="headerlink" title="SurfaceTexture"></a>SurfaceTexture</h3><p>Surface + GLES Texture 조합</p>
<p>SurfaceTexture생성 -&gt; BufferQueue 생성 -&gt; 생상자 SurfaceTexture 생성 -&gt; Bufferqueue 인큐  -&gt; onFrameAvailable() 통지 -&gt; updateTexImage 메서드 호출 -&gt; bufferqueue 버퍼 얻음 </p>
<ul>
<li>getTimestamp() : timestamp 정보</li>
<li>getTransformMatrix : 가자 최근 호출된 updateTexImage()메서드 설정된 변환 행렬()</li>
<li>변환행렬 : 잘못된 소스데이터를 보정 가능</li>
<li>timestamp : 카메라 코드에 의해 설정되며 프레임이 캡처될때 기준으로 리턴된다.</li>
</ul>
<blockquote>
<p>surfaceview와는 다르게 view 그룹의 하이어러키에 포함된다. (surfaceview의 rendering은 다른 view 그룹의 랜더링과 독립으로 처리 되는것으로 보인다.) 그렇기에 surfacetexture는 </p>
<ul>
<li>transformation, animation 처리 등이 가능하다</li>
<li>그러나 memory 사용량이 상대적으로 높고, 해당 surface의 redraw가 해당 그룹 전체의 redraw에 영향을 줄수 있다.</li>
<li>video player를 개발하게 되면 사실상 surfacetexture를 사용할 수 밖에 없는데 fullscreen mode가 전제 된다면 surfaceview를 사용하는 것이 좋다(drm contents는 surfaceview 사용 권장)</li>
</ul>
</blockquote>
<p>해당 컴포넌트는 반듯이 하드웨어 렌더링을 지원해야 한다.</p>
<h3 id="TextureView"><a href="#TextureView" class="headerlink" title="TextureView"></a>TextureView</h3><p>View + SurfaceTexture</p>
<p>TextureView는 SurfaceTexture를 wrap하고 있음</p>
<ul>
<li>SurfaceTexture Callback 응답처리, 신규 버퍼 획득 처리 역할</li>
<li>View invalidate 요청 : 신규 버퍼 수신 시</li>
</ul>
<ul>
<li>장점 : View 계층 구조에 소속되어 동작, 다른 View와 동일, API 임의 변환 수행 및 비트맵을 컨텐츠로 로드가능</li>
<li>단점 : 합성 단계 성능, View 합성이 GLES로 수행되고 다른 View 요소들의 리드로잉을 발생 시킴. Video 처리 등을 위해서는 SurfaceView가 더 좋은 성능을 제공 (DRM Contents는 SurfaceView로만 구현 가능)</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/apple-touch-icon-next.png" alt="whoami">
            
              <p class="site-author-name" itemprop="name">whoami</p>
              <div class="site-description motion-element" itemprop="description">my note</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">45</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZXlvdW5nL3RoZXlvdW5nLmdpdGh1Yi5pbw==" title="GitHub &rarr; https://github.com/theyoung/theyoung.github.io"><i class="fa fa-fw fa-github"></i></span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="bWFpbHRvOnN1cHBvcnRAdGhleW91bmcyMDAyQG5hdmVyLmNvbQ==" title="E-Mail &rarr; mailto:support@theyoung2002@naver.com"><i class="fa fa-fw fa-envelope"></i></span>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
             </div>
          

          
          

          
            
          
          

        </div>
      </div>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NexT</span>

  

  
</div>


  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span> v7.0.1</div>



  <div class="footer-custom">Theme source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0">here</span><br>Website source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=">here</span></div>


        








        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>







  




















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>




  

  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  
  <script src="/js/src/exturl.js?v=7.0.1"></script>


  

  
  
  <script id="dsq-count-scr" src="https://https-theyoung-github-io.disqus.com/count.js" async></script>







  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
  

  


  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
