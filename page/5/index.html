<!DOCTYPE html>













<html class="theme-next gemini" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">














  <meta name="yandex-verification" content="3ac9ae36ddebb425">













<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"onmobile":true},
    back2top: true,
    back2top_sidebar: true,
    fancybox: false,
    fastclick: false,
    lazyload: true,
    tabs: true,
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="keywords" content="coding,software">
<meta property="og:type" content="website">
<meta property="og:title" content="Try Again">
<meta property="og:url" content="https://theyoung.github.io/page/5/index.html">
<meta property="og:site_name" content="Try Again">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Try Again">






  <link rel="canonical" href="https://theyoung.github.io/page/5/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Try Again – anything</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  

  <div class="container 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Try Again</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">anything</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-news">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-bullhorn"></i> <br>News</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">24</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://theyoung.github.io/grafika/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="whoami">
      <meta itemprop="description" content="my note">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Try Again">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/grafika/" class="post-title-link" itemprop="url">Android Grafika Texture Surface</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-19 19:32:33" itemprop="dateCreated datePublished" datetime="2019-04-19T19:32:33Z">2019-04-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-04 02:25:46" itemprop="dateModified" datetime="2019-07-04T02:25:46Z">2019-07-04</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/grafika/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="grafika/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="테스트-mp4파일-받기"><a href="#테스트-mp4파일-받기" class="headerlink" title="테스트 mp4파일 받기"></a>테스트 mp4파일 받기</h3><p>com.android.grafika</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">    public static void initialize(Context context) &#123;</span><br><span class="line">        ContentManager mgr = getInstance();</span><br><span class="line">        synchronized (sLock) &#123;</span><br><span class="line">            if (!mgr.mInitialized) &#123;</span><br><span class="line"><span class="addition">+                mgr.mFilesDir = context.getExternalFilesDir(Environment.DIRECTORY_MOVIES);</span></span><br><span class="line"><span class="deletion">- //                mgr.mFilesDir = context.getFilesDir();</span></span><br><span class="line">                mgr.mContent = new ArrayList&lt;Content&gt;();</span><br><span class="line">                mgr.mInitialized = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>app 인터널 storage를 external로 변경</p>
<p>앱 재실행 후 파일 다운로드 표시 끝나면 android file explore를 이용해서 </p>
<p><code>sdcard&gt; Android &gt; data &gt; com.google.grafica &gt; files &gt; Movies</code></p>
<p>이하를 조회하면,</p>
<ul>
<li>gen-eight-rects.mp4</li>
<li>gen-sliders.mp4</li>
</ul>
<p>파일 확인 가능함</p>
<h3 id="MediaFormat"><a href="#MediaFormat" class="headerlink" title="MediaFormat"></a>MediaFormat</h3><p>비디오 파일(예, mp4)등의 header를 분석한 결과 <code>MediaExtractor</code>를 통해서 정보를 추출할 수 있음</p>
<p>아래 소스는 android app 내의 res&gt;raw 이하에 비디오나 오디오 파일을 위치 시켰을 때 uri 방식으로 수신 할 수 있는 코드이다.</p>
<p>관련 수정사항은 <code>extractor.setDataSource(ctx,uri,null);</code> 이 부분 전후를 보면 된다.</p>
<p>해당 메서드를 요청하는 방법은 Activity에서 아래와 같이 call 하면 된다</p>
<p><code>player = new MoviePlayer(getApplicationContext(), Uri.parse(&quot;android.resource://&quot;+getPackageName()+&quot;/raw/gen_eight_rects&quot;), surface, callback);</code></p>
<p><strong>MoviePlayer.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MoviePlayer</span><span class="params">(Context ctx, Uri uri, Surface outputSurface, FrameCallback frameCallback)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        mContext = ctx;</span><br><span class="line">        mUri = uri;</span><br><span class="line"><span class="comment">//        mSourceFile = sourceFile;</span></span><br><span class="line">        mOutputSurface = outputSurface;</span><br><span class="line">        mFrameCallback = frameCallback;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pop the file open and pull out the video characteristics.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> consider leaving the extractor open.  Should be able to just seek back to</span></span><br><span class="line">        <span class="comment">//       the start after each iteration of play.  Need to rearrange the API a bit --</span></span><br><span class="line">        <span class="comment">//       currently play() is taking an all-in-one open+work+release approach.</span></span><br><span class="line">        MediaExtractor extractor = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line">            extractor.setDataSource(ctx,uri,<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">int</span> trackIndex = selectTrack(extractor);</span><br><span class="line">            <span class="keyword">if</span> (trackIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No video track found in "</span> + mSourceFile);</span><br><span class="line">            &#125;</span><br><span class="line">            extractor.selectTrack(trackIndex);</span><br><span class="line"></span><br><span class="line">            MediaFormat format = extractor.getTrackFormat(trackIndex);</span><br><span class="line">            mVideoWidth = format.getInteger(MediaFormat.KEY_WIDTH);</span><br><span class="line">            mVideoHeight = format.getInteger(MediaFormat.KEY_HEIGHT);</span><br><span class="line">            <span class="keyword">if</span> (VERBOSE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"Video size is "</span> + mVideoWidth + <span class="string">"x"</span> + mVideoHeight);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (extractor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                extractor.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the width, in pixels, of the video.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVideoWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mVideoWidth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the height, in pixels, of the video.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVideoHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mVideoHeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the loop mode.  If true, playback will loop forever.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoopMode</span><span class="params">(<span class="keyword">boolean</span> loopMode)</span> </span>&#123;</span><br><span class="line">        mLoop = loopMode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Asks the player to stop.  Returns without waiting for playback to halt.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Called from arbitrary thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mIsStopRequested = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decodes the video stream, sending frames to the surface.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Does not return until video playback is complete, or we get a "stop" signal from</span></span><br><span class="line"><span class="comment">     * frameCallback.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        MediaExtractor extractor = <span class="keyword">null</span>;</span><br><span class="line">        MediaCodec decoder = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> fileBased = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// The MediaExtractor error messages aren't very useful.  Check to see if the input</span></span><br><span class="line">        <span class="comment">// file exists so we can throw a better one if it's not there.</span></span><br><span class="line">        <span class="keyword">if</span> (mSourceFile != <span class="keyword">null</span> &amp;&amp; !mSourceFile.canRead()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"Unable to read "</span> + mSourceFile);</span><br><span class="line">        &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">            fileBased = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line"><span class="comment">//            extractor.setDataSource(mSourceFile.toString());</span></span><br><span class="line">            extractor.setDataSource(mContext,mUri,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> trackIndex = selectTrack(extractor);</span><br><span class="line">            <span class="keyword">if</span> (trackIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No video track found in "</span> + mSourceFile);</span><br><span class="line">            &#125;</span><br><span class="line">            extractor.selectTrack(trackIndex);</span><br><span class="line"></span><br><span class="line">            MediaFormat format = extractor.getTrackFormat(trackIndex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a MediaCodec decoder, and configure it with the MediaFormat from the</span></span><br><span class="line">            <span class="comment">// extractor.  It's very important to use the format from the extractor because</span></span><br><span class="line">            <span class="comment">// it contains a copy of the CSD-0/CSD-1 codec-specific data chunks.</span></span><br><span class="line">            String mime = format.getString(MediaFormat.KEY_MIME);</span><br><span class="line">            decoder = MediaCodec.createDecoderByType(mime);</span><br><span class="line">            decoder.configure(format, mOutputSurface, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">            decoder.start();</span><br><span class="line"></span><br><span class="line">            doExtract(extractor, trackIndex, decoder, mFrameCallback);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// release everything we grabbed</span></span><br><span class="line">            <span class="keyword">if</span> (decoder != <span class="keyword">null</span>) &#123;</span><br><span class="line">                decoder.stop();</span><br><span class="line">                decoder.release();</span><br><span class="line">                decoder = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (extractor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                extractor.release();</span><br><span class="line">                extractor = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>MediaFormat format = extractor.getTrackFormat(trackIndex);</code>이 부분이 track 으로 부터 Media의 정보를 얻어오는 부분이다. </p>
<h4 id="Audio-Video-공통-포멧-정보"><a href="#Audio-Video-공통-포멧-정보" class="headerlink" title="Audio / Video 공통 포멧 정보"></a>Audio / Video 공통 포멧 정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Value Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>KEY_MIME</code></td>
<td style="text-align:left">String</td>
<td style="text-align:left">The type of the format.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_MAX_INPUT_SIZE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional, maximum size of a buffer of input data</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_BIT_RATE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, desired bitrate in bits/second</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Video-포멧-정보"><a href="#Video-포멧-정보" class="headerlink" title="Video 포멧 정보"></a>Video 포멧 정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Value Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>KEY_WIDTH</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_HEIGHT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_COLOR_FORMAT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">set by the user for encoders, readable in the output format of decoders</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_FRAME_RATE</code></td>
<td style="text-align:left">Integer or Float</td>
<td style="text-align:left">required for <strong>encoders</strong>, optional for <strong>decoders</strong></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_CAPTURE_RATE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_I_FRAME_INTERVAL</code></td>
<td style="text-align:left">Integer (or Float)</td>
<td style="text-align:left"><strong>encoder-only</strong>, time-interval between key frames. Float support added in <code>Build.VERSION_CODES.N_MR1</code></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_INTRA_REFRESH_PERIOD</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_LATENCY</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_MAX_WIDTH</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, max-resolution width</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_MAX_HEIGHT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, max-resolution height</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_REPEAT_PREVIOUS_FRAME_AFTER</code></td>
<td style="text-align:left">Long</td>
<td style="text-align:left"><strong>encoder in surface-mode only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_PUSH_BLANK_BUFFERS_ON_STOP</code></td>
<td style="text-align:left">Integer(1)</td>
<td style="text-align:left"><strong>decoder rendering to a surface only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_TEMPORAL_LAYERING</code></td>
<td style="text-align:left">String</td>
<td style="text-align:left"><strong>encoder only</strong>, optional, temporal-layering schema</td>
</tr>
</tbody>
</table>
</div>
<h4 id="오디오-포멧정보"><a href="#오디오-포멧정보" class="headerlink" title="오디오 포멧정보"></a>오디오 포멧정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Value Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>KEY_CHANNEL_COUNT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_SAMPLE_RATE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_PCM_ENCODING</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_IS_ADTS</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional, if <em>decoding</em> AAC audio content, setting this key to 1 indicates that each audio frame is prefixed by the ADTS header.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_PROFILE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional, if content is AAC audio, specifies the desired profile.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_SBR_MODE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional, if content is AAC audio, specifies the desired SBR mode.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_TARGET_REFERENCE_LEVEL</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the target reference level.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_ENCODED_TARGET_LEVEL</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the target reference level used at encoder.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_BOOST_FACTOR</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the DRC boost factor.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_ATTENUATION_FACTOR</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the DRC attenuation factor.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_HEAVY_COMPRESSION</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies whether to use heavy compression.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_MAX_OUTPUT_CHANNEL_COUNT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the maximum number of channels the decoder outputs.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_EFFECT_TYPE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the MPEG-D DRC effect type to use.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_CHANNEL_MASK</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional, a mask of audio channel assignments</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_FLAC_COMPRESSION_LEVEL</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional, if content is FLAC audio, specifies the desired compression level.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="자막정보"><a href="#자막정보" class="headerlink" title="자막정보"></a>자막정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Name</th>
<th>Value Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>KEY_MIME</code></td>
<td>String</td>
<td>The type of the format.</td>
</tr>
<tr>
<td><code>KEY_LANGUAGE</code></td>
<td>String</td>
<td>The language of the content.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="이미지-정보"><a href="#이미지-정보" class="headerlink" title="이미지 정보"></a>이미지 정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Name</th>
<th>Value Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>KEY_MIME</code></td>
<td>String</td>
<td>The type of the format.</td>
</tr>
<tr>
<td><code>KEY_WIDTH</code></td>
<td>Integer</td>
<td></td>
</tr>
<tr>
<td><code>KEY_HEIGHT</code></td>
<td>Integer</td>
<td></td>
</tr>
<tr>
<td><code>KEY_COLOR_FORMAT</code></td>
<td>Integer</td>
<td>set by the user for encoders, readable in the output format of decoders</td>
</tr>
<tr>
<td><code>KEY_TILE_WIDTH</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
<tr>
<td><code>KEY_TILE_HEIGHT</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
<tr>
<td><code>KEY_GRID_ROWS</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
<tr>
<td><code>KEY_GRID_COLUMNS</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
</tbody>
</table>
</div>
<h3 id="MediaCodec"><a href="#MediaCodec" class="headerlink" title="MediaCodec"></a>MediaCodec</h3><p>미디어 코덱은 미디어 데이터의 제공자와 미디어 데이터를 소비하는 소비자의 중간에 위치하는 존재이다.</p>
<p>즉,</p>
<p>(미디어 데이터 제공자) --(encoded data stream)--&gt; <strong>[MediaCodec]</strong> --(decoded data stream) --&gt;(소비자) </p>
<p>형태로 나타나게 된다.</p>
<p>MoviePalyer 소스 코드를 보자면</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        MediaExtractor extractor = <span class="keyword">null</span>;</span><br><span class="line">        MediaCodec decoder = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> fileBased = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// The MediaExtractor error messages aren't very useful.  Check to see if the input</span></span><br><span class="line">        <span class="comment">// file exists so we can throw a better one if it's not there.</span></span><br><span class="line">        <span class="keyword">if</span> (mSourceFile != <span class="keyword">null</span> &amp;&amp; !mSourceFile.canRead()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"Unable to read "</span> + mSourceFile);</span><br><span class="line">        &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">            fileBased = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line"><span class="comment">//            extractor.setDataSource(mSourceFile.toString());</span></span><br><span class="line">            extractor.setDataSource(mContext,mUri,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> trackIndex = selectTrack(extractor);</span><br><span class="line">            <span class="keyword">if</span> (trackIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No video track found in "</span> + mSourceFile);</span><br><span class="line">            &#125;</span><br><span class="line">            extractor.selectTrack(trackIndex);</span><br><span class="line"></span><br><span class="line">            MediaFormat format = extractor.getTrackFormat(trackIndex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a MediaCodec decoder, and configure it with the MediaFormat from the</span></span><br><span class="line">            <span class="comment">// extractor.  It's very important to use the format from the extractor because</span></span><br><span class="line">            <span class="comment">// it contains a copy of the CSD-0/CSD-1 codec-specific data chunks.</span></span><br><span class="line">            String mime = format.getString(MediaFormat.KEY_MIME);</span><br><span class="line">            decoder = MediaCodec.createDecoderByType(mime);</span><br><span class="line">            decoder.configure(format, mOutputSurface, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">            decoder.start();</span><br></pre></td></tr></table></figure>
<p><code>String mime = format.getString(MediaFormat.KEY_MIME);
            decoder = MediaCodec.createDecoderByType(mime);
            decoder.configure(format, mOutputSurface, null, 0);
            decoder.start();</code></p>
<p>이 부분이 MediaCodec을 생산자와 소비자의 사이에 위치 시키는 역할을 한다.</p>
<p>위치를 시킨후 실행 시키는 코드가 <code>decoder.start()</code>이다</p>
<h4 id="start"><a href="#start" class="headerlink" title="start"></a>start</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void start ()</span><br></pre></td></tr></table></figure>
<p>환경 설정이 완료 된 이후 start를 실행 하면 비로소, 비동기적으로 생산자로 부터 버퍼를 읽어서 디코딩 처리 하기 시작한다.</p>
<h4 id="Buffer얻어-오기"><a href="#Buffer얻어-오기" class="headerlink" title="Buffer얻어 오기"></a>Buffer얻어 오기</h4><h5 id="Syncronized"><a href="#Syncronized" class="headerlink" title="Syncronized"></a>Syncronized</h5><h6 id="API21-롤리팝-이후-deprecated-된-방법-grafika"><a href="#API21-롤리팝-이후-deprecated-된-방법-grafika" class="headerlink" title="API21(롤리팝) 이후 deprecated 된 방법 (grafika)"></a>API21(롤리팝) 이후 deprecated 된 방법 (grafika)</h6><p>grafika의 Movie Player는 이 방법을 사용해서 Data Stream을 접근 하고 있다.</p>
<ul>
<li><p>버퍼의 형식은 ByteBuffer[]</p>
</li>
<li><p>start() Call 이후 부터 버퍼를 얻어 오는 방식은 getInput과 OutputBuffers를 사용하는 방법이다. 양수의 buffer id를 기준으로 얻어온다.</p>
</li>
<li><p><code>dequeueInputBuffer()</code> , <code>dequeueOutputBuffer()</code>는 비동기 스레드에 상태를 확인하기 위한 api이다. 비록 Syncronized 방식이라고 해도 이점은 변하지 않는다.</p>
<blockquote>
<p>파라메터로 timeoutUs 가 사용되는데, 해당 값은 상위 상태 변화를 확인하기 위해 기다리는 시간이다. 해당 시간을 기다려도 state의 변화가 생기지 않는다면,  해당 media data는 invalidate 처리 되게 된다. timeoutUs가 0이하면 무한이 기다리게 된다. 0이면 기다리지 않고 즉각 return 처리 한다.</p>
</blockquote>
</li>
</ul>
<p><strong>MoviePlayer.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExtract</span><span class="params">(MediaExtractor extractor, <span class="keyword">int</span> trackIndex, MediaCodec decoder,</span></span></span><br><span class="line"><span class="function"><span class="params">                       FrameCallback frameCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> TIMEOUT_USEC = <span class="number">10000</span>;</span><br><span class="line">    ByteBuffer[] decoderInputBuffers = decoder.getInputBuffers();</span><br><span class="line">    <span class="keyword">int</span> inputChunk = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> firstInputTimeNsec = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> outputDone = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> inputDone = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!outputDone) &#123;</span><br><span class="line">        <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"loop"</span>);</span><br><span class="line">        <span class="keyword">if</span> (mIsStopRequested) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"Stop requested"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feed more data to the decoder.</span></span><br><span class="line">        <span class="keyword">if</span> (!inputDone) &#123;</span><br><span class="line">            <span class="keyword">int</span> inputBufIndex = decoder.dequeueInputBuffer(TIMEOUT_USEC);</span><br><span class="line">            <span class="keyword">if</span> (inputBufIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (firstInputTimeNsec == -<span class="number">1</span>) &#123;</span><br><span class="line">                    firstInputTimeNsec = System.nanoTime();</span><br><span class="line">                &#125;</span><br><span class="line">                ByteBuffer inputBuf = decoderInputBuffers[inputBufIndex];</span><br><span class="line">                <span class="comment">// Read the sample data into the ByteBuffer.  This neither respects nor</span></span><br><span class="line">                <span class="comment">// updates inputBuf's position, limit, etc.</span></span><br><span class="line">                <span class="keyword">int</span> chunkSize = extractor.readSampleData(inputBuf, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (chunkSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// End of stream -- send empty frame with EOS flag set.</span></span><br><span class="line">                    decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0L</span>,</span><br><span class="line">                            MediaCodec.BUFFER_FLAG_END_OF_STREAM);</span><br><span class="line">                    inputDone = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"sent input EOS"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (extractor.getSampleTrackIndex() != trackIndex) &#123;</span><br><span class="line">                        Log.w(TAG, <span class="string">"WEIRD: got sample from track "</span> +</span><br><span class="line">                                extractor.getSampleTrackIndex() + <span class="string">", expected "</span> + trackIndex);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">long</span> presentationTimeUs = extractor.getSampleTime();</span><br><span class="line">                    decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, chunkSize,</span><br><span class="line">                            presentationTimeUs, <span class="number">0</span> <span class="comment">/*flags*/</span>);</span><br><span class="line">                    <span class="keyword">if</span> (VERBOSE) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">"submitted frame "</span> + inputChunk + <span class="string">" to dec, size="</span> +</span><br><span class="line">                                chunkSize);</span><br><span class="line">                    &#125;</span><br><span class="line">                    inputChunk++;</span><br><span class="line">                    extractor.advance();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"input buffer not available"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!outputDone) &#123;</span><br><span class="line">            <span class="keyword">int</span> decoderStatus = decoder.dequeueOutputBuffer(mBufferInfo, TIMEOUT_USEC);</span><br><span class="line">            <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) &#123;</span><br><span class="line">                <span class="comment">// no output available yet</span></span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"no output from decoder available"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) &#123;</span><br><span class="line">                <span class="comment">// not important for us, since we're using Surface</span></span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output buffers changed"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">                MediaFormat newFormat = decoder.getOutputFormat();</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output format changed: "</span> + newFormat);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"unexpected result from decoder.dequeueOutputBuffer: "</span> +</span><br><span class="line">                                decoderStatus);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// decoderStatus &gt;= 0</span></span><br><span class="line">                <span class="keyword">if</span> (firstInputTimeNsec != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Log the delay from the first buffer of input to the first buffer</span></span><br><span class="line">                    <span class="comment">// of output.</span></span><br><span class="line">                    <span class="keyword">long</span> nowNsec = System.nanoTime();</span><br><span class="line">                    Log.d(TAG, <span class="string">"startup lag "</span> + ((nowNsec-firstInputTimeNsec) / <span class="number">1000000.0</span>) + <span class="string">" ms"</span>);</span><br><span class="line">                    firstInputTimeNsec = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">boolean</span> doLoop = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"surface decoder given buffer "</span> + decoderStatus +</span><br><span class="line">                        <span class="string">" (size="</span> + mBufferInfo.size + <span class="string">")"</span>);</span><br><span class="line">                <span class="keyword">if</span> ((mBufferInfo.flags &amp; MediaCodec.BUFFER_FLAG_END_OF_STREAM) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"output EOS"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (mLoop) &#123;</span><br><span class="line">                        doLoop = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        outputDone = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">boolean</span> doRender = (mBufferInfo.size != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// As soon as we call releaseOutputBuffer, the buffer will be forwarded</span></span><br><span class="line">                <span class="comment">// to SurfaceTexture to convert to a texture.  We can't control when it</span></span><br><span class="line">                <span class="comment">// appears on-screen, but we can manage the pace at which we release</span></span><br><span class="line">                <span class="comment">// the buffers.</span></span><br><span class="line">                <span class="keyword">if</span> (doRender &amp;&amp; frameCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    frameCallback.preRender(mBufferInfo.presentationTimeUs);</span><br><span class="line">                &#125;</span><br><span class="line">                decoder.releaseOutputBuffer(decoderStatus, doRender);</span><br><span class="line">                <span class="keyword">if</span> (doRender &amp;&amp; frameCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    frameCallback.postRender();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (doLoop) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">"Reached EOS, looping"</span>);</span><br><span class="line">                    extractor.seekTo(<span class="number">0</span>, MediaExtractor.SEEK_TO_CLOSEST_SYNC);</span><br><span class="line">                    inputDone = <span class="keyword">false</span>;</span><br><span class="line">                    decoder.flush();    <span class="comment">// reset decoder state</span></span><br><span class="line">                    frameCallback.loopReset();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이 메서드는 video가 멈추거나 끝날때 까지 루프를 돌게 된다. </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ByteBuffer[] decoderInputBuffers = decoder.getInputBuffers();</span><br></pre></td></tr></table></figure>
<p>getInputBuffers (input surface를 사용하는 경우 절대로 사용하면 안됨)</p>
<p>해당 메서드는 21이후로 더이상 사용되지 않는다. <code>getInputBuffer(int)</code>를 대신 사용한다.</p>
<p>본 메서드를 이용해서 byte stream을 읽어 오는데 일단 한번 읽어진 buffer는 재사용 되지 않는다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> inputBufIndex = decoder.dequeueInputBuffer(TIMEOUT_USEC);</span><br></pre></td></tr></table></figure>
<p>사용 가능한 데이터의 index(위치)를 알려준다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ByteBuffer inputBuf = decoderInputBuffers[inputBufIndex];</span><br></pre></td></tr></table></figure>
<p>앞서 읽어온 inputbuffer에서 사용 가능한 데이터의 index의 bytebuffer를 얻어온다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, chunkSize,</span><br><span class="line">        presentationTimeUs, <span class="number">0</span> <span class="comment">/*flags*/</span>);</span><br><span class="line">inputDone = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure>
<p>화면에 표시하기(decode) 위한 buffer를 지정한다.</p>
<p>여기서 presentationTimeUs는 이후 화면에 표시할때 나오는 timestamp와 동일 값이 된다.</p>
<p>해당 메서드를 Call 한 이후부터는 output이 가능한 단계 까지 while 문을 돌면서 기다리게 된다.</p>
<p><code>inputDone = true;</code>은 decode를 위한 버퍼를 채웠다는 flag처리이다.</p>
<p>이후 <code>outputDone</code>이 처리 되어야 한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!outputDone) &#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>바이트를 입력 했으니 이후는 입력된 바이트가 정상적으로 decode되어서 읽을 수 있으면 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> decoderStatus = decoder.dequeueOutputBuffer(mBufferInfo, TIMEOUT_USEC);</span><br></pre></td></tr></table></figure>
<p>이 부분을 확인하는 코드이다.</p>
<p>dequeueOutputBuffer</p>
<p>decoded가 완료 되었는지 여부를 확인 하는 코드로써, 다음 3가지 중 하나의 리턴을 갖게 된다.</p>
<p><code>NFO_TRY_AGAIN_LATER</code>, <code>INFO_OUTPUT_FORMAT_CHANGED</code>, <code>INFO_OUTPUT_BUFFERS_CHANGED</code></p>
<p>해당 value는 모두 음수의 값을 갖고 있다.</p>
<p>이외 양수의 값이 있다면 decode가 완료 되었다고 생각해도 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) &#123;</span><br><span class="line">    <span class="comment">// no output available yet</span></span><br><span class="line">    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"no output from decoder available"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) &#123;</span><br><span class="line">    <span class="comment">// not important for us, since we're using Surface</span></span><br><span class="line">    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output buffers changed"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">    MediaFormat newFormat = decoder.getOutputFormat();</span><br><span class="line">    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output format changed: "</span> + newFormat);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">"unexpected result from decoder.dequeueOutputBuffer: "</span> +</span><br><span class="line">                    decoderStatus);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// decoderStatus &gt;= 0</span></span><br></pre></td></tr></table></figure>
<p>decodeStatus가 양수일때 처리 하는 가능 핵심 적인 코드는 다음이다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">decoder.releaseOutputBuffer(decoderStatus, doRender);</span><br></pre></td></tr></table></figure>
<p>releaseOutputBuffer</p>
<p>output surface에 그려질 decode된 byte buffer를 돌려주는 행위를 하는 코드이다. <code>dequeueOutputBuffer</code></p>
<p>에서 지정해준 index를 기준으로 화면에 rendering을 처리하게 된다. doRender가 true이면 output surface에 최우선 적으로 데이터를 send하게 된다. 일단 해당 버퍼가 사용되고 나면 surface는 codec에게 더이상 재활용 하지 말것을 요청하게 된다.  해당 처리에 대한 결과로는 <code>MediaCodec.Callback</code>에 속해 있는 <code>onOutputBufferAvailable</code>가 trigger 된다.</p>
<p>해당 decode가 완료된 이후 surfacetexture view 쪽으로 화면의 redraw를 다음 리스너를 통해 알려준다.</p>
<p><code>TextureView.SurfaceTextureListener</code></p>
<p><strong>onSurfaceTextureUpdated</strong></p>
<p>SurfaceTexture에 있는 updateTexImage가 Call되면 이 method가 call되게 되는데, MediaCodec이 surface에 변화를 줄때마다 해당 시점을 얻어 오고 싶다면, 본 리스너를 등록 하면 된다. </p>
<p><strong>PlayMovieActivity.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureUpdated</span><span class="params">(SurfaceTexture surface)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Matrix txform = <span class="keyword">new</span> Matrix();</span><br><span class="line">    mTextureView.getTransform(txform);</span><br><span class="line">    mRotateValue %= <span class="number">360</span>;</span><br><span class="line">    txform.postRotate(mRotateValue += <span class="number">1</span>);</span><br><span class="line">    mTextureView.setTransform(txform);</span><br><span class="line">    Log.d(TAG, <span class="string">"onSurfaceTextureUpdated = "</span> + mRotateValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>grafika 에서는 <code>adjustAspectRatio</code>라는 메서드를 통해서 동영상의 비율을 조정하게 되는데, 해당 코드의 일부분을 상위와 같이 <code>onSurfaceTextureUpdated</code>에 넣게 되면 동영상이 돌아가는 모습을 확인 할 수있게 된다.</p>
<p>Surface에 대한 수정을 처리 하고 싶을 때는 <code>onSurfaceTextureAvailable</code>이나 <code>onSurfaceTextureUpdated</code>시점에 처리 해주면 된다.</p>
<p>만약 송출되는 Surface의 화면을 mirror(flip) 처리 하고자 한다면 PlayMovieActivity 내 <code>adjustAspectRatio</code>메서드 마지막에 <code>mTextureView.setScaleX(-1);</code> 처리를 하면 된다. </p>
<blockquote>
<p>Matrix의 setScale(-1,1)을 통한 flip은 성공하지 못했다.</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://theyoung.github.io/android-graphic-architecture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="whoami">
      <meta itemprop="description" content="my note">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Try Again">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/android-graphic-architecture/" class="post-title-link" itemprop="url">android graphic architecture</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-16 18:37:40" itemprop="dateCreated datePublished" datetime="2019-04-16T18:37:40Z">2019-04-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-04 02:25:46" itemprop="dateModified" datetime="2019-07-04T02:25:46Z">2019-07-04</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/android-graphic-architecture/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="android-graphic-architecture/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="BufferQueue"><a href="#BufferQueue" class="headerlink" title="BufferQueue"></a>BufferQueue</h3><p>그래픽 데이터의 생산자와 소비자를 연결 수켜주는 역할을 한다. (프로세스가 서로 달라도 된다.)</p>
<p>생산자는 버퍼 특징을 기술한다.</p>
<ul>
<li>높이, 넓이, 픽셀포맷, 플래그 등</li>
</ul>
<p>Data Flow</p>
<ul>
<li>dequeBuffer</li>
<li>생상자 버퍼 채움</li>
<li>queueBuffer</li>
<li>소비사 버퍼 획득</li>
<li>acquireBuffer</li>
<li>버퍼 활용</li>
<li>releaseBuffer</li>
</ul>
<h3 id="gralloc-HAL"><a href="#gralloc-HAL" class="headerlink" title="gralloc HAL"></a>gralloc HAL</h3><p>allock함수를 이용해 버퍼를 할당한다.</p>
<ul>
<li>넓이,높이,픽셀포맷, 용도 플래그가 인자</li>
</ul>
<p>예) RGBA8888 픽셀 포멧의 경우 R-&gt;G-&gt;B-&gt;A 순서로 4바이트 버퍼를 생성한다. </p>
<h3 id="SurfaceFlinger"><a href="#SurfaceFlinger" class="headerlink" title="SurfaceFlinger"></a>SurfaceFlinger</h3><p>그래픽 데어터 버퍼를 받고 Display로 보내는 목적</p>
<ul>
<li>앱 포어그라운드 -&gt; 윈도우매니저 -&gt; surfaceflinger -&gt; draw 요청</li>
</ul>
<p>BufferQueue의 소비자 처럼 동작한다.</p>
<ul>
<li>생산자 -&gt; 바인더객체 -&gt; 윈도우매니저 -&gt; 앱 -&gt; surfaceflinger 프레임전송<br>showSoftInput<br>해당 기능은 디스플레이가 버퍼 처리가능할 때 작동이 시작된다.</li>
</ul>
<h3 id="프레임렌더링-구조"><a href="#프레임렌더링-구조" class="headerlink" title="프레임렌더링 구조"></a>프레임렌더링 구조</h3><p>생산자 -&gt; 버퍼를 채움 -&gt; 버퍼큐 채움 -&gt; surfacelinger 쪽으로 이동 -&gt; HWcomposer로 다음 frame 전송 -&gt; HWComposer는 Systemui(상태바등)와 bufferqueu 정보를 합쳐서 화면에 표시함 (VSYNC 발생 시 frame 그림)</p>
<p>app -&gt; MediaCodec -&gt; raw데이터 버퍼 또는 Surface제공</p>
<h3 id="Surface"><a href="#Surface" class="headerlink" title="Surface"></a>Surface</h3><p>BufferQueue의 생산자 역할</p>
<p>SurfaceFlinger는 Bufferqueue의 소비자 역할</p>
<p><code>dumpsys SurfaceFlinger</code>명령을 통해 레이어와 연관된 버퍼 정보를 확인 가능</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Build configuration: [sf] [libui] [libgui]</span><br><span class="line">Sync configuration: [using: EGL_ANDROID_native_fence_sync EGL_KHR_wait_sync]</span><br><span class="line">DispSync configuration: app phase 0 ns, sf phase 0 ns, present offset 0 ns (refresh 16666666 ns)</span><br><span class="line">Visible layers (count = 6)</span><br><span class="line">+ LayerDim 0x9203b000 (DimLayer)</span><br><span class="line">  Region transparentRegion (this=0x9203b178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x9203b008, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(  16,  16), crop=(   0,   0,  -1,  -1), isOpaque=0, invalidate=0, alpha=0xff, flags=0x00000001, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x954391c0</span><br><span class="line">      format= 0, activeBuffer=[   0x   0:   0,  0], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=4 mCurrentTexture=-1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1x1], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">+ LayerDim 0x92023000 (DimLayer)</span><br><span class="line">  Region transparentRegion (this=0x92023178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x92023008, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(  16,  16), crop=(   0,   0,  -1,  -1), isOpaque=0, invalidate=0, alpha=0xff, flags=0x00000001, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x954391c0</span><br><span class="line">      format= 0, activeBuffer=[   0x   0:   0,  0], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=5 mCurrentTexture=-1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1x1], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">+ LayerDim 0x963ba000 (DimLayer)</span><br><span class="line">  Region transparentRegion (this=0x963ba178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x963ba008, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(  16,  16), crop=(   0,   0,  -1,  -1), isOpaque=0, invalidate=0, alpha=0xff, flags=0x00000001, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x954391c0</span><br><span class="line">      format= 0, activeBuffer=[   0x   0:   0,  0], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=7 mCurrentTexture=-1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1x1], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">+ LayerDim 0x92021000 (DimLayer)</span><br><span class="line">  Region transparentRegion (this=0x92021178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x92021008, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(  16,  16), crop=(   0,   0,  -1,  -1), isOpaque=0, invalidate=0, alpha=0xff, flags=0x00000001, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x954391c0</span><br><span class="line">      format= 0, activeBuffer=[   0x   0:   0,  0], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=8 mCurrentTexture=-1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1x1], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">+ Layer 0x92019000 (com.example /com.example.MainActivity)</span><br><span class="line">  Region transparentRegion (this=0x92019178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x92019008, count=1)</span><br><span class="line">    [  0,   0, 1920, 1080]</span><br><span class="line">      layerStack=   0, z=    21005, pos=(0,0), size=(1920,1080), crop=(   0,   0,1920,1080), isOpaque=1, invalidate=0, alpha=0xff, flags=0x00000002, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x96074440</span><br><span class="line">      format= 1, activeBuffer=[1920x1080:1920,  1], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=9 mCurrentTexture=1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1920x1080], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">             [00:0x9606d980] state=FREE    , 0x96087380 [1920x1080:1920,  1]</span><br><span class="line">            &gt;[01:0x9606da20] state=ACQUIRED, 0x96087440 [1920x1080:1920,  1]</span><br><span class="line">             [02:0x9606dac0] state=FREE    , 0x96087500 [1920x1080:1920,  1]</span><br><span class="line">+ Layer 0x9203d000 (FocusedStackFrame)</span><br><span class="line">  Region transparentRegion (this=0x9203d178, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  Region visibleRegion (this=0x9203d008, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">      layerStack=   0, z=    21006, pos=(0,0), size=(   1,   1), crop=(   0,   0,  -1,  -1), isOpaque=0, invalidate=0, alpha=0x4d, flags=0x00000001, tr=[1.00, 0.00][0.00, 1.00]</span><br><span class="line">      client=0x954391c0</span><br><span class="line">      format= 1, activeBuffer=[   0x   0:   0,  0], queued-frames=0, mRefreshPending=0</span><br><span class="line">            mTexName=3 mCurrentTexture=-1</span><br><span class="line">            mCurrentCrop=[0,0,0,0] mCurrentTransform=0</span><br><span class="line">            mAbandoned=0</span><br><span class="line">            -BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1x1], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line">Displays (1 entries)</span><br><span class="line">+ DisplayDevice: Built-in Screen</span><br><span class="line">   <span class="built_in">type</span>=0, hwcId=0, layerStack=0, (1920x1080), ANativeWindow=0x96225408, orient= 0 (<span class="built_in">type</span>=00000000), flips=159, isSecure=1, secureVis=0, powerMode=2, activeConfig=0, numLayers=1</span><br><span class="line">   v:[0,0,1920,1080], f:[0,0,1920,1080], s:[0,0,1920,1080],transform:[[1.000,0.000,-0.000][0.000,1.000,-0.000][0.000,0.000,1.000]]</span><br><span class="line">mAbandoned=0</span><br><span class="line">-BufferQueue mMaxAcquiredBufferCount=1, mDequeueBufferCannotBlock=0, default-size=[1920x1080], default-format=1, transform-hint=00, FIFO(0)=&#123;&#125;</span><br><span class="line"> [00:0x9606d3e0] state=FREE    , 0x96086780 [1920x1080:1920,  1]</span><br><span class="line"> [01:0x9606d480] state=FREE    , 0x96086840 [1920x1080:1920,  1]</span><br><span class="line">&gt;[02:0x9606d520] state=ACQUIRED, 0x96086900 [1920x1080:1920,  1]</span><br><span class="line">SurfaceFlinger global state:</span><br><span class="line">EGL implementation : 1.4 Midgard-<span class="string">"r8p0-02rel0"</span></span><br><span class="line"> EGL_ANDROID_image_native_buffer EGL_ANDROID_recordable EGL_ANDROID_native_fence_sync EGL_ANDROID_framebuffer_target EGL_ANDROID_blob_cache EGL_KHR_partial_update EGL_KHR_config_attribs EGL_KHR_image EGL_KHR_image_base EGL_KHR_fence_sync EGL_KHR_wait_sync EGL_KHR_gl_colorspace EGL_KHR_get_all_proc_addresses EGL_IMG_context_priority EGL_KHR_gl_texture_2D_image EGL_KHR_gl_renderbuffer_image EGL_KHR_create_context EGL_KHR_surfaceless_context EGL_KHR_gl_texture_cubemap_image EGL_EXT_create_context_robustness</span><br><span class="line">GLES: ARM, Mali-T720, OpenGL ES 3.1 v1.r8p0-02rel0.b25106f7a00abf0fd922cfe23b51206f</span><br><span class="line">GL_EXT_debug_marker GL_ARM_rgba8 GL_ARM_mali_shader_binary GL_OES_depth24 GL_OES_depth_texture GL_OES_depth_texture_cube_map GL_OES_packed_depth_stencil GL_OES_rgb8_rgba8 GL_EXT_read_format_bgra GL_OES_compressed_paletted_texture GL_OES_compressed_ETC1_RGB8_texture GL_OES_standard_derivatives GL_OES_EGL_image GL_OES_EGL_image_external GL_OES_EGL_sync GL_OES_texture_npot GL_OES_vertex_half_float GL_OES_required_internalformat GL_OES_vertex_array_object GL_OES_mapbuffer GL_EXT_texture_format_BGRA8888 GL_EXT_texture_rg GL_EXT_texture_type_2_10_10_10_REV GL_OES_fbo_render_mipmap GL_OES_element_index_uint GL_EXT_shadow_samplers GL_OES_texture_compression_astc GL_KHR_texture_compression_astc_ldr GL_KHR_texture_compression_astc_hdr GL_KHR_debug GL_EXT_occlusion_query_boolean GL_EXT_disjoint_timer_query GL_EXT_blend_minmax GL_EXT_discard_framebuffer GL_OES_get_program_binary GL_OES_texture_3D GL_EXT_texture_storage GL_EXT_multisampled_render_to_texture GL_OES_surfaceless_context GL_OES_texture_stencil8 GL_EXT_shader_pixel_local_storage GL_ARM_shader_framebuffer_fetch GL_ARM_shader_framebuffer_fetch_depth_stencil GL_ARM_mali_program_binary GL_EXT_sRGB GL_EXT_sRGB_write_control GL_EXT_texture_sRGB_decode GL_KHR_blend_equation_advanced GL_KHR_blend_equation_advanced_coherent GL_OES_texture_storage_multisample_2d_array GL_OES_shader_image_atomic GL_EXT_robustness GL_EXT_texture_border_clamp GL_OES_texture_border_clamp GL_EXT_texture_cube_map_array GL_OES_texture_cube_map_array GL_OES_sample_variables GL_OES_sample_shading GL_OES_shader_multisample_interpolation GL_EXT_shader_io_blocks GL_OES_shader_io_blocks GL_EXT_gpu_shader5 GL_OES_gpu_shader5 GL_EXT_texture_buffer GL_OES_texture_buffer GL_EXT_copy_image GL_OES_copy_image</span><br><span class="line">  Region undefinedRegion (this=0x960b352c, count=1)</span><br><span class="line">    [  0,   0,   0,   0]</span><br><span class="line">  orientation=0, isDisplayOn=1</span><br><span class="line">  last eglSwapBuffers() time: 7657.042000 us</span><br><span class="line">  last transaction time     : 180.167000 us</span><br><span class="line">  transaction-flags         : 00000000</span><br><span class="line">  refresh-rate              : 60.000002 fps</span><br><span class="line">  x-dpi                     : 159.895004</span><br><span class="line">  y-dpi                     : 160.421005</span><br><span class="line">  gpu_to_cpu_unsupported    : 0</span><br><span class="line">  eglSwapBuffers time: 0.000000 us</span><br><span class="line">  transaction time: 0.000000 us</span><br><span class="line">VSYNC state: disabled</span><br><span class="line">  soft-vsync: disabled</span><br><span class="line">  numListeners=9,</span><br><span class="line">  events-delivered: 297</span><br><span class="line">    0x9544c038: count=-1</span><br><span class="line">    0x9544c060: count=-1</span><br><span class="line">    0x9544c088: count=-1</span><br><span class="line">    0x9544c0b0: count=-1</span><br><span class="line">    0x96038b78: count=-1</span><br><span class="line">    0x96038ba0: count=-1</span><br><span class="line">    0x96038bf0: count=-1</span><br><span class="line">    0x96038f38: count=-1</span><br><span class="line">    0x96038f60: count=-1</span><br><span class="line">h/w composer state:</span><br><span class="line">  h/w composer present and enabled</span><br><span class="line">Hardware Composer state (version 01010000):</span><br><span class="line">  mDebugForceFakeVSync=0</span><br><span class="line">  Display[0] configurations (* current):</span><br><span class="line">    * 0: 1920x1080, xdpi=159.895004, ydpi=160.421005, refresh=16666666</span><br><span class="line">  numHwLayers=2, flags=00000000</span><br><span class="line">    <span class="built_in">type</span>   |  handle  | hint | flag | tr | blnd |   format    |     <span class="built_in">source</span> crop (l,t,r,b)      |          frame         | name</span><br><span class="line">-----------+----------+------+------+----+------+-------------+--------------------------------+------------------------+------</span><br><span class="line">       HWC | 96087440 | 0000 | 0000 | 00 | 0100 | RGBA_8888   |      0,      0,   1920,   1080 |    0,    0, 1920, 1080 | com.example /com.example</span><br><span class="line"> FB TARGET | 96086900 | 0000 | 0000 | 00 | 0105 | RGBA_8888   |      0,      0,   1920,   1080 |    0,    0, 1920, 1080 | HWC_FRAMEBUFFER_TARGET</span><br><span class="line">Allocated buffers:</span><br><span class="line">0x96086780: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00001a00</span><br><span class="line">0x96086840: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00001a00</span><br><span class="line">0x96086900: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00001a00</span><br><span class="line">0x96087380: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00000b00</span><br><span class="line">0x96087440: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00000b00</span><br><span class="line">0x96087500: 8100.00 KiB | 1920 (1920) x 1080 |        1 | 0x00000b00</span><br><span class="line">Total allocated (estimate): 48600.00 KB</span><br></pre></td></tr></table></figure>
<h3 id="Canvas-Rendering"><a href="#Canvas-Rendering" class="headerlink" title="Canvas Rendering"></a>Canvas Rendering</h3><ul>
<li>Skia Graphics Library : 렌더링 로우레밸 처리</li>
</ul>
<p>Skia는 바이트를 버퍼의 형태로 구성기 위해 그리고 멀티 클라이언트에 의한 동시 업데이트를 방지하기 위해, 버퍼 액세스 락을 사용한다.</p>
<ul>
<li><p>lockCanvas() : 버퍼에 락을 걸고 드로잉을 위한 Canvas를 리턴</p>
</li>
<li><p>unlockCanvasAndPost() :버퍼에 락을 해제 하고 compositor로 전달</p>
</li>
</ul>
<p>하드웨어 가속 Canvas API (OpenGL ES 지원을 위함)</p>
<ul>
<li>View onDraw Canvas : 하드웨어 가속 가능</li>
<li>APP이 직접 lockCanvas()를 통해 캠버스(surface)를 얻어 오는 것과는 다름 : 사용자 lock Canvas 기반 CPU랜더러는 GLES로 Surface드로잉을 할 수 없거나 비디오 디코더에 출력된 프레임을 보낼 수 없다.</li>
<li>Canvas를 사용하지 않고 Surface에 직접 드로잉 하는 주요 방법은 OpenGL ES를 사용하면 됨</li>
</ul>
<h3 id="SurfaceHolder"><a href="#SurfaceHolder" class="headerlink" title="SurfaceHolder"></a>SurfaceHolder</h3><p>surface와 관련된 작업은 surfaceHolder와 surfaceView가 필요함</p>
<ul>
<li>surface : compositor에 관리 되는 버퍼</li>
<li>surfaceholder : 앱에 의해 관리되고 surface의 크기나 포맷같은 고수준 정보를 관리</li>
</ul>
<p>view와 관련된 작업은 surfaceholder를 포함하고, MediaCodec같은 API들은 surface상에서 동작한다. Surface는 surfacehoder를 통해 얻을 수 있다. surface의 설정 정보들을 얻고자 하면 surfacehoder를 통해 구하면 된다. </p>
<h3 id="SurfaceView"><a href="#SurfaceView" class="headerlink" title="SurfaceView"></a>SurfaceView</h3><p>Surface + View</p>
<p>surfaceview -&gt; 투명 -&gt; view컴포넌트 시각화 시작 -&gt; windowmanager -&gt; sufaceflinger가 surface생성 요청</p>
<blockquote>
<p>비동기적 작동으로 surface생성 완료시 callback처리 해야한다</p>
</blockquote>
<p>새로운 sruface는 보이지 않는 영역에 생김, z ordering을 통해 상위로 올려야함</p>
<blockquote>
<p>view 펀칭을 통한 화면 제공 방식이다. &quot;surfaceview -&gt; window -&gt; surface -&gt; 사용자 눈&quot; 이라고 했을때 window에 fixed된 창을 뚫는 방식이다.</p>
<p>이런 방식으로 인해 SurfaceView는 </p>
<ul>
<li>transformation, animation 등의 처리가 불가능하다.</li>
</ul>
</blockquote>
<h3 id="SurfaceTexture"><a href="#SurfaceTexture" class="headerlink" title="SurfaceTexture"></a>SurfaceTexture</h3><p>Surface + GLES Texture 조합</p>
<p>SurfaceTexture생성 -&gt; BufferQueue 생성 -&gt; 생상자 SurfaceTexture 생성 -&gt; Bufferqueue 인큐  -&gt; onFrameAvailable() 통지 -&gt; updateTexImage 메서드 호출 -&gt; bufferqueue 버퍼 얻음 </p>
<ul>
<li>getTimestamp() : timestamp 정보</li>
<li>getTransformMatrix : 가자 최근 호출된 updateTexImage()메서드 설정된 변환 행렬()</li>
<li>변환행렬 : 잘못된 소스데이터를 보정 가능</li>
<li>timestamp : 카메라 코드에 의해 설정되며 프레임이 캡처될때 기준으로 리턴된다.</li>
</ul>
<blockquote>
<p>surfaceview와는 다르게 view 그룹의 하이어러키에 포함된다. (surfaceview의 rendering은 다른 view 그룹의 랜더링과 독립으로 처리 되는것으로 보인다.) 그렇기에 surfacetexture는 </p>
<ul>
<li>transformation, animation 처리 등이 가능하다</li>
<li>그러나 memory 사용량이 상대적으로 높고, 해당 surface의 redraw가 해당 그룹 전체의 redraw에 영향을 줄수 있다.</li>
<li>video player를 개발하게 되면 사실상 surfacetexture를 사용할 수 밖에 없는데 fullscreen mode가 전제 된다면 surfaceview를 사용하는 것이 좋다(drm contents는 surfaceview 사용 권장)</li>
</ul>
</blockquote>
<p>해당 컴포넌트는 반듯이 하드웨어 렌더링을 지원해야 한다.</p>
<h3 id="TextureView"><a href="#TextureView" class="headerlink" title="TextureView"></a>TextureView</h3><p>View + SurfaceTexture</p>
<p>TextureView는 SurfaceTexture를 wrap하고 있음</p>
<ul>
<li>SurfaceTexture Callback 응답처리, 신규 버퍼 획득 처리 역할</li>
<li>View invalidate 요청 : 신규 버퍼 수신 시</li>
</ul>
<ul>
<li>장점 : View 계층 구조에 소속되어 동작, 다른 View와 동일, API 임의 변환 수행 및 비트맵을 컨텐츠로 로드가능</li>
<li>단점 : 합성 단계 성능, View 합성이 GLES로 수행되고 다른 View 요소들의 리드로잉을 발생 시킴. Video 처리 등을 위해서는 SurfaceView가 더 좋은 성능을 제공 (DRM Contents는 SurfaceView로만 구현 가능)</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://theyoung.github.io/android-memory-leak/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="whoami">
      <meta itemprop="description" content="my note">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Try Again">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/android-memory-leak/" class="post-title-link" itemprop="url">android memory leak 처리</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-02 19:24:40" itemprop="dateCreated datePublished" datetime="2019-04-02T19:24:40Z">2019-04-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-04 02:25:46" itemprop="dateModified" datetime="2019-07-04T02:25:46Z">2019-07-04</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/android-memory-leak/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="android-memory-leak/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Inner-Class-누수"><a href="#Inner-Class-누수" class="headerlink" title="Inner Class 누수"></a>Inner Class 누수</h4><p>Activity 내부에 아래와 같이 Inner Class를 정의 할 경우 잠재적으로 누수의 대상이 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Innserclass inner;</span><br><span class="line">    <span class="keyword">private</span> String mStr;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main2);</span><br><span class="line">        inner = <span class="keyword">new</span> Innserclass();</span><br><span class="line">        <span class="keyword">new</span> Thread(inner).start();</span><br><span class="line">        mStr = <span class="string">"hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Innserclass</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Innserclass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mStr+=<span class="string">"nono!!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			getApplicationContext();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>첫번째 누수 사유는 static이다.</p>
<p><code>private static Innserclass inner;</code></p>
<p>일단 static에 memory를 assigne하게 되면 해당 instance는 모 class인 activity와는 별도로 메모리 상에 살아 남게 된다. </p>
<p>두번째 사유는 thread 처리이다.</p>
<p>inner class를 thread처리 함으로써 (이경우는 postdelay도 마찬가지다) UI Thread가 죽어도 살아 남을 가능 성이 있다. Destroy 시점에 반듯이 thread를 종료 처리 해줘야 한다. handler도 이 경우에 속하게 된다. </p>
<p>세번째 사유는 InnerClass 자체에 있다. 첫번째 사유든 두번째 사유든 해당 Instance는 잠재적으로 모 Class의 Context를 접근 할 수 있게 된다. 코드상으론</p>
<p><code>mStr+=&quot;nono!!&quot;;</code></p>
<p>이 부분이다.</p>
<p>해결 방법은 다음고 같다.</p>
<h5 id="Innser-Class를-절대로-static-처리-하지-말아라"><a href="#Innser-Class를-절대로-static-처리-하지-말아라" class="headerlink" title="Innser Class를 절대로 static 처리 하지 말아라"></a>Innser Class를 절대로 static 처리 하지 말아라</h5><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">-    private static Innserclass inner;</span></span><br><span class="line"><span class="addition">+    private Innserclass inner;</span></span><br></pre></td></tr></table></figure>
<p>Destroy시점에 Activity와 같이 종료할 수있다면 상관이 없을 수는 있다. 그러나 라이프 사이클이 Activity와 같다면 Static을 쓸 이유가 없다.</p>
<h5 id="Inner-Class는-static으로-정의-하던가-완전히-별도-파일로-제외를-시켜라"><a href="#Inner-Class는-static으로-정의-하던가-완전히-별도-파일로-제외를-시켜라" class="headerlink" title="Inner Class는 static으로 정의 하던가 완전히 별도 파일로 제외를 시켜라"></a>Inner Class는 static으로 정의 하던가 완전히 별도 파일로 제외를 시켜라</h5><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">-    public class Innserclass implements Runnable &#123;</span></span><br><span class="line"><span class="addition">+	 public static class Innserclass implements Runnable &#123;</span></span><br></pre></td></tr></table></figure>
<p>static 처리를 하게 되면 해당 클래스는 모 class와 독립된 메모리 참조 구조를 갖게 되어 독립하게 된다.</p>
<h5 id="weekRefernece를-사용해라"><a href="#weekRefernece를-사용해라" class="headerlink" title="weekRefernece를 사용해라"></a>weekRefernece를 사용해라</h5><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="addition">+    public static class Innserclass implements Runnable &#123;</span></span><br><span class="line"><span class="addition">+        private final WeakReference&lt;MainActivity&gt; mActivity;</span></span><br><span class="line"></span><br><span class="line">        public Innserclass(MainActivity activity) &#123;</span><br><span class="line"><span class="addition">+           mActivity = new WeakReference&lt;&gt;(activity);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line"><span class="deletion">-        	getApplicationContext();</span></span><br><span class="line"><span class="addition">+			mActivity.getApplicationContext();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>직접적인 Reference를 주입해서는 안된다. 반듯이 weekRefernece를 이용해서 context를 공유 해야한다. thread와 같이 Main Thread의 범위 밖에서 작동이 된다면 MainActivity가 명시적으로 종료 되어도 해당 Context가 별도의 Thread에 남아있게 되어서 Memory Leak이 나게 된다.</p>
<h4 id="Handler-누수"><a href="#Handler-누수" class="headerlink" title="Handler 누수"></a>Handler 누수</h4><p>내용상으로는 Inner class와 동일하다. weekreference를 이용해서 instance를 생성하게 해야한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;MainActivity&gt; mActivity;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainHandler</span><span class="params">(MainActivity activity)</span> </span>&#123;</span><br><span class="line">        mActivity = <span class="keyword">new</span> WeakReference&lt;&gt;(activity);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>기본 적인 handler의 constructor는 인수가 없음으로 강제로 넣어야만 한다.</p>
<p>그리고 종료시에는 반듯이 다음 행위를 처리해줘야 한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    <span class="keyword">if</span> (MainHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        MainHandler.removeCallbacksAndMessages(<span class="keyword">null</span>);</span><br><span class="line">        MainHandler = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>혹시 남아 있을지 모르는 메시지 큐 내용을 clear해줘야 한다.</p>
<h4 id="Webview-누수"><a href="#Webview-누수" class="headerlink" title="Webview 누수"></a>Webview 누수</h4><p>webview를 사용할때는 해당 view item이 destory가 완전히 되었고, 그에따른 메모리 반납이 이루어 졌는지 확인해야 한다. 그렇지 않다면 Native영역과 Others영역의 메모리가 지속 누적되는 현상이 발생 하게 된다. 이러한 현상은 layout상에 있는 webview를 call하게 되면 굉장히 높은 확률로 Leak이 발생하게 된다.</p>
<p>아래는 activity_main.xml과 MainActivity 수도 코드이다</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span> <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/webviewHell"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line">	<span class="tag">&lt;<span class="name">WebView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/activity_main_webview"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WebView mWebView;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        getApplicationContext();</span><br><span class="line">        mWebView = findViewById(R.id.activity_main_webview);</span><br></pre></td></tr></table></figure>
<p>Destory시 다음과 같은 code를 넣어 보아도 메모리 leak이 나는 것을 확인 할 수있다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.....</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    mWebView.clearHistory();</span><br><span class="line">    mWebView.destroyDrawingCache();</span><br><span class="line">    mWebView.setWebViewClient(<span class="keyword">null</span>);</span><br><span class="line">    mWebView.setWebChromeClient(<span class="keyword">null</span>);</span><br><span class="line">    mWebView.removeAllViews();</span><br><span class="line">    mWebView.clearCache(<span class="keyword">true</span>);</span><br><span class="line">    mWebView.freeMemory();</span><br><span class="line">    mWebView.removeAllViewsInLayout();</span><br><span class="line">    mWebView.setVisibility(View.GONE);</span><br><span class="line">    mWebView.destroy();</span><br><span class="line">    mWebView = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<h5 id="webview는-instance-생성을-통해서-처리해라"><a href="#webview는-instance-생성을-통해서-처리해라" class="headerlink" title="webview는 instance 생성을 통해서 처리해라"></a>webview는 instance 생성을 통해서 처리해라</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">    RelativeLayout mWebviewlayout;</span><br><span class="line">	WebView mWebView;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;        </span><br><span class="line">		mWebviewlayout = (RelativeLayout) findViewById(R.id.webviewHell);</span><br><span class="line">        mWebView = <span class="keyword">new</span> WebView(getApplicationContext());</span><br><span class="line">        mWebView.setLayoutParams(<span class="keyword">new</span> LayoutParams(LayoutParams.MATCH_PARENT,LayoutParams.MATCH_PARENT));</span><br><span class="line">        mWebviewlayout.addView(mWebView);</span><br><span class="line">    </span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<h5 id="완전히-연관-리로스를-clear해라"><a href="#완전히-연관-리로스를-clear해라" class="headerlink" title="완전히 연관 리로스를 clear해라"></a>완전히 연관 리로스를 clear해라</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> 	<span class="keyword">super</span>.onDestroy();</span><br><span class="line">     mWebView.removeJavascriptInterface(<span class="string">"bridge"</span>);</span><br><span class="line"></span><br><span class="line">     mWebView.loadUrl(<span class="string">"about:blank"</span>);</span><br><span class="line"></span><br><span class="line">     jsInterface = <span class="keyword">null</span>;</span><br><span class="line">     mJSCallback = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">     mWebviewlayout.destroyDrawingCache();</span><br><span class="line">     mWebviewlayout.removeAllViews();</span><br><span class="line">     mWebviewlayout.removeAllViewsInLayout();</span><br><span class="line">     mWebviewlayout.setVisibility(View.GONE);</span><br><span class="line">     mWebviewlayout = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">     mWebView.clearHistory();</span><br><span class="line">     mWebView.destroyDrawingCache();</span><br><span class="line">     mWebView.setWebViewClient(<span class="keyword">null</span>);</span><br><span class="line">     mWebView.setWebChromeClient(<span class="keyword">null</span>);</span><br><span class="line">     mWebView.removeAllViews();</span><br><span class="line">     mWebView.clearCache(<span class="keyword">true</span>);</span><br><span class="line">     mWebView.freeMemory();</span><br><span class="line">     mWebView.removeAllViewsInLayout();</span><br><span class="line">     mWebView.setVisibility(View.GONE);</span><br><span class="line">     mWebView.destroy();</span><br><span class="line">     mWebView = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>상위 destroy 코드는 다소 과하다 싶을 정도로 remove하고 있다. </p>
<p>여기서 주의 깊게 봐야할 것은 </p>
<p><code>mWebView.freeMemory();</code></p>
<p>이것이다. freeMemory api는 deprecated되었다. 공식 문서에서는 이 기능을 대체 하는 기능으로</p>
<p><code>mWebView.loadUrl(&quot;about:blank&quot;);</code></p>
<p>사용을 권장한다.</p>
<h5 id="최후에는-app-data를-전부-삭제해라"><a href="#최후에는-app-data를-전부-삭제해라" class="headerlink" title="최후에는 app data를 전부 삭제해라"></a>최후에는 app data를 전부 삭제해라</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteCache</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        File dir = context.getCacheDir();</span><br><span class="line">        deleteDir(dir);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">deleteDir</span><span class="params">(File dir)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dir != <span class="keyword">null</span> &amp;&amp; dir.isDirectory()) &#123;</span><br><span class="line">        String[] children = dir.list();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> success = deleteDir(<span class="keyword">new</span> File(dir, children[i]));</span><br><span class="line">            <span class="keyword">if</span> (!success) &#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dir.delete();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(dir!= <span class="keyword">null</span> &amp;&amp; dir.isFile()) &#123;</span><br><span class="line">        <span class="keyword">return</span> dir.delete();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>안드로이드는 apk별로 데이타를 임시 저장할 수 있는 공간이 있다.</p>
<p>일반적으로 adb shell을 진입했을때</p>
<p><code>/data/&lt;&lt;app package&gt;&gt;</code></p>
<p>이하를 가르키게 된다. 해당 폴더 이내에 있는 디렉토리를 모두 다 지우는 행위임으로, 주의 깊게 사용해야 한다.</p>
<h4 id="ImageView-사용"><a href="#ImageView-사용" class="headerlink" title="ImageView 사용"></a>ImageView 사용</h4><p>Bitmap에 대한 이미지 릭은 매우 유명하다. 허니콤(3.2)을 기준으로 이전에는 Bitmap 정보를 Native Heap영역에 담고 이를 포인팅 처리하도록 되어있었다.</p>
<blockquote>
<p>이미지포인터(java heap) -&gt; char[] (native heap)</p>
</blockquote>
<p>하지만 이는 포인터를 잊는 순간 Native영역에 해소 되지 않는 메모리 릭을 발생 시켰고 이점을 해결하기 위해 메모리 영역을 Heap 영역으로 옮겼다 . Profiler에서도 보면 비트맵 힙 영역을 별도록 볼수있게 하였다.</p>
<p>그렇다고 Bitmap에 대한 메모리 릭이 사라지진 않았다. 무조건 Image View는 recycle 처리를 해줘야 한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">        ImageView image = (ImageView) findViewById(R.id.loadingImage);</span><br><span class="line">        Bitmap myBitmap = BitmapFactory.decodeFile(imgFile.getAbsolutePath());</span><br><span class="line">        image.setImageBitmap(myBitmap);</span><br><span class="line">    </span><br><span class="line">...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">super</span>.onDestroy();</span><br><span class="line">        image.recycle();</span><br></pre></td></tr></table></figure>
<p>그러나 이와 같은 코드 작성을 위해서 Bitmap을 모두 class 변수로 끌어 내는건 좋지 않음으로 다음 코드를 사용해서 recycle처리 할 수 있다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">recycleBitmap</span><span class="params">(ImageView imageView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Drawable d = imageView.getDrawable();</span><br><span class="line">        <span class="keyword">if</span> (d != <span class="keyword">null</span> &amp;&amp; d <span class="keyword">instanceof</span> BitmapDrawable) &#123;</span><br><span class="line">            Bitmap b = ((BitmapDrawable)d).getBitmap();</span><br><span class="line">            <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">                b.recycle();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        imageView.setImageResource(android.R.color.transparent);</span><br><span class="line">        imageView.setImageBitmap(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>단, 주의해야할 코드가 있다.</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">        ImageView image = (ImageView) findViewById(R.id.loadingImage);</span><br><span class="line">        Bitmap myBitmap = BitmapFactory.decodeFile(imgFile.getAbsolutePath());</span><br><span class="line"><span class="deletion">-        image.setImageBitmap(myBitmap);</span></span><br><span class="line"><span class="addition">+        image.setBackgroundResource(myBitmap);</span></span><br></pre></td></tr></table></figure>
<p>setBackgroundResource의 경우는 recycle 처리가 어렵다. 해당 메서드는 ImageView가 아닌 View자체의 메서드를 사용함으로써 Drawable 객체를 반환하지 않는다.</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://theyoung.github.io/android-ART-GC-Log/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="whoami">
      <meta itemprop="description" content="my note">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Try Again">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/android-ART-GC-Log/" class="post-title-link" itemprop="url">android_ART_GC_Log</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-29 14:37:40" itemprop="dateCreated datePublished" datetime="2019-03-29T14:37:40Z">2019-03-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-14 03:34:33" itemprop="dateModified" datetime="2019-07-14T03:34:33Z">2019-07-14</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/android-ART-GC-Log/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="android-ART-GC-Log/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Android-Memory-ART"><a href="#Android-Memory-ART" class="headerlink" title="Android Memory ART"></a>Android Memory ART</h4><h5 id="ART의-목적"><a href="#ART의-목적" class="headerlink" title="ART의 목적"></a>ART의 목적</h5><p>안드로이드 상 시스템이나 어플리케이션에 의해 관리 되는 Android Runtime을 대표 하는 말로써, 오직 안드로이드 프로젝트를 위해서만 만들어졌다. ART나 달빅의 경우는 Dex bytecode 러닝에 적합하게 만들어 졌다.</p>
<h6 id="Ahead-of-tiem-AOT-compilation"><a href="#Ahead-of-tiem-AOT-compilation" class="headerlink" title="Ahead-of-tiem (AOT) compilation"></a>Ahead-of-tiem (AOT) compilation</h6><p>인스톨 및 작동 시간을 빠르게 하기 위해 있는 것으로 최초 apk를 install하게 되면 dex2oat라는 device 내부에 있는 tool을 이용해서 작동가능한 상태로 만들어 준다. </p>
<h6 id="Improved-garbage-collection"><a href="#Improved-garbage-collection" class="headerlink" title="Improved garbage collection"></a>Improved garbage collection</h6><ul>
<li>GC를 한번에 처리하게 만든다</li>
<li>GC pause동안 병행 프로세스 처리를 한다</li>
<li>작은 객체(만들어진지 얼마 안된 객체, short live 객체)들을 수집한다</li>
<li>GC 처리를 적절하게 병행 처리 함으로써 <code>GC_FOR_ALLOC</code>이 최대한 발생 하지 않게 한다</li>
<li>백그라운드 메모리 사용이나, 메모리 파편화를 줄여 준다 (Compacting GC) </li>
</ul>
<h6 id="Development-and-debugging-improvements"><a href="#Development-and-debugging-improvements" class="headerlink" title="Development and debugging improvements"></a>Development and debugging improvements</h6><p>아래와 같은 오류 정보들을 ART가 제공하게 된다.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.lang.NullPointerException: Attempt to write to field &apos;int</span><br><span class="line">android.accessibilityservice.AccessibilityServiceInfo.flags&apos; on a null object</span><br><span class="line">reference</span><br></pre></td></tr></table></figure>
<h5 id="ART-로그-설명"><a href="#ART-로그-설명" class="headerlink" title="ART 로그 설명"></a>ART 로그 설명</h5><p>Art(Android Runtime)는 명시적으로 요청된 Garbage Collection에 대해서만 결과를 출력함</p>
<p>출력 형태는 다음과 같음</p>
<p> <code>I/art: &lt;GC_Reason&gt; &lt;GC_Name&gt; &lt;Objects_freed&gt;(&lt;Size_freed&gt;) AllocSpace Objects, &lt;Large_objects_freed&gt;(&lt;Large_object_size_freed&gt;) &lt;Heap_stats&gt; LOS objects, &lt;Pause_time(s)&gt;</code></p>
<p>실제 사용은 다음과 같이 출력됨</p>
<p><code>I art     : Explicit concurrent mark sweep GC freed 64(14KB) AllocSpace objects, 2(72KB) LOS objects, 24% free, 4MB/5MB, paused 448us total 20.082ms:</code></p>
<p>조금더 자세하게 나누어 보면 다음과 같음</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Type</th>
<th>대상</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>GC_Reason</td>
<td>Explicit</td>
<td>- Concurrent : 앱스레드 중단 않는 GC (백그라운드 실행)<br>- Alloc : 힙이 이미 가득 차서 더 이상 요청받은 메모리 할당을 할 수없어서, GC를 우선 실행 시킴<br>-Explicit : 앱이 명시적인 GC를 요청함. gc() 호출<br>- NativeAlloc : Bitmap또는 Renderscript 할당과 같은 <strong><u>Native 메모리</u></strong> 할당을 위해서 실행 되는 GC (허니비를 기점으로 Bitmap은 힙으로 위치를 변경하였다)<br>- CollectorTransition : RAM 사양이 낮은 기기에서 앱의 프로세스 상태 일시 중지 및 인식 할 수없는 상태로 변경 할때 변환이 발생함(메모리 공간을 범프 포인터 공간으로 복사하는 작업임)(Eden 영역에서 -&gt; Survivor 영역으로의 전환 과정으로 보임)<br>- HomogeneousSpaceCompact : 사용가능한 공간(메모리로 보임)의 압축 기법으로 백그라운드 상태에서 RAM사용량 감소와 힙 조각 모음을 위해 처리 하는 것으로 보임<br>- HeapTrim : 힙트림을 마주칠 때까지 수집이 차단 <br>- DisableMovingGc : 힙압축이 이루어지는 동안 GetPrimitiveArrayCritical이 사용 됨으로써 힙의 수집기 이동을 제한 시킴</td>
</tr>
<tr>
<td>GC_Name</td>
<td>concurrent mark sweep</td>
<td>- Concurrent mark sweep (CMS) : 이미지 공간 이외의 모든 공간을 회수하고 수집하는 완전한 힙 수집기<br>- Concurrent partial mark sweep : 이미지 및 zygote (app_process, 요청을 리스닝하고 요청 받은 클래스를 포크한다.)공간 이외의 공간을 전부 수집하는 수집기<br>- Concurrent sticky mark sweep : 마지막 GC이후로 할당된 객체만 회수 하는 세대별 수집기. 수집이 빠르고 일시 중지도 잘 안일어 남으로 자주 사용됨<br>-Marksweep + semispace : 공간 압축이나 힙전환시 사용되는 복사 GC</td>
</tr>
<tr>
<td>Objects_freed</td>
<td>freed 64</td>
<td>회수한 객체의 수(작은규모)</td>
</tr>
<tr>
<td>Size_freed</td>
<td>(14KB) AllocSpace objects, 2</td>
<td>GC를 통해서 회수한 바이트의 수</td>
</tr>
<tr>
<td>Large_objects_freed</td>
<td>2</td>
<td>회수한 객체의 수(큰 규모)</td>
</tr>
<tr>
<td>Large_object_size_freed</td>
<td>(72KB)</td>
<td>회수한 객체의 크기</td>
</tr>
<tr>
<td>Heap_stats</td>
<td>24% free, 4MB/5MB,</td>
<td>회수한 비율로 (라이브 객체수)/(총 힙 크기), 예를 들자면 4MB가 살아있는 개체이고 5MB가 전체 힙의 크기이다. 약 24% 1MB 정도가 비어 있는 상황이라고 보면 된다. 이 값으 전체 적으로 증가만 하고 있다면 메모리 릭이라고 생각해 봐야한다</td>
</tr>
<tr>
<td>Pause Times</td>
<td>paused 448us total 20.082ms</td>
<td>공식 문서상에는 일시 중지 횟수로 나와있으나 단위를 보면 일시 중지 시간이 맞는거 같다. 객체 수집시 나타나는 일시 중지 시간 평균 및 sum이 이 pause times으로 생각된다.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Android-Memory-Kill-순서"><a href="#Android-Memory-Kill-순서" class="headerlink" title="Android Memory Kill 순서"></a>Android Memory Kill 순서</h4><div class="table-container">
<table>
<thead>
<tr>
<th>시스템</th>
<th>관련 서비스</th>
<th>memory status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cached</td>
<td>현재 작동 되고 있지 않고 Background에 캐쉬 되어 있는 서비스들</td>
<td>lmk(Low memory killer) threshold</td>
</tr>
<tr>
<td>Previous</td>
<td>현재 작동 중인 서비스 직전에 사용된 서비스</td>
<td>critical</td>
</tr>
<tr>
<td>Home</td>
<td>Home 기능이라고 하는데 내용상 바탕화면의 Wall paper 정도로 보임</td>
<td>critical</td>
</tr>
<tr>
<td>Service</td>
<td>클라우드 서비스, 싱크 서비스 등 백그라운드 서비스</td>
<td>critical</td>
</tr>
<tr>
<td>Perceptible</td>
<td>조회기능, 오디오, 키보드 등 듣고 입력하는 기능 들로 보임</td>
<td>critical</td>
</tr>
<tr>
<td>Foreground</td>
<td>현재 떠있는 서비스</td>
<td>critical</td>
</tr>
<tr>
<td>Persistent</td>
<td>전화 본연의 기능 및 통신 프로톨(와이파이, 블루투스 등)</td>
<td>Crash ()</td>
</tr>
<tr>
<td>System</td>
<td>system_server</td>
<td>Crash (reboot)</td>
</tr>
<tr>
<td>Native</td>
<td>init, kswapd,netd, logd, adbd 등 native bin(exec) 프로세스</td>
<td>Crash (reboot)</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>맨 위에서 부터 순차적으로 프로세스가 kill되기 시작함</p>
<p>lmk : low memory killer</p>
<p>kswapd : kernel swap daemon</p>
</blockquote>
<h4 id="Android-Memory-Debug-Tool"><a href="#Android-Memory-Debug-Tool" class="headerlink" title="Android Memory Debug Tool"></a>Android Memory Debug Tool</h4><ul>
<li>Android Studio Profiler</li>
<li>showmap (사용방법?): <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL2FuZHJvaWQtNi4wLjFfcjI4L3Nob3dtYXAvc2hvd21hcC5j" title="https://android.googlesource.com/platform/system/extras/+/android-6.0.1_r28/showmap/showmap.c">https://android.googlesource.com/platform/system/extras/+/android-6.0.1_r28/showmap/showmap.c<i class="fa fa-external-link"></i></span> </li>
<li>ahat : <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vYXJ0LysvbWFzdGVyL3Rvb2xzL2FoYXQvUkVBRE1FLnR4dA==" title="https://android.googlesource.com/platform/art/+/master/tools/ahat/README.txt">https://android.googlesource.com/platform/art/+/master/tools/ahat/README.txt<i class="fa fa-external-link"></i></span></li>
<li>debug malloc : adb logcat -d | grep &quot;malloc debug&quot;  <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vYmlvbmljLysvbWFzdGVyL2xpYmMvbWFsbG9jX2RlYnVnL1JFQURNRS5tZA==" title="https://android.googlesource.com/platform/bionic/+/master/libc/malloc_debug/README.md">https://android.googlesource.com/platform/bionic/+/master/libc/malloc_debug/README.md<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>Profiler 만 사용하면 다른 툴을 쓸 필요가 없는 것으로 보인다. 단, malloc 같은 경우는 native 영역에 대한 내용을 볼 수 있는 유일한 방법으로 현재까지는 보임으로 native leak이 발생하면 쓸수 밖에 없지 않나 한다.</p>
</blockquote>
<h4 id="Android-RAM의-종류"><a href="#Android-RAM의-종류" class="headerlink" title="Android RAM의 종류"></a>Android RAM의 종류</h4><h5 id="RAM-사용량-Command"><a href="#RAM-사용량-Command" class="headerlink" title="RAM 사용량 Command"></a>RAM 사용량 Command</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb shell dumpsys meminfo &lt;package_name|pid&gt; [-d]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>해당 명령어는 adb connect 가 되어있다는 전제이다</p>
</blockquote>
<ul>
<li>-d 옵션 의미 : Dalvick 및 ART 메모리 사용량에 대한 정보가 상세히 출력된다</li>
<li>기본적을 KB단위로 나열된다.  </li>
</ul>
<h5 id="개인-클림-및-더티-RAM"><a href="#개인-클림-및-더티-RAM" class="headerlink" title="개인(클림 및 더티) RAM"></a>개인(클림 및 더티) RAM</h5><p>RAM은 특정 APP에서만 사용중인 메모리로써, 해당 메모리의 양은 특정 APP의 서비스가 프로세스 킬되었을 때 온전히 Free RAM으로 되돌려 받을 수 있는 양이다. 이중에 개인 더티 RAM은 Android 스왑을 사용하지 않기 때문에 가장 중요한 대상이 된다. 메모리 Leak을 해결 해야 하는 이유도 이부분에 있다. 개발자가 지정하는 모든 Dalvik 및 Native 힙 메모리는 더티 RAM으로 처리된다. Zygote를 사용하는 공유 RAM도 있게 되는데 이부분은 공유 더티 Ram으로 불린다.</p>
<h5 id="PSS-Propotional-Set-Size"><a href="#PSS-Propotional-Set-Size" class="headerlink" title="PSS(Propotional Set Size)"></a>PSS(Propotional Set Size)</h5><p>PSS는 하나의 프로세스만을 바라보는 사이징 방식이 아니라, 공유되는 모든 페이지에 대한 RAM까지 포함한 계산 방식이다. 예를 들자면 프로세스 2개가 2메가를 공유하는 프로세스를 접근 하고 있다면, 1MB씩 PSS 사이즈를 분배 받게 된다. 그외 개인 더티 RAM 사이즈는 직접적으로 PSS에 추가 된다.</p>
<p>정리하자면 다음과 같다.</p>
<ul>
<li>PSS Size = 프로세스1 개인 더티 RAM + 프로세스 2 개인 더티 RAM + 프로세스 3 공유 RAM 절반 </li>
</ul>
<blockquote>
<p>PSS외에 2가지 종류가 더 있다</p>
<p>RSS : Resident Set Size = Private 더티 RAM + Shared RAM 전체</p>
<p>USS : Unique Set Size = RSS - shared RAM 전체  = Private Dirty RAM만 대상으로 함</p>
</blockquote>
<p>아래는 com.example.app의 메모리 사용량을 나타낸다.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Applications Memory Usage (kB):</span><br><span class="line">Uptime: 2452592 Realtime: 2452592</span><br><span class="line"></span><br><span class="line">** MEMINFO in pid 4739 [com.example.app] **</span><br><span class="line">                   Pss  Private  Private  Swapped     Heap     Heap     Heap</span><br><span class="line">                 Total    Dirty    Clean    Dirty     Size    Alloc     Free</span><br><span class="line">                ------   ------   ------   ------   ------   ------   ------</span><br><span class="line">  Native Heap     6691     6648        0        0    16384     8945     7438</span><br><span class="line">  Dalvik Heap     1664     1512        0        0     7045     5418     1627</span><br><span class="line"> Dalvik Other      304      304        0        0</span><br><span class="line">        Stack      392      392        0        0</span><br><span class="line">       Ashmem      128      128        0        0</span><br><span class="line">    Other dev        4        0        4        0</span><br><span class="line">     .so mmap     8218      260     1640        0</span><br><span class="line">    .apk mmap      305        0       24        0</span><br><span class="line">    .ttf mmap       93        0        0        0</span><br><span class="line">    .dex mmap     2124        0     1776        0</span><br><span class="line">    .oat mmap     2144        0       64        0</span><br><span class="line">    .art mmap     2214     1988        4        0</span><br><span class="line">   Other mmap      296        4        0        0</span><br><span class="line">      Unknown     2072     2072        0        0</span><br><span class="line">        TOTAL    26649    13308     3512        0    23429    14363     9065</span><br><span class="line"></span><br><span class="line"> Dalvik Details</span><br><span class="line">        .Heap      964      964        0        0</span><br><span class="line">          .GC      188      188        0        0</span><br><span class="line">      .Zygote      424      272        0        0</span><br><span class="line">   .NonMoving      276      276        0        0</span><br><span class="line"> .IndirectRef      116      116        0        0</span><br><span class="line"></span><br><span class="line"> Objects</span><br><span class="line">               Views:        9         ViewRootImpl:        0</span><br><span class="line">         AppContexts:        3           Activities:        1</span><br><span class="line">              Assets:        3        AssetManagers:        3</span><br><span class="line">       Local Binders:       13        Proxy Binders:       15</span><br><span class="line">       Parcel memory:        5         Parcel count:       20</span><br><span class="line">    Death Recipients:        0      OpenSSL Sockets:        0</span><br><span class="line"></span><br><span class="line"> SQL</span><br><span class="line">         MEMORY_USED:        0</span><br><span class="line">  PAGECACHE_OVERFLOW:        0          MALLOC_SIZE:        0</span><br></pre></td></tr></table></figure>
<h6 id="Dalvik-Heap"><a href="#Dalvik-Heap" class="headerlink" title="Dalvik Heap"></a>Dalvik Heap</h6><p>자바 머신인 달빅의 heap 모델은 External과 Dalvik heap으로 나뉘게 되는데 이중에 Dalvik Heap은</p>
<ul>
<li>Java객체 인스턴스 메모리 할당</li>
<li>Zygote 할당 영역 포함</li>
</ul>
<p>을 하게 된다.</p>
<p>그러나 java의 메모리 범위 밖을 보게 된다면 Native Heap이 나타나게 되는데, 이부분은 OS 영역의 메모리를 사용하는 범위로 주로 NDK로 개발된 경우 C++, C로 개발된 로우레벨 라이브러리를 사용하는 경우가 된다.</p>
<ul>
<li>Bitmap의 경우 가장 대표적인 Native Heap 저장 대상이다.</li>
</ul>
<p>Java는 Bitmap data를 Native Heap 부분으로 Pointing하는 역할만 한다.</p>
<h6 id="Dalvik-Other"><a href="#Dalvik-Other" class="headerlink" title="Dalvik Other"></a>Dalvik Other</h6><p>문서상으로는 정확히 명시 되어 있지는 않는데 참고 문항으로 추리 해보면 다음과 같이 생각하면 될것 같다</p>
<ul>
<li>Just in time 컴파일 기록</li>
<li>GC 기록</li>
</ul>
<p>등 Dalvik Overhead</p>
<blockquote>
<p>추측이긴 한데 ART에서 생성되는 각종 정보가 이쪽 메모리 사이즈로 쌓이는 것으로 생각된다.</p>
</blockquote>
<h6 id="Heap-Alloc"><a href="#Heap-Alloc" class="headerlink" title="Heap Alloc"></a>Heap Alloc</h6><p>해당 앱에 할당된 메모리 크기 인다. 이게 PSS Total보다 큰 이유는 공유 자원에 대한 값까지 같이 포함 하고 있기 때문이라고 한다.</p>
<h6 id="Private-Dirty"><a href="#Private-Dirty" class="headerlink" title="Private Dirty"></a>Private Dirty</h6><p>해당 앱 프로세스 내부에서만 사용되는 메모리로 타 앱 및 프로세스와 공유 되지 않는다. 프로세스가 종료 되면 이 메모리는 100% 반환 되어야 한다.</p>
<h6 id="Private-Cean"><a href="#Private-Cean" class="headerlink" title="Private Cean"></a>Private Cean</h6><p>개발자 앱의 자체 코드임, 개발자가 만든 code자체에 대한 글이 이곳에 적제 되는 것으로 보임</p>
<p>so,dex mmap과 관련이 있음</p>
<p>.so에는 private 더티 RAM이 크게 할당 되어있는데 이는 네이티브 코드를 최종 주소 로드 할때 수정했기 때문이다.</p>
<blockquote>
<p>실행 중인 코드에 대한 정보를 담는 부분으로 보임</p>
</blockquote>
<h6 id="so-dex-mmap"><a href="#so-dex-mmap" class="headerlink" title=".so .dex mmap"></a>.so .dex mmap</h6><p>.so 네이티브 및 .dex 달빅 또는 ART를 위한 코드용으로 사용하는 RAM</p>
<h6 id="oat-mmap"><a href="#oat-mmap" class="headerlink" title=".oat mmap"></a>.oat mmap</h6><p>여러 앱이 공통적으로 사용하는 앱의 메모리 공간으로 특정 앱에 영향을 받지 않음</p>
<h6 id="Unknow"><a href="#Unknow" class="headerlink" title=".Unknow"></a>.Unknow</h6><p>도구가 식별하기 힘든 RAM 페이지로, 주로 네이티브 할당이 주를 이룬다. </p>
<h6 id="Dalvik-Detail"><a href="#Dalvik-Detail" class="headerlink" title="Dalvik Detail"></a>Dalvik Detail</h6><p>.Heap : 앱의 힙의 메모리 크기 (zygote 공간 과 private 공간 포함)</p>
<p>.LOS : ART 대형 객체 공간 메모리</p>
<p>.GC : GC 계정 오버헤드 크기로 수정할 수없음</p>
<p>.JITCache : 실행되는 시점으로 o이 될것임</p>
<p>.Zygote : 공통 메모리 크기</p>
<p>.NonMoving : ART 비이동 공간 사용 RAM, 앱에서 사용하는 필드와 메서드 수를 줄이면 이부분이 줄어듬</p>
<p>.IndirectRef : ART 간접 참조 테이블, 로컬 및 전역 JNI 참조 수를 줄이면 줄일 수 있음</p>
<h6 id="Objects"><a href="#Objects" class="headerlink" title="Objects"></a>Objects</h6><p>Views : 모든 View 객체의 수이다. 만약에 layout에 버튼 3개가 있고 views가 9인 상태라면, 하나의 버튼을 삭제 하면 8이 된다.</p>
<p>ViewRootImpl : 현재 작동중인 View의 갯수. 보이지 않는 창이라던가 연관되어있는 view와의 갯수를 확인해서 메모리 누수를 확인 할 수있다.</p>
<blockquote>
<p>화면이 안떠있다면 0, 한개 View가 떠있다면 1이런식이다.</p>
</blockquote>
<p>Activities</p>
<p>Activity의 갯수로써 현재 떠있는 Activity의 갯수가 된다. 한개의 큰 화면만 떠있다면 Activity는 1개이다</p>
<p>AppContexts</p>
<blockquote>
<p>만약에 Activity A가 죽고 Activity B가 살아나는 시점에, A의 context가 살아있다면(Leak) 이때 AppContexts는 지속적으로 증가하는 것으로 보임</p>
</blockquote>
<p>ProxyBinders/Parcel count/Local Binders</p>
<blockquote>
<p>lyaout 상 객체를 Bind 하면서 카운트가 올라 가는 것으로 보임</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/apple-touch-icon-next.png" alt="whoami">
            
              <p class="site-author-name" itemprop="name">whoami</p>
              <div class="site-description motion-element" itemprop="description">my note</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">52</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZXlvdW5nL3RoZXlvdW5nLmdpdGh1Yi5pbw==" title="GitHub &rarr; https://github.com/theyoung/theyoung.github.io"><i class="fa fa-fw fa-github"></i></span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="bWFpbHRvOnN1cHBvcnRAdGhleW91bmcyMDAyQG5hdmVyLmNvbQ==" title="E-Mail &rarr; mailto:support@theyoung2002@naver.com"><i class="fa fa-fw fa-envelope"></i></span>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
             </div>
          

          
          

          
            
          
          

        </div>
      </div>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NexT</span>

  

  
</div>


  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span> v7.0.1</div>



  <div class="footer-custom">Theme source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0">here</span><br>Website source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=">here</span></div>


        








        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>







  




















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>




  

  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  
  <script src="/js/src/exturl.js?v=7.0.1"></script>


  

  
  
  <script id="dsq-count-scr" src="https://https-theyoung-github-io.disqus.com/count.js" async></script>







  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
  

  


  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
