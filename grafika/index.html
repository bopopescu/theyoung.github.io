<!DOCTYPE html>













<html class="theme-next gemini" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">














  <meta name="yandex-verification" content="3ac9ae36ddebb425">













<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"onmobile":true},
    back2top: true,
    back2top_sidebar: true,
    fancybox: false,
    fastclick: false,
    lazyload: true,
    tabs: true,
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="테스트 mp4파일 받기com.android.grafika     public static void initialize(Context context) &amp;#123;        ContentManager mgr = getInstance();        synchronized (sLock) &amp;#123;            if (!mgr.mInitialized">
<meta name="keywords" content="android,Grafika,texture surface,video,flip,mirror">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Grafika Texture Surface">
<meta property="og:url" content="https://theyoung.github.io/grafika/index.html">
<meta property="og:site_name" content="Try Again">
<meta property="og:description" content="테스트 mp4파일 받기com.android.grafika     public static void initialize(Context context) &amp;#123;        ContentManager mgr = getInstance();        synchronized (sLock) &amp;#123;            if (!mgr.mInitialized">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-07-04T02:25:46.209Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android Grafika Texture Surface">
<meta name="twitter:description" content="테스트 mp4파일 받기com.android.grafika     public static void initialize(Context context) &amp;#123;        ContentManager mgr = getInstance();        synchronized (sLock) &amp;#123;            if (!mgr.mInitialized">






  <link rel="canonical" href="https://theyoung.github.io/grafika/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Android Grafika Texture Surface | Try Again</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  

  <div class="container page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Try Again</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">anything</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-news">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-bullhorn"></i> <br>News</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">21</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://theyoung.github.io/grafika/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="whoami">
      <meta itemprop="description" content="my note">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Try Again">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Android Grafika Texture Surface

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-19 19:32:33" itemprop="dateCreated datePublished" datetime="2019-04-19T19:32:33Z">2019-04-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-07-04 02:25:46" itemprop="dateModified" datetime="2019-07-04T02:25:46Z">2019-07-04</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/grafika/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="grafika/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="테스트-mp4파일-받기"><a href="#테스트-mp4파일-받기" class="headerlink" title="테스트 mp4파일 받기"></a>테스트 mp4파일 받기</h3><p>com.android.grafika</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">    public static void initialize(Context context) &#123;</span><br><span class="line">        ContentManager mgr = getInstance();</span><br><span class="line">        synchronized (sLock) &#123;</span><br><span class="line">            if (!mgr.mInitialized) &#123;</span><br><span class="line"><span class="addition">+                mgr.mFilesDir = context.getExternalFilesDir(Environment.DIRECTORY_MOVIES);</span></span><br><span class="line"><span class="deletion">- //                mgr.mFilesDir = context.getFilesDir();</span></span><br><span class="line">                mgr.mContent = new ArrayList&lt;Content&gt;();</span><br><span class="line">                mgr.mInitialized = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>app 인터널 storage를 external로 변경</p>
<p>앱 재실행 후 파일 다운로드 표시 끝나면 android file explore를 이용해서 </p>
<p><code>sdcard&gt; Android &gt; data &gt; com.google.grafica &gt; files &gt; Movies</code></p>
<p>이하를 조회하면,</p>
<ul>
<li>gen-eight-rects.mp4</li>
<li>gen-sliders.mp4</li>
</ul>
<p>파일 확인 가능함</p>
<h3 id="MediaFormat"><a href="#MediaFormat" class="headerlink" title="MediaFormat"></a>MediaFormat</h3><p>비디오 파일(예, mp4)등의 header를 분석한 결과 <code>MediaExtractor</code>를 통해서 정보를 추출할 수 있음</p>
<p>아래 소스는 android app 내의 res&gt;raw 이하에 비디오나 오디오 파일을 위치 시켰을 때 uri 방식으로 수신 할 수 있는 코드이다.</p>
<p>관련 수정사항은 <code>extractor.setDataSource(ctx,uri,null);</code> 이 부분 전후를 보면 된다.</p>
<p>해당 메서드를 요청하는 방법은 Activity에서 아래와 같이 call 하면 된다</p>
<p><code>player = new MoviePlayer(getApplicationContext(), Uri.parse(&quot;android.resource://&quot;+getPackageName()+&quot;/raw/gen_eight_rects&quot;), surface, callback);</code></p>
<p><strong>MoviePlayer.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MoviePlayer</span><span class="params">(Context ctx, Uri uri, Surface outputSurface, FrameCallback frameCallback)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        mContext = ctx;</span><br><span class="line">        mUri = uri;</span><br><span class="line"><span class="comment">//        mSourceFile = sourceFile;</span></span><br><span class="line">        mOutputSurface = outputSurface;</span><br><span class="line">        mFrameCallback = frameCallback;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pop the file open and pull out the video characteristics.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> consider leaving the extractor open.  Should be able to just seek back to</span></span><br><span class="line">        <span class="comment">//       the start after each iteration of play.  Need to rearrange the API a bit --</span></span><br><span class="line">        <span class="comment">//       currently play() is taking an all-in-one open+work+release approach.</span></span><br><span class="line">        MediaExtractor extractor = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line">            extractor.setDataSource(ctx,uri,<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">int</span> trackIndex = selectTrack(extractor);</span><br><span class="line">            <span class="keyword">if</span> (trackIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No video track found in "</span> + mSourceFile);</span><br><span class="line">            &#125;</span><br><span class="line">            extractor.selectTrack(trackIndex);</span><br><span class="line"></span><br><span class="line">            MediaFormat format = extractor.getTrackFormat(trackIndex);</span><br><span class="line">            mVideoWidth = format.getInteger(MediaFormat.KEY_WIDTH);</span><br><span class="line">            mVideoHeight = format.getInteger(MediaFormat.KEY_HEIGHT);</span><br><span class="line">            <span class="keyword">if</span> (VERBOSE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"Video size is "</span> + mVideoWidth + <span class="string">"x"</span> + mVideoHeight);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (extractor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                extractor.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the width, in pixels, of the video.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVideoWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mVideoWidth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the height, in pixels, of the video.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVideoHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mVideoHeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the loop mode.  If true, playback will loop forever.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoopMode</span><span class="params">(<span class="keyword">boolean</span> loopMode)</span> </span>&#123;</span><br><span class="line">        mLoop = loopMode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Asks the player to stop.  Returns without waiting for playback to halt.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Called from arbitrary thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mIsStopRequested = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decodes the video stream, sending frames to the surface.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Does not return until video playback is complete, or we get a "stop" signal from</span></span><br><span class="line"><span class="comment">     * frameCallback.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        MediaExtractor extractor = <span class="keyword">null</span>;</span><br><span class="line">        MediaCodec decoder = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> fileBased = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// The MediaExtractor error messages aren't very useful.  Check to see if the input</span></span><br><span class="line">        <span class="comment">// file exists so we can throw a better one if it's not there.</span></span><br><span class="line">        <span class="keyword">if</span> (mSourceFile != <span class="keyword">null</span> &amp;&amp; !mSourceFile.canRead()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"Unable to read "</span> + mSourceFile);</span><br><span class="line">        &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">            fileBased = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line"><span class="comment">//            extractor.setDataSource(mSourceFile.toString());</span></span><br><span class="line">            extractor.setDataSource(mContext,mUri,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> trackIndex = selectTrack(extractor);</span><br><span class="line">            <span class="keyword">if</span> (trackIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No video track found in "</span> + mSourceFile);</span><br><span class="line">            &#125;</span><br><span class="line">            extractor.selectTrack(trackIndex);</span><br><span class="line"></span><br><span class="line">            MediaFormat format = extractor.getTrackFormat(trackIndex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a MediaCodec decoder, and configure it with the MediaFormat from the</span></span><br><span class="line">            <span class="comment">// extractor.  It's very important to use the format from the extractor because</span></span><br><span class="line">            <span class="comment">// it contains a copy of the CSD-0/CSD-1 codec-specific data chunks.</span></span><br><span class="line">            String mime = format.getString(MediaFormat.KEY_MIME);</span><br><span class="line">            decoder = MediaCodec.createDecoderByType(mime);</span><br><span class="line">            decoder.configure(format, mOutputSurface, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">            decoder.start();</span><br><span class="line"></span><br><span class="line">            doExtract(extractor, trackIndex, decoder, mFrameCallback);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// release everything we grabbed</span></span><br><span class="line">            <span class="keyword">if</span> (decoder != <span class="keyword">null</span>) &#123;</span><br><span class="line">                decoder.stop();</span><br><span class="line">                decoder.release();</span><br><span class="line">                decoder = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (extractor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                extractor.release();</span><br><span class="line">                extractor = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>MediaFormat format = extractor.getTrackFormat(trackIndex);</code>이 부분이 track 으로 부터 Media의 정보를 얻어오는 부분이다. </p>
<h4 id="Audio-Video-공통-포멧-정보"><a href="#Audio-Video-공통-포멧-정보" class="headerlink" title="Audio / Video 공통 포멧 정보"></a>Audio / Video 공통 포멧 정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Value Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>KEY_MIME</code></td>
<td style="text-align:left">String</td>
<td style="text-align:left">The type of the format.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_MAX_INPUT_SIZE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional, maximum size of a buffer of input data</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_BIT_RATE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, desired bitrate in bits/second</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Video-포멧-정보"><a href="#Video-포멧-정보" class="headerlink" title="Video 포멧 정보"></a>Video 포멧 정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Value Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>KEY_WIDTH</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_HEIGHT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_COLOR_FORMAT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">set by the user for encoders, readable in the output format of decoders</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_FRAME_RATE</code></td>
<td style="text-align:left">Integer or Float</td>
<td style="text-align:left">required for <strong>encoders</strong>, optional for <strong>decoders</strong></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_CAPTURE_RATE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_I_FRAME_INTERVAL</code></td>
<td style="text-align:left">Integer (or Float)</td>
<td style="text-align:left"><strong>encoder-only</strong>, time-interval between key frames. Float support added in <code>Build.VERSION_CODES.N_MR1</code></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_INTRA_REFRESH_PERIOD</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_LATENCY</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_MAX_WIDTH</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, max-resolution width</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_MAX_HEIGHT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, max-resolution height</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_REPEAT_PREVIOUS_FRAME_AFTER</code></td>
<td style="text-align:left">Long</td>
<td style="text-align:left"><strong>encoder in surface-mode only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_PUSH_BLANK_BUFFERS_ON_STOP</code></td>
<td style="text-align:left">Integer(1)</td>
<td style="text-align:left"><strong>decoder rendering to a surface only</strong>, optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_TEMPORAL_LAYERING</code></td>
<td style="text-align:left">String</td>
<td style="text-align:left"><strong>encoder only</strong>, optional, temporal-layering schema</td>
</tr>
</tbody>
</table>
</div>
<h4 id="오디오-포멧정보"><a href="#오디오-포멧정보" class="headerlink" title="오디오 포멧정보"></a>오디오 포멧정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Value Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>KEY_CHANNEL_COUNT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_SAMPLE_RATE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_PCM_ENCODING</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_IS_ADTS</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional, if <em>decoding</em> AAC audio content, setting this key to 1 indicates that each audio frame is prefixed by the ADTS header.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_PROFILE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional, if content is AAC audio, specifies the desired profile.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_SBR_MODE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional, if content is AAC audio, specifies the desired SBR mode.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_TARGET_REFERENCE_LEVEL</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the target reference level.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_ENCODED_TARGET_LEVEL</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the target reference level used at encoder.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_BOOST_FACTOR</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the DRC boost factor.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_ATTENUATION_FACTOR</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the DRC attenuation factor.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_HEAVY_COMPRESSION</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies whether to use heavy compression.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_MAX_OUTPUT_CHANNEL_COUNT</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the maximum number of channels the decoder outputs.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_AAC_DRC_EFFECT_TYPE</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>decoder-only</strong>, optional, if content is AAC audio, specifies the MPEG-D DRC effect type to use.</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_CHANNEL_MASK</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left">optional, a mask of audio channel assignments</td>
</tr>
<tr>
<td style="text-align:left"><code>KEY_FLAC_COMPRESSION_LEVEL</code></td>
<td style="text-align:left">Integer</td>
<td style="text-align:left"><strong>encoder-only</strong>, optional, if content is FLAC audio, specifies the desired compression level.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="자막정보"><a href="#자막정보" class="headerlink" title="자막정보"></a>자막정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Name</th>
<th>Value Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>KEY_MIME</code></td>
<td>String</td>
<td>The type of the format.</td>
</tr>
<tr>
<td><code>KEY_LANGUAGE</code></td>
<td>String</td>
<td>The language of the content.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="이미지-정보"><a href="#이미지-정보" class="headerlink" title="이미지 정보"></a>이미지 정보</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Name</th>
<th>Value Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>KEY_MIME</code></td>
<td>String</td>
<td>The type of the format.</td>
</tr>
<tr>
<td><code>KEY_WIDTH</code></td>
<td>Integer</td>
<td></td>
</tr>
<tr>
<td><code>KEY_HEIGHT</code></td>
<td>Integer</td>
<td></td>
</tr>
<tr>
<td><code>KEY_COLOR_FORMAT</code></td>
<td>Integer</td>
<td>set by the user for encoders, readable in the output format of decoders</td>
</tr>
<tr>
<td><code>KEY_TILE_WIDTH</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
<tr>
<td><code>KEY_TILE_HEIGHT</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
<tr>
<td><code>KEY_GRID_ROWS</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
<tr>
<td><code>KEY_GRID_COLUMNS</code></td>
<td>Integer</td>
<td>required if the image has grid</td>
</tr>
</tbody>
</table>
</div>
<h3 id="MediaCodec"><a href="#MediaCodec" class="headerlink" title="MediaCodec"></a>MediaCodec</h3><p>미디어 코덱은 미디어 데이터의 제공자와 미디어 데이터를 소비하는 소비자의 중간에 위치하는 존재이다.</p>
<p>즉,</p>
<p>(미디어 데이터 제공자) --(encoded data stream)--&gt; <strong>[MediaCodec]</strong> --(decoded data stream) --&gt;(소비자) </p>
<p>형태로 나타나게 된다.</p>
<p>MoviePalyer 소스 코드를 보자면</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        MediaExtractor extractor = <span class="keyword">null</span>;</span><br><span class="line">        MediaCodec decoder = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> fileBased = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// The MediaExtractor error messages aren't very useful.  Check to see if the input</span></span><br><span class="line">        <span class="comment">// file exists so we can throw a better one if it's not there.</span></span><br><span class="line">        <span class="keyword">if</span> (mSourceFile != <span class="keyword">null</span> &amp;&amp; !mSourceFile.canRead()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"Unable to read "</span> + mSourceFile);</span><br><span class="line">        &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">            fileBased = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line"><span class="comment">//            extractor.setDataSource(mSourceFile.toString());</span></span><br><span class="line">            extractor.setDataSource(mContext,mUri,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> trackIndex = selectTrack(extractor);</span><br><span class="line">            <span class="keyword">if</span> (trackIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No video track found in "</span> + mSourceFile);</span><br><span class="line">            &#125;</span><br><span class="line">            extractor.selectTrack(trackIndex);</span><br><span class="line"></span><br><span class="line">            MediaFormat format = extractor.getTrackFormat(trackIndex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a MediaCodec decoder, and configure it with the MediaFormat from the</span></span><br><span class="line">            <span class="comment">// extractor.  It's very important to use the format from the extractor because</span></span><br><span class="line">            <span class="comment">// it contains a copy of the CSD-0/CSD-1 codec-specific data chunks.</span></span><br><span class="line">            String mime = format.getString(MediaFormat.KEY_MIME);</span><br><span class="line">            decoder = MediaCodec.createDecoderByType(mime);</span><br><span class="line">            decoder.configure(format, mOutputSurface, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">            decoder.start();</span><br></pre></td></tr></table></figure>
<p><code>String mime = format.getString(MediaFormat.KEY_MIME);
            decoder = MediaCodec.createDecoderByType(mime);
            decoder.configure(format, mOutputSurface, null, 0);
            decoder.start();</code></p>
<p>이 부분이 MediaCodec을 생산자와 소비자의 사이에 위치 시키는 역할을 한다.</p>
<p>위치를 시킨후 실행 시키는 코드가 <code>decoder.start()</code>이다</p>
<h4 id="start"><a href="#start" class="headerlink" title="start"></a>start</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void start ()</span><br></pre></td></tr></table></figure>
<p>환경 설정이 완료 된 이후 start를 실행 하면 비로소, 비동기적으로 생산자로 부터 버퍼를 읽어서 디코딩 처리 하기 시작한다.</p>
<h4 id="Buffer얻어-오기"><a href="#Buffer얻어-오기" class="headerlink" title="Buffer얻어 오기"></a>Buffer얻어 오기</h4><h5 id="Syncronized"><a href="#Syncronized" class="headerlink" title="Syncronized"></a>Syncronized</h5><h6 id="API21-롤리팝-이후-deprecated-된-방법-grafika"><a href="#API21-롤리팝-이후-deprecated-된-방법-grafika" class="headerlink" title="API21(롤리팝) 이후 deprecated 된 방법 (grafika)"></a>API21(롤리팝) 이후 deprecated 된 방법 (grafika)</h6><p>grafika의 Movie Player는 이 방법을 사용해서 Data Stream을 접근 하고 있다.</p>
<ul>
<li><p>버퍼의 형식은 ByteBuffer[]</p>
</li>
<li><p>start() Call 이후 부터 버퍼를 얻어 오는 방식은 getInput과 OutputBuffers를 사용하는 방법이다. 양수의 buffer id를 기준으로 얻어온다.</p>
</li>
<li><p><code>dequeueInputBuffer()</code> , <code>dequeueOutputBuffer()</code>는 비동기 스레드에 상태를 확인하기 위한 api이다. 비록 Syncronized 방식이라고 해도 이점은 변하지 않는다.</p>
<blockquote>
<p>파라메터로 timeoutUs 가 사용되는데, 해당 값은 상위 상태 변화를 확인하기 위해 기다리는 시간이다. 해당 시간을 기다려도 state의 변화가 생기지 않는다면,  해당 media data는 invalidate 처리 되게 된다. timeoutUs가 0이하면 무한이 기다리게 된다. 0이면 기다리지 않고 즉각 return 처리 한다.</p>
</blockquote>
</li>
</ul>
<p><strong>MoviePlayer.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExtract</span><span class="params">(MediaExtractor extractor, <span class="keyword">int</span> trackIndex, MediaCodec decoder,</span></span></span><br><span class="line"><span class="function"><span class="params">                       FrameCallback frameCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> TIMEOUT_USEC = <span class="number">10000</span>;</span><br><span class="line">    ByteBuffer[] decoderInputBuffers = decoder.getInputBuffers();</span><br><span class="line">    <span class="keyword">int</span> inputChunk = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> firstInputTimeNsec = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> outputDone = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> inputDone = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!outputDone) &#123;</span><br><span class="line">        <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"loop"</span>);</span><br><span class="line">        <span class="keyword">if</span> (mIsStopRequested) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"Stop requested"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feed more data to the decoder.</span></span><br><span class="line">        <span class="keyword">if</span> (!inputDone) &#123;</span><br><span class="line">            <span class="keyword">int</span> inputBufIndex = decoder.dequeueInputBuffer(TIMEOUT_USEC);</span><br><span class="line">            <span class="keyword">if</span> (inputBufIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (firstInputTimeNsec == -<span class="number">1</span>) &#123;</span><br><span class="line">                    firstInputTimeNsec = System.nanoTime();</span><br><span class="line">                &#125;</span><br><span class="line">                ByteBuffer inputBuf = decoderInputBuffers[inputBufIndex];</span><br><span class="line">                <span class="comment">// Read the sample data into the ByteBuffer.  This neither respects nor</span></span><br><span class="line">                <span class="comment">// updates inputBuf's position, limit, etc.</span></span><br><span class="line">                <span class="keyword">int</span> chunkSize = extractor.readSampleData(inputBuf, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (chunkSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// End of stream -- send empty frame with EOS flag set.</span></span><br><span class="line">                    decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0L</span>,</span><br><span class="line">                            MediaCodec.BUFFER_FLAG_END_OF_STREAM);</span><br><span class="line">                    inputDone = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"sent input EOS"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (extractor.getSampleTrackIndex() != trackIndex) &#123;</span><br><span class="line">                        Log.w(TAG, <span class="string">"WEIRD: got sample from track "</span> +</span><br><span class="line">                                extractor.getSampleTrackIndex() + <span class="string">", expected "</span> + trackIndex);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">long</span> presentationTimeUs = extractor.getSampleTime();</span><br><span class="line">                    decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, chunkSize,</span><br><span class="line">                            presentationTimeUs, <span class="number">0</span> <span class="comment">/*flags*/</span>);</span><br><span class="line">                    <span class="keyword">if</span> (VERBOSE) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">"submitted frame "</span> + inputChunk + <span class="string">" to dec, size="</span> +</span><br><span class="line">                                chunkSize);</span><br><span class="line">                    &#125;</span><br><span class="line">                    inputChunk++;</span><br><span class="line">                    extractor.advance();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"input buffer not available"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!outputDone) &#123;</span><br><span class="line">            <span class="keyword">int</span> decoderStatus = decoder.dequeueOutputBuffer(mBufferInfo, TIMEOUT_USEC);</span><br><span class="line">            <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) &#123;</span><br><span class="line">                <span class="comment">// no output available yet</span></span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"no output from decoder available"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) &#123;</span><br><span class="line">                <span class="comment">// not important for us, since we're using Surface</span></span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output buffers changed"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">                MediaFormat newFormat = decoder.getOutputFormat();</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output format changed: "</span> + newFormat);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"unexpected result from decoder.dequeueOutputBuffer: "</span> +</span><br><span class="line">                                decoderStatus);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// decoderStatus &gt;= 0</span></span><br><span class="line">                <span class="keyword">if</span> (firstInputTimeNsec != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Log the delay from the first buffer of input to the first buffer</span></span><br><span class="line">                    <span class="comment">// of output.</span></span><br><span class="line">                    <span class="keyword">long</span> nowNsec = System.nanoTime();</span><br><span class="line">                    Log.d(TAG, <span class="string">"startup lag "</span> + ((nowNsec-firstInputTimeNsec) / <span class="number">1000000.0</span>) + <span class="string">" ms"</span>);</span><br><span class="line">                    firstInputTimeNsec = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">boolean</span> doLoop = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"surface decoder given buffer "</span> + decoderStatus +</span><br><span class="line">                        <span class="string">" (size="</span> + mBufferInfo.size + <span class="string">")"</span>);</span><br><span class="line">                <span class="keyword">if</span> ((mBufferInfo.flags &amp; MediaCodec.BUFFER_FLAG_END_OF_STREAM) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"output EOS"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (mLoop) &#123;</span><br><span class="line">                        doLoop = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        outputDone = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">boolean</span> doRender = (mBufferInfo.size != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// As soon as we call releaseOutputBuffer, the buffer will be forwarded</span></span><br><span class="line">                <span class="comment">// to SurfaceTexture to convert to a texture.  We can't control when it</span></span><br><span class="line">                <span class="comment">// appears on-screen, but we can manage the pace at which we release</span></span><br><span class="line">                <span class="comment">// the buffers.</span></span><br><span class="line">                <span class="keyword">if</span> (doRender &amp;&amp; frameCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    frameCallback.preRender(mBufferInfo.presentationTimeUs);</span><br><span class="line">                &#125;</span><br><span class="line">                decoder.releaseOutputBuffer(decoderStatus, doRender);</span><br><span class="line">                <span class="keyword">if</span> (doRender &amp;&amp; frameCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    frameCallback.postRender();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (doLoop) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">"Reached EOS, looping"</span>);</span><br><span class="line">                    extractor.seekTo(<span class="number">0</span>, MediaExtractor.SEEK_TO_CLOSEST_SYNC);</span><br><span class="line">                    inputDone = <span class="keyword">false</span>;</span><br><span class="line">                    decoder.flush();    <span class="comment">// reset decoder state</span></span><br><span class="line">                    frameCallback.loopReset();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이 메서드는 video가 멈추거나 끝날때 까지 루프를 돌게 된다. </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ByteBuffer[] decoderInputBuffers = decoder.getInputBuffers();</span><br></pre></td></tr></table></figure>
<p>getInputBuffers (input surface를 사용하는 경우 절대로 사용하면 안됨)</p>
<p>해당 메서드는 21이후로 더이상 사용되지 않는다. <code>getInputBuffer(int)</code>를 대신 사용한다.</p>
<p>본 메서드를 이용해서 byte stream을 읽어 오는데 일단 한번 읽어진 buffer는 재사용 되지 않는다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> inputBufIndex = decoder.dequeueInputBuffer(TIMEOUT_USEC);</span><br></pre></td></tr></table></figure>
<p>사용 가능한 데이터의 index(위치)를 알려준다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ByteBuffer inputBuf = decoderInputBuffers[inputBufIndex];</span><br></pre></td></tr></table></figure>
<p>앞서 읽어온 inputbuffer에서 사용 가능한 데이터의 index의 bytebuffer를 얻어온다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, chunkSize,</span><br><span class="line">        presentationTimeUs, <span class="number">0</span> <span class="comment">/*flags*/</span>);</span><br><span class="line">inputDone = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure>
<p>화면에 표시하기(decode) 위한 buffer를 지정한다.</p>
<p>여기서 presentationTimeUs는 이후 화면에 표시할때 나오는 timestamp와 동일 값이 된다.</p>
<p>해당 메서드를 Call 한 이후부터는 output이 가능한 단계 까지 while 문을 돌면서 기다리게 된다.</p>
<p><code>inputDone = true;</code>은 decode를 위한 버퍼를 채웠다는 flag처리이다.</p>
<p>이후 <code>outputDone</code>이 처리 되어야 한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!outputDone) &#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>바이트를 입력 했으니 이후는 입력된 바이트가 정상적으로 decode되어서 읽을 수 있으면 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> decoderStatus = decoder.dequeueOutputBuffer(mBufferInfo, TIMEOUT_USEC);</span><br></pre></td></tr></table></figure>
<p>이 부분을 확인하는 코드이다.</p>
<p>dequeueOutputBuffer</p>
<p>decoded가 완료 되었는지 여부를 확인 하는 코드로써, 다음 3가지 중 하나의 리턴을 갖게 된다.</p>
<p><code>NFO_TRY_AGAIN_LATER</code>, <code>INFO_OUTPUT_FORMAT_CHANGED</code>, <code>INFO_OUTPUT_BUFFERS_CHANGED</code></p>
<p>해당 value는 모두 음수의 값을 갖고 있다.</p>
<p>이외 양수의 값이 있다면 decode가 완료 되었다고 생각해도 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) &#123;</span><br><span class="line">    <span class="comment">// no output available yet</span></span><br><span class="line">    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"no output from decoder available"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) &#123;</span><br><span class="line">    <span class="comment">// not important for us, since we're using Surface</span></span><br><span class="line">    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output buffers changed"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">    MediaFormat newFormat = decoder.getOutputFormat();</span><br><span class="line">    <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">"decoder output format changed: "</span> + newFormat);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">"unexpected result from decoder.dequeueOutputBuffer: "</span> +</span><br><span class="line">                    decoderStatus);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// decoderStatus &gt;= 0</span></span><br></pre></td></tr></table></figure>
<p>decodeStatus가 양수일때 처리 하는 가능 핵심 적인 코드는 다음이다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">decoder.releaseOutputBuffer(decoderStatus, doRender);</span><br></pre></td></tr></table></figure>
<p>releaseOutputBuffer</p>
<p>output surface에 그려질 decode된 byte buffer를 돌려주는 행위를 하는 코드이다. <code>dequeueOutputBuffer</code></p>
<p>에서 지정해준 index를 기준으로 화면에 rendering을 처리하게 된다. doRender가 true이면 output surface에 최우선 적으로 데이터를 send하게 된다. 일단 해당 버퍼가 사용되고 나면 surface는 codec에게 더이상 재활용 하지 말것을 요청하게 된다.  해당 처리에 대한 결과로는 <code>MediaCodec.Callback</code>에 속해 있는 <code>onOutputBufferAvailable</code>가 trigger 된다.</p>
<p>해당 decode가 완료된 이후 surfacetexture view 쪽으로 화면의 redraw를 다음 리스너를 통해 알려준다.</p>
<p><code>TextureView.SurfaceTextureListener</code></p>
<p><strong>onSurfaceTextureUpdated</strong></p>
<p>SurfaceTexture에 있는 updateTexImage가 Call되면 이 method가 call되게 되는데, MediaCodec이 surface에 변화를 줄때마다 해당 시점을 얻어 오고 싶다면, 본 리스너를 등록 하면 된다. </p>
<p><strong>PlayMovieActivity.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureUpdated</span><span class="params">(SurfaceTexture surface)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Matrix txform = <span class="keyword">new</span> Matrix();</span><br><span class="line">    mTextureView.getTransform(txform);</span><br><span class="line">    mRotateValue %= <span class="number">360</span>;</span><br><span class="line">    txform.postRotate(mRotateValue += <span class="number">1</span>);</span><br><span class="line">    mTextureView.setTransform(txform);</span><br><span class="line">    Log.d(TAG, <span class="string">"onSurfaceTextureUpdated = "</span> + mRotateValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>grafika 에서는 <code>adjustAspectRatio</code>라는 메서드를 통해서 동영상의 비율을 조정하게 되는데, 해당 코드의 일부분을 상위와 같이 <code>onSurfaceTextureUpdated</code>에 넣게 되면 동영상이 돌아가는 모습을 확인 할 수있게 된다.</p>
<p>Surface에 대한 수정을 처리 하고 싶을 때는 <code>onSurfaceTextureAvailable</code>이나 <code>onSurfaceTextureUpdated</code>시점에 처리 해주면 된다.</p>
<p>만약 송출되는 Surface의 화면을 mirror(flip) 처리 하고자 한다면 PlayMovieActivity 내 <code>adjustAspectRatio</code>메서드 마지막에 <code>mTextureView.setScaleX(-1);</code> 처리를 하면 된다. </p>
<blockquote>
<p>Matrix의 setScale(-1,1)을 통한 flip은 성공하지 못했다.</p>
</blockquote>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag"># android</a>
          
            <a href="/tags/Grafika/" rel="tag"># Grafika</a>
          
            <a href="/tags/texture-surface/" rel="tag"># texture surface</a>
          
            <a href="/tags/video/" rel="tag"># video</a>
          
            <a href="/tags/flip/" rel="tag"># flip</a>
          
            <a href="/tags/mirror/" rel="tag"># mirror</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/android-graphic-architecture/" rel="next" title="android graphic architecture">
                <i class="fa fa-chevron-left"></i> android graphic architecture
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Android-Webview-Keyboard-Process-With-IME/" rel="prev" title="android keyboard show on the web">
                android keyboard show on the web <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/apple-touch-icon-next.png" alt="whoami">
            
              <p class="site-author-name" itemprop="name">whoami</p>
              <div class="site-description motion-element" itemprop="description">my note</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">45</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZXlvdW5nL3RoZXlvdW5nLmdpdGh1Yi5pbw==" title="GitHub &rarr; https://github.com/theyoung/theyoung.github.io"><i class="fa fa-fw fa-github"></i></span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="bWFpbHRvOnN1cHBvcnRAdGhleW91bmcyMDAyQG5hdmVyLmNvbQ==" title="E-Mail &rarr; mailto:support@theyoung2002@naver.com"><i class="fa fa-fw fa-envelope"></i></span>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
             </div>
          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#테스트-mp4파일-받기"><span class="nav-number">1.</span> <span class="nav-text">테스트 mp4파일 받기</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MediaFormat"><span class="nav-number">2.</span> <span class="nav-text">MediaFormat</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Audio-Video-공통-포멧-정보"><span class="nav-number">2.1.</span> <span class="nav-text">Audio / Video 공통 포멧 정보</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Video-포멧-정보"><span class="nav-number">2.2.</span> <span class="nav-text">Video 포멧 정보</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#오디오-포멧정보"><span class="nav-number">2.3.</span> <span class="nav-text">오디오 포멧정보</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#자막정보"><span class="nav-number">2.4.</span> <span class="nav-text">자막정보</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#이미지-정보"><span class="nav-number">2.5.</span> <span class="nav-text">이미지 정보</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MediaCodec"><span class="nav-number">3.</span> <span class="nav-text">MediaCodec</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#start"><span class="nav-number">3.1.</span> <span class="nav-text">start</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Buffer얻어-오기"><span class="nav-number">3.2.</span> <span class="nav-text">Buffer얻어 오기</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Syncronized"><span class="nav-number">3.2.1.</span> <span class="nav-text">Syncronized</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#API21-롤리팝-이후-deprecated-된-방법-grafika"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">API21(롤리팝) 이후 deprecated 된 방법 (grafika)</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NexT</span>

  

  
</div>


  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span> v7.0.1</div>



  <div class="footer-custom">Theme source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0">here</span><br>Website source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=">here</span></div>


        








        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>







  




















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  
  <script src="/js/src/exturl.js?v=7.0.1"></script>


  

  
  
  <script id="dsq-count-scr" src="https://https-theyoung-github-io.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://theyoung.github.io/grafika/";
    this.page.identifier = "grafika/";
    this.page.title = 'Android Grafika Texture Surface';
    this.language = 'en';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://https-theyoung-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
