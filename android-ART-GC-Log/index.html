<!DOCTYPE html>













<html class="theme-next gemini" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">














  <meta name="yandex-verification" content="3ac9ae36ddebb425">













<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"onmobile":true},
    back2top: true,
    back2top_sidebar: true,
    fancybox: false,
    fastclick: false,
    lazyload: true,
    tabs: true,
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Android Memory ARTART의 목적안드로이드 상 시스템이나 어플리케이션에 의해 관리 되는 Android Runtime을 대표 하는 말로써, 오직 안드로이드 프로젝트를 위해서만 만들어졌다. ART나 달빅의 경우는 Dex bytecode 러닝에 적합하게 만들어 졌다. Ahead-of-tiem (AOT) compilation인스톨 및 작동 시간을 빠르">
<meta name="keywords" content="Android,Memory,ART">
<meta property="og:type" content="article">
<meta property="og:title" content="android_ART_GC_Log">
<meta property="og:url" content="https://theyoung.github.io/android-ART-GC-Log/index.html">
<meta property="og:site_name" content="Try Again">
<meta property="og:description" content="Android Memory ARTART의 목적안드로이드 상 시스템이나 어플리케이션에 의해 관리 되는 Android Runtime을 대표 하는 말로써, 오직 안드로이드 프로젝트를 위해서만 만들어졌다. ART나 달빅의 경우는 Dex bytecode 러닝에 적합하게 만들어 졌다. Ahead-of-tiem (AOT) compilation인스톨 및 작동 시간을 빠르">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-04-02T00:55:25.033Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android_ART_GC_Log">
<meta name="twitter:description" content="Android Memory ARTART의 목적안드로이드 상 시스템이나 어플리케이션에 의해 관리 되는 Android Runtime을 대표 하는 말로써, 오직 안드로이드 프로젝트를 위해서만 만들어졌다. ART나 달빅의 경우는 Dex bytecode 러닝에 적합하게 만들어 졌다. Ahead-of-tiem (AOT) compilation인스톨 및 작동 시간을 빠르">






  <link rel="canonical" href="https://theyoung.github.io/android-ART-GC-Log/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>android_ART_GC_Log | Try Again</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  

  <div class="container page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Try Again</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">anything</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-news">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-bullhorn"></i> <br>News</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">19</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://theyoung.github.io/android-ART-GC-Log/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="whoami">
      <meta itemprop="description" content="my note">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Try Again">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">android_ART_GC_Log

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-29 14:37:40" itemprop="dateCreated datePublished" datetime="2019-03-29T14:37:40Z">2019-03-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-02 00:55:25" itemprop="dateModified" datetime="2019-04-02T00:55:25Z">2019-04-02</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/android-ART-GC-Log/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="android-ART-GC-Log/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="Android-Memory-ART"><a href="#Android-Memory-ART" class="headerlink" title="Android Memory ART"></a>Android Memory ART</h4><h5 id="ART의-목적"><a href="#ART의-목적" class="headerlink" title="ART의 목적"></a>ART의 목적</h5><p>안드로이드 상 시스템이나 어플리케이션에 의해 관리 되는 Android Runtime을 대표 하는 말로써, 오직 안드로이드 프로젝트를 위해서만 만들어졌다. ART나 달빅의 경우는 Dex bytecode 러닝에 적합하게 만들어 졌다.</p>
<h6 id="Ahead-of-tiem-AOT-compilation"><a href="#Ahead-of-tiem-AOT-compilation" class="headerlink" title="Ahead-of-tiem (AOT) compilation"></a>Ahead-of-tiem (AOT) compilation</h6><p>인스톨 및 작동 시간을 빠르게 하기 위해 있는 것으로 최초 apk를 install하게 되면 dex2oat라는 device 내부에 있는 tool을 이용해서 작동가능한 상태로 만들어 준다. </p>
<h6 id="Improved-garbage-collection"><a href="#Improved-garbage-collection" class="headerlink" title="Improved garbage collection"></a>Improved garbage collection</h6><ul>
<li>GC를 한번에 처리하게 만든다</li>
<li>GC pause동안 병행 프로세스 처리를 한다</li>
<li>작은 객체(만들어진지 얼마 안된 객체, short live 객체)들을 수집한다</li>
<li>GC 처리를 적절하게 병행 처리 함으로써 <code>GC_FOR_ALLOC</code>이 최대한 발생 하지 않게 한다</li>
<li>백그라운드 메모리 사용이나, 메모리 파편화를 줄여 준다 (Compacting GC) </li>
</ul>
<h6 id="Development-and-debugging-improvements"><a href="#Development-and-debugging-improvements" class="headerlink" title="Development and debugging improvements"></a>Development and debugging improvements</h6><p>아래와 같은 오류 정보들을 ART가 제공하게 된다.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.lang.NullPointerException: Attempt to write to field &apos;int</span><br><span class="line">android.accessibilityservice.AccessibilityServiceInfo.flags&apos; on a null object</span><br><span class="line">reference</span><br></pre></td></tr></table></figure>
<h5 id="ART-로그-설명"><a href="#ART-로그-설명" class="headerlink" title="ART 로그 설명"></a>ART 로그 설명</h5><p>Art(Android Runtime)는 명시적으로 요청된 Garbage Collection에 대해서만 결과를 출력함</p>
<p>출력 형태는 다음과 같음</p>
<p> <code>I/art: &lt;GC_Reason&gt; &lt;GC_Name&gt; &lt;Objects_freed&gt;(&lt;Size_freed&gt;) AllocSpace Objects, &lt;Large_objects_freed&gt;(&lt;Large_object_size_freed&gt;) &lt;Heap_stats&gt; LOS objects, &lt;Pause_time(s)&gt;</code></p>
<p>실제 사용은 다음과 같이 출력됨</p>
<p><code>I art     : Explicit concurrent mark sweep GC freed 64(14KB) AllocSpace objects, 2(72KB) LOS objects, 24% free, 4MB/5MB, paused 448us total 20.082ms:</code></p>
<p>조금더 자세하게 나누어 보면 다음과 같음</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Type</th>
<th>대상</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>GC_Reason</td>
<td>Explicit</td>
<td>- Concurrent : 앱스레드 중단 않는 GC (백그라운드 실행)<br>- Alloc : 힙이 이미 가득 차서 더 이상 요청받은 메모리 할당을 할 수없어서, GC를 우선 실행 시킴<br>-Explicit : 앱이 명시적인 GC를 요청함. gc() 호출<br>- NativeAlloc : Bitmap또는 Renderscript 할당과 같은 <strong><u>Native 메모리</u></strong> 할당을 위해서 실행 되는 GC (허니비를 기점으로 Bitmap은 힙으로 위치를 변경하였다)<br>- CollectorTransition : RAM 사양이 낮은 기기에서 앱의 프로세스 상태 일시 중지 및 인식 할 수없는 상태로 변경 할때 변환이 발생함(메모리 공간을 범프 포인터 공간으로 복사하는 작업임)(Eden 영역에서 -&gt; Survivor 영역으로의 전환 과정으로 보임)<br>- HomogeneousSpaceCompact : 사용가능한 공간(메모리로 보임)의 압축 기법으로 백그라운드 상태에서 RAM사용량 감소와 힙 조각 모음을 위해 처리 하는 것으로 보임<br>- HeapTrim : 힙트림을 마주칠 때까지 수집이 차단 <br>- DisableMovingGc : 힙압축이 이루어지는 동안 GetPrimitiveArrayCritical이 사용 됨으로써 힙의 수집기 이동을 제한 시킴</td>
</tr>
<tr>
<td>GC_Name</td>
<td>concurrent mark sweep</td>
<td>- Concurrent mark sweep (CMS) : 이미지 공간 이외의 모든 공간을 회수하고 수집하는 완전한 힙 수집기<br>- Concurrent partial mark sweep : 이미지 및 zygote (app_process, 요청을 리스닝하고 요청 받은 클래스를 포크한다.)공간 이외의 공간을 전부 수집하는 수집기<br>- Concurrent sticky mark sweep : 마지막 GC이후로 할당된 객체만 회수 하는 세대별 수집기. 수집이 빠르고 일시 중지도 잘 안일어 남으로 자주 사용됨<br>-Marksweep + semispace : 공간 압축이나 힙전환시 사용되는 복사 GC</td>
</tr>
<tr>
<td>Objects_freed</td>
<td>freed 64</td>
<td>회수한 객체의 수(작은규모)</td>
</tr>
<tr>
<td>Size_freed</td>
<td>(14KB) AllocSpace objects, 2</td>
<td>GC를 통해서 회수한 바이트의 수</td>
</tr>
<tr>
<td>Large_objects_freed</td>
<td>2</td>
<td>회수한 객체의 수(큰 규모)</td>
</tr>
<tr>
<td>Large_object_size_freed</td>
<td>(72KB)</td>
<td>회수한 객체의 크기</td>
</tr>
<tr>
<td>Heap_stats</td>
<td>24% free, 4MB/5MB,</td>
<td>회수한 비율로 (라이브 객체수)/(총 힙 크기), 예를 들자면 4MB가 살아있는 개체이고 5MB가 전체 힙의 크기이다. 약 24% 1MB 정도가 비어 있는 상황이라고 보면 된다. 이 값으 전체 적으로 증가만 하고 있다면 메모리 릭이라고 생각해 봐야한다</td>
</tr>
<tr>
<td>Pause Times</td>
<td>paused 448us total 20.082ms</td>
<td>공식 문서상에는 일시 중지 횟수로 나와있으나 단위를 보면 일시 중지 시간이 맞는거 같다. 객체 수집시 나타나는 일시 중지 시간 평균 및 sum이 이 pause times으로 생각된다.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Android-Memory-Kill-순서"><a href="#Android-Memory-Kill-순서" class="headerlink" title="Android Memory Kill 순서"></a>Android Memory Kill 순서</h4><div class="table-container">
<table>
<thead>
<tr>
<th>시스템</th>
<th>관련 서비스</th>
<th>memory status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cached</td>
<td>현재 작동 되고 있지 않고 Background에 캐쉬 되어 있는 서비스들</td>
<td>lmk(Low memory killer) threshold</td>
</tr>
<tr>
<td>Previous</td>
<td>현재 작동 중인 서비스 직전에 사용된 서비스</td>
<td>critical</td>
</tr>
<tr>
<td>Home</td>
<td>Home 기능이라고 하는데 내용상 바탕화면의 Wall paper 정도로 보임</td>
<td>critical</td>
</tr>
<tr>
<td>Service</td>
<td>클라우드 서비스, 싱크 서비스 등 백그라운드 서비스</td>
<td>critical</td>
</tr>
<tr>
<td>Perceptible</td>
<td>조회기능, 오디오, 키보드 등 듣고 입력하는 기능 들로 보임</td>
<td>critical</td>
</tr>
<tr>
<td>Foreground</td>
<td>현재 떠있는 서비스</td>
<td>critical</td>
</tr>
<tr>
<td>Persistent</td>
<td>전화 본연의 기능 및 통신 프로톨(와이파이, 블루투스 등)</td>
<td>Crash ()</td>
</tr>
<tr>
<td>System</td>
<td>system_server</td>
<td>Crash (reboot)</td>
</tr>
<tr>
<td>Native</td>
<td>init, kswapd,netd, logd, adbd 등 native bin(exec) 프로세스</td>
<td>Crash (reboot)</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>맨 위에서 부터 순차적으로 프로세스가 kill되기 시작함</p>
<p>lmk : low memory killer</p>
<p>kswapd : kernel swap daemon</p>
</blockquote>
<h4 id="Android-Memory-Debug-Tool"><a href="#Android-Memory-Debug-Tool" class="headerlink" title="Android Memory Debug Tool"></a>Android Memory Debug Tool</h4><ul>
<li>Android Studio Profiler</li>
<li>showmap (사용방법?): <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL2FuZHJvaWQtNi4wLjFfcjI4L3Nob3dtYXAvc2hvd21hcC5j" title="https://android.googlesource.com/platform/system/extras/+/android-6.0.1_r28/showmap/showmap.c">https://android.googlesource.com/platform/system/extras/+/android-6.0.1_r28/showmap/showmap.c<i class="fa fa-external-link"></i></span> </li>
<li>ahat : <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vYXJ0LysvbWFzdGVyL3Rvb2xzL2FoYXQvUkVBRE1FLnR4dA==" title="https://android.googlesource.com/platform/art/+/master/tools/ahat/README.txt">https://android.googlesource.com/platform/art/+/master/tools/ahat/README.txt<i class="fa fa-external-link"></i></span></li>
<li>debug malloc : adb logcat -d | grep &quot;malloc debug&quot;  <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vYmlvbmljLysvbWFzdGVyL2xpYmMvbWFsbG9jX2RlYnVnL1JFQURNRS5tZA==" title="https://android.googlesource.com/platform/bionic/+/master/libc/malloc_debug/README.md">https://android.googlesource.com/platform/bionic/+/master/libc/malloc_debug/README.md<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>Profiler 만 사용하면 다른 툴을 쓸 필요가 없는 것으로 보인다. 단, malloc 같은 경우는 native 영역에 대한 내용을 볼 수 있는 유일한 방법으로 현재까지는 보임으로 native leak이 발생하면 쓸수 밖에 없지 않나 한다.</p>
</blockquote>
<h4 id="Android-RAM의-종류"><a href="#Android-RAM의-종류" class="headerlink" title="Android RAM의 종류"></a>Android RAM의 종류</h4><h5 id="RAM-사용량-Command"><a href="#RAM-사용량-Command" class="headerlink" title="RAM 사용량 Command"></a>RAM 사용량 Command</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb shell dumpsys meminfo &lt;package_name|pid&gt; [-d]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>해당 명령어는 adb connect 가 되어있다는 전제이다</p>
</blockquote>
<ul>
<li>-d 옵션 의미 : Dalvick 및 ART 메모리 사용량에 대한 정보가 상세히 출력된다</li>
<li>기본적을 KB단위로 나열된다.  </li>
</ul>
<h5 id="개인-클림-및-더티-RAM"><a href="#개인-클림-및-더티-RAM" class="headerlink" title="개인(클림 및 더티) RAM"></a>개인(클림 및 더티) RAM</h5><p>RAM은 특정 APP에서만 사용중인 메모리로써, 해당 메모리의 양은 특정 APP의 서비스가 프로세스 킬되었을 때 온전히 Free RAM으로 되돌려 받을 수 있는 양이다. 이중에 개인 더티 RAM은 Android 스왑을 사용하지 않기 때문에 가장 중요한 대상이 된다. 메모리 Leak을 해결 해야 하는 이유도 이부분에 있다. 개발자가 지정하는 모든 Dalvik 및 Native 힙 메모리는 더티 RAM으로 처리된다. Zygote를 사용하는 공유 RAM도 있게 되는데 이부분은 공유 더티 Ram으로 불린다.</p>
<h5 id="PSS-Propotional-Set-Size"><a href="#PSS-Propotional-Set-Size" class="headerlink" title="PSS(Propotional Set Size)"></a>PSS(Propotional Set Size)</h5><p>PSS는 하나의 프로세스만을 바라보는 사이징 방식이 아니라, 공유되는 모든 페이지에 대한 RAM까지 포함한 계산 방식이다. 예를 들자면 프로세스 2개가 2메가를 공유하는 프로세스를 접근 하고 있다면, 1MB씩 PSS 사이즈를 분배 받게 된다. 그외 개인 더티 RAM 사이즈는 직접적으로 PSS에 추가 된다.</p>
<p>정리하자면 다음과 같다.</p>
<ul>
<li>PSS Size = 프로세스1 개인 더티 RAM + 프로세스 2 개인 더티 RAM + 프로세스 3 공유 RAM 절반 </li>
</ul>
<blockquote>
<p>PSS외에 2가지 종류가 더 있다</p>
<p>RSS : Resident Set Size = Private 더티 RAM + Shared RAM 전체</p>
<p>USS : Unique Set Size = RSS - shared RAM 전체  = Private Dirty RAM만 대상으로 함</p>
</blockquote>
<p>아래는 com.example.app의 메모리 사용량을 나타낸다.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Applications Memory Usage (kB):</span><br><span class="line">Uptime: 2452592 Realtime: 2452592</span><br><span class="line"></span><br><span class="line">** MEMINFO in pid 4739 [com.example.app] **</span><br><span class="line">                   Pss  Private  Private  Swapped     Heap     Heap     Heap</span><br><span class="line">                 Total    Dirty    Clean    Dirty     Size    Alloc     Free</span><br><span class="line">                ------   ------   ------   ------   ------   ------   ------</span><br><span class="line">  Native Heap     6691     6648        0        0    16384     8945     7438</span><br><span class="line">  Dalvik Heap     1664     1512        0        0     7045     5418     1627</span><br><span class="line"> Dalvik Other      304      304        0        0</span><br><span class="line">        Stack      392      392        0        0</span><br><span class="line">       Ashmem      128      128        0        0</span><br><span class="line">    Other dev        4        0        4        0</span><br><span class="line">     .so mmap     8218      260     1640        0</span><br><span class="line">    .apk mmap      305        0       24        0</span><br><span class="line">    .ttf mmap       93        0        0        0</span><br><span class="line">    .dex mmap     2124        0     1776        0</span><br><span class="line">    .oat mmap     2144        0       64        0</span><br><span class="line">    .art mmap     2214     1988        4        0</span><br><span class="line">   Other mmap      296        4        0        0</span><br><span class="line">      Unknown     2072     2072        0        0</span><br><span class="line">        TOTAL    26649    13308     3512        0    23429    14363     9065</span><br><span class="line"></span><br><span class="line"> Dalvik Details</span><br><span class="line">        .Heap      964      964        0        0</span><br><span class="line">          .GC      188      188        0        0</span><br><span class="line">      .Zygote      424      272        0        0</span><br><span class="line">   .NonMoving      276      276        0        0</span><br><span class="line"> .IndirectRef      116      116        0        0</span><br><span class="line"></span><br><span class="line"> Objects</span><br><span class="line">               Views:        9         ViewRootImpl:        0</span><br><span class="line">         AppContexts:        3           Activities:        1</span><br><span class="line">              Assets:        3        AssetManagers:        3</span><br><span class="line">       Local Binders:       13        Proxy Binders:       15</span><br><span class="line">       Parcel memory:        5         Parcel count:       20</span><br><span class="line">    Death Recipients:        0      OpenSSL Sockets:        0</span><br><span class="line"></span><br><span class="line"> SQL</span><br><span class="line">         MEMORY_USED:        0</span><br><span class="line">  PAGECACHE_OVERFLOW:        0          MALLOC_SIZE:        0</span><br></pre></td></tr></table></figure>
<h6 id="Dalvik-Heap"><a href="#Dalvik-Heap" class="headerlink" title="Dalvik Heap"></a>Dalvik Heap</h6><p>자바 머신인 달빅의 heap 모델은 External과 Dalvik heap으로 나뉘게 되는데 이중에 Dalvik Heap은</p>
<ul>
<li>Java객체 인스턴스 메모리 할당</li>
<li>Zygote 할당 영역 포함</li>
</ul>
<p>을 하게 된다.</p>
<p>그러나 java의 메모리 범위 밖을 보게 된다면 Native Heap이 나타나게 되는데, 이부분은 OS 영역의 메모리를 사용하는 범위로 주로 NDK로 개발된 경우 C++, C로 개발된 로우레벨 라이브러리를 사용하는 경우가 된다.</p>
<ul>
<li>Bitmap의 경우 가장 대표적인 Native Heap 저장 대상이다.</li>
</ul>
<p>Java는 Bitmap data를 Native Heap 부분으로 Pointing하는 역할만 한다.</p>
<h6 id="Dalvik-Other"><a href="#Dalvik-Other" class="headerlink" title="Dalvik Other"></a>Dalvik Other</h6><p>문서상으로는 정확히 명시 되어 있지는 않는데 참고 문항으로 추리 해보면 다음과 같이 생각하면 될것 같다</p>
<ul>
<li>Just in time 컴파일 기록</li>
<li>GC 기록</li>
</ul>
<p>등 Dalvik Overhead</p>
<blockquote>
<p>추측이긴 한데 ART에서 생성되는 각종 정보가 이쪽 메모리 사이즈로 쌓이는 것으로 생각된다.</p>
</blockquote>
<h6 id="Heap-Alloc"><a href="#Heap-Alloc" class="headerlink" title="Heap Alloc"></a>Heap Alloc</h6><p>해당 앱에 할당된 메모리 크기 인다. 이게 PSS Total보다 큰 이유는 공유 자원에 대한 값까지 같이 포함 하고 있기 때문이라고 한다.</p>
<h6 id="Private-Dirty"><a href="#Private-Dirty" class="headerlink" title="Private Dirty"></a>Private Dirty</h6><p>해당 앱 프로세스 내부에서만 사용되는 메모리로 타 앱 및 프로세스와 공유 되지 않는다. 프로세스가 종료 되면 이 메모리는 100% 반환 되어야 한다.</p>
<h6 id="Private-Cean"><a href="#Private-Cean" class="headerlink" title="Private Cean"></a>Private Cean</h6><p>개발자 앱의 자체 코드임, 개발자가 만든 code자체에 대한 글이 이곳에 적제 되는 것으로 보임</p>
<p>so,dex mmap과 관련이 있음</p>
<p>.so에는 private 더티 RAM이 크게 할당 되어있는데 이는 네이티브 코드를 최종 주소 로드 할때 수정했기 때문이다.</p>
<blockquote>
<p>실행 중인 코드에 대한 정보를 담는 부분으로 보임</p>
</blockquote>
<h6 id="so-dex-mmap"><a href="#so-dex-mmap" class="headerlink" title=".so .dex mmap"></a>.so .dex mmap</h6><p>.so 네이티브 및 .dex 달빅 또는 ART를 위한 코드용으로 사용하는 RAM</p>
<h6 id="oat-mmap"><a href="#oat-mmap" class="headerlink" title=".oat mmap"></a>.oat mmap</h6><p>여러 앱이 공통적으로 사용하는 앱의 메모리 공간으로 특정 앱에 영향을 받지 않음</p>
<h6 id="Unknow"><a href="#Unknow" class="headerlink" title=".Unknow"></a>.Unknow</h6><p>도구가 식별하기 힘든 RAM 페이지로, 주로 네이티브 할당이 주를 이룬다. </p>
<h6 id="Dalvik-Detail"><a href="#Dalvik-Detail" class="headerlink" title="Dalvik Detail"></a>Dalvik Detail</h6><p>.Heap : 앱의 힙의 메모리 크기 (zygote 공간 과 private 공간 포함)</p>
<p>.LOS : ART 대형 객체 공간 메모리</p>
<p>.GC : GC 계정 오버헤드 크기로 수정할 수없음</p>
<p>.JITCache : 실행되는 시점으로 o이 될것임</p>
<p>.Zygote : 공통 메모리 크기</p>
<p>.NonMoving : ART 비이동 공간 사용 RAM, 앱에서 사용하는 필드와 메서드 수를 줄이면 이부분이 줄어듬</p>
<p>.IndirectRef : ART 간접 참조 테이블, 로컬 및 전역 JNI 참조 수를 줄이면 줄일 수 있음</p>
<h6 id="Objects"><a href="#Objects" class="headerlink" title="Objects"></a>Objects</h6><p>Views : 모든 View 객체의 수이다. 만약에 layout에 버튼 3개가 있고 views가 9인 상태라면, 하나의 버튼을 삭제 하면 8이 된다.</p>
<p>ViewRootImpl : 현재 작동중인 View의 갯수. 보이지 않는 창이라던가 연관되어있는 view와의 갯수를 확인해서 메모리 누수를 확인 할 수있다.</p>
<blockquote>
<p>화면이 안떠있다면 0, 한개 View가 떠있다면 1이런식이다.</p>
</blockquote>
<p>Activities</p>
<p>Activity의 갯수로써 현재 떠있는 Activity의 갯수가 된다. 한개의 큰 화면만 떠있다면 Activity는 1개이다</p>
<p>AppContexts</p>
<blockquote>
<p>만약에 Activity A가 죽고 Activity B가 살아나는 시점에, A의 context가 살아있다면(Leak) 이때 AppContexts는 지속적으로 증가하는 것으로 보임</p>
</blockquote>
<p>ProxyBinders/Parcel count/Local Binders</p>
<blockquote>
<p>lyaout 상 객체를 Bind 하면서 카운트가 올라 가는 것으로 보임</p>
</blockquote>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/Memory/" rel="tag"># Memory</a>
          
            <a href="/tags/ART/" rel="tag"># ART</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/javascript-object-merge/" rel="next" title="javascript object merge">
                <i class="fa fa-chevron-left"></i> javascript object merge
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/android-memory-leak/" rel="prev" title="android memory leak 처리">
                android memory leak 처리 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/apple-touch-icon-next.png" alt="whoami">
            
              <p class="site-author-name" itemprop="name">whoami</p>
              <div class="site-description motion-element" itemprop="description">my note</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZXlvdW5nL3RoZXlvdW5nLmdpdGh1Yi5pbw==" title="GitHub &rarr; https://github.com/theyoung/theyoung.github.io"><i class="fa fa-fw fa-github"></i></span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="bWFpbHRvOnN1cHBvcnRAdGhleW91bmcyMDAyQG5hdmVyLmNvbQ==" title="E-Mail &rarr; mailto:support@theyoung2002@naver.com"><i class="fa fa-fw fa-envelope"></i></span>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
             </div>
          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Android-Memory-ART"><span class="nav-number">1.</span> <span class="nav-text">Android Memory ART</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ART의-목적"><span class="nav-number">1.1.</span> <span class="nav-text">ART의 목적</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Ahead-of-tiem-AOT-compilation"><span class="nav-number">1.1.1.</span> <span class="nav-text">Ahead-of-tiem (AOT) compilation</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Improved-garbage-collection"><span class="nav-number">1.1.2.</span> <span class="nav-text">Improved garbage collection</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Development-and-debugging-improvements"><span class="nav-number">1.1.3.</span> <span class="nav-text">Development and debugging improvements</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ART-로그-설명"><span class="nav-number">1.2.</span> <span class="nav-text">ART 로그 설명</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Android-Memory-Kill-순서"><span class="nav-number">2.</span> <span class="nav-text">Android Memory Kill 순서</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Android-Memory-Debug-Tool"><span class="nav-number">3.</span> <span class="nav-text">Android Memory Debug Tool</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Android-RAM의-종류"><span class="nav-number">4.</span> <span class="nav-text">Android RAM의 종류</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#RAM-사용량-Command"><span class="nav-number">4.1.</span> <span class="nav-text">RAM 사용량 Command</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#개인-클림-및-더티-RAM"><span class="nav-number">4.2.</span> <span class="nav-text">개인(클림 및 더티) RAM</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PSS-Propotional-Set-Size"><span class="nav-number">4.3.</span> <span class="nav-text">PSS(Propotional Set Size)</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Dalvik-Heap"><span class="nav-number">4.3.1.</span> <span class="nav-text">Dalvik Heap</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Dalvik-Other"><span class="nav-number">4.3.2.</span> <span class="nav-text">Dalvik Other</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Heap-Alloc"><span class="nav-number">4.3.3.</span> <span class="nav-text">Heap Alloc</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Private-Dirty"><span class="nav-number">4.3.4.</span> <span class="nav-text">Private Dirty</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Private-Cean"><span class="nav-number">4.3.5.</span> <span class="nav-text">Private Cean</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#so-dex-mmap"><span class="nav-number">4.3.6.</span> <span class="nav-text">.so .dex mmap</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#oat-mmap"><span class="nav-number">4.3.7.</span> <span class="nav-text">.oat mmap</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Unknow"><span class="nav-number">4.3.8.</span> <span class="nav-text">.Unknow</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Dalvik-Detail"><span class="nav-number">4.3.9.</span> <span class="nav-text">Dalvik Detail</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Objects"><span class="nav-number">4.3.10.</span> <span class="nav-text">Objects</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NexT</span>

  

  
</div>


  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span> v7.0.1</div>



  <div class="footer-custom">Theme source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0">here</span><br>Website source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=">here</span></div>


        








        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>







  




















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  
  <script src="/js/src/exturl.js?v=7.0.1"></script>


  

  
  
  <script id="dsq-count-scr" src="https://https-theyoung-github-io.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://theyoung.github.io/android-ART-GC-Log/";
    this.page.identifier = "android-ART-GC-Log/";
    this.page.title = 'android_ART_GC_Log';
    this.language = 'en';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://https-theyoung-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    $(function() {
      var offsetTop = $('#comments').offset().top - $(window).height();
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        loadComments();
      } else {
        $(window).on('scroll.disqus_scroll', function() {
          // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = $('#comments').offset().top - $(window).height();
          var scrollTop = $(window).scrollTop();

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            $(window).off('.disqus_scroll');
            loadComments();
          }
        });
      }
    });
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
